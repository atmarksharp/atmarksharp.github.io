<!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<i><font color="#9A1900">/*   Path: ~/lab/CoreAudioUtilityClasses/Mac/CoreAudioUtilityClasses/CoreAudio/PublicUtility/CASpectralProcessor.cpp  */</font></i>

<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900">     File: CASpectralProcessor.cpp </font></i>
<i><font color="#9A1900"> Abstract:  CASpectralProcessor.h  </font></i>
<i><font color="#9A1900">  Version: 1.0.4 </font></i>
<i><font color="#9A1900">  </font></i>
<i><font color="#9A1900"> Disclaimer: IMPORTANT:  This Apple software is supplied to you by Apple </font></i>
<i><font color="#9A1900"> Inc. ("Apple") in consideration of your agreement to the following </font></i>
<i><font color="#9A1900"> terms, and your use, installation, modification or redistribution of </font></i>
<i><font color="#9A1900"> this Apple software constitutes acceptance of these terms.  If you do </font></i>
<i><font color="#9A1900"> not agree with these terms, please do not use, install, modify or </font></i>
<i><font color="#9A1900"> redistribute this Apple software. </font></i>
<i><font color="#9A1900">  </font></i>
<i><font color="#9A1900"> In consideration of your agreement to abide by the following terms, and </font></i>
<i><font color="#9A1900"> subject to these terms, Apple grants you a personal, non-exclusive </font></i>
<i><font color="#9A1900"> license, under Apple's copyrights in this original Apple software (the </font></i>
<i><font color="#9A1900"> "Apple Software"), to use, reproduce, modify and redistribute the Apple </font></i>
<i><font color="#9A1900"> Software, with or without modifications, in source and/or binary forms; </font></i>
<i><font color="#9A1900"> provided that if you redistribute the Apple Software in its entirety and </font></i>
<i><font color="#9A1900"> without modifications, you must retain this notice and the following </font></i>
<i><font color="#9A1900"> text and disclaimers in all such redistributions of the Apple Software. </font></i>
<i><font color="#9A1900"> Neither the name, trademarks, service marks or logos of Apple Inc. may </font></i>
<i><font color="#9A1900"> be used to endorse or promote products derived from the Apple Software </font></i>
<i><font color="#9A1900"> without specific prior written permission from Apple.  Except as </font></i>
<i><font color="#9A1900"> expressly stated in this notice, no other rights or licenses, express or </font></i>
<i><font color="#9A1900"> implied, are granted by Apple herein, including but not limited to any </font></i>
<i><font color="#9A1900"> patent rights that may be infringed by your derivative works or by other </font></i>
<i><font color="#9A1900"> works in which the Apple Software may be incorporated. </font></i>
<i><font color="#9A1900">  </font></i>
<i><font color="#9A1900"> The Apple Software is provided by Apple on an "AS IS" basis.  APPLE </font></i>
<i><font color="#9A1900"> MAKES NO WARRANTIES, EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION </font></i>
<i><font color="#9A1900"> THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY AND FITNESS </font></i>
<i><font color="#9A1900"> FOR A PARTICULAR PURPOSE, REGARDING THE APPLE SOFTWARE OR ITS USE AND </font></i>
<i><font color="#9A1900"> OPERATION ALONE OR IN COMBINATION WITH YOUR PRODUCTS. </font></i>
<i><font color="#9A1900">  </font></i>
<i><font color="#9A1900"> IN NO EVENT SHALL APPLE BE LIABLE FOR ANY SPECIAL, INDIRECT, INCIDENTAL </font></i>
<i><font color="#9A1900"> OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF </font></i>
<i><font color="#9A1900"> SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS </font></i>
<i><font color="#9A1900"> INTERRUPTION) ARISING IN ANY WAY OUT OF THE USE, REPRODUCTION, </font></i>
<i><font color="#9A1900"> MODIFICATION AND/OR DISTRIBUTION OF THE APPLE SOFTWARE, HOWEVER CAUSED </font></i>
<i><font color="#9A1900"> AND WHETHER UNDER THEORY OF CONTRACT, TORT (INCLUDING NEGLIGENCE), </font></i>
<i><font color="#9A1900"> STRICT LIABILITY OR OTHERWISE, EVEN IF APPLE HAS BEEN ADVISED OF THE </font></i>
<i><font color="#9A1900"> POSSIBILITY OF SUCH DAMAGE. </font></i>
<i><font color="#9A1900">  </font></i>
<i><font color="#9A1900"> Copyright (C) 2013 Apple Inc. All Rights Reserved. </font></i>
<i><font color="#9A1900">  </font></i>
<i><font color="#9A1900">*/</font></i>
 
<i><font color="#9A1900">//#include "AudioFormulas.h"</font></i>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"CASpectralProcessor.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"CABitOperations.h"</font>


<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;Accelerate/Accelerate.h&gt;</font>


<b><font color="#000080">#define</font></b> <b><font color="#000000">OFFSETOF</font></b><font color="#990000">(</font><b><font color="#0000FF">class</font></b><font color="#990000">,</font> field<font color="#990000">)((</font>size_t<font color="#990000">)&amp;((</font><b><font color="#0000FF">class</font></b><font color="#990000">*)</font><font color="#993399">0</font><font color="#990000">)-&gt;</font>field<font color="#990000">)</font>

CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">CASpectralProcessor</font></b><font color="#990000">(</font><font color="#008080">UInt32</font> inFFTSize<font color="#990000">,</font> <font color="#008080">UInt32</font> inHopSize<font color="#990000">,</font> <font color="#008080">UInt32</font> inNumChannels<font color="#990000">,</font> <font color="#008080">UInt32</font> inMaxFrames<font color="#990000">)</font>
	<font color="#990000">:</font> <b><font color="#000000">mFFTSize</font></b><font color="#990000">(</font>inFFTSize<font color="#990000">),</font> <b><font color="#000000">mHopSize</font></b><font color="#990000">(</font>inHopSize<font color="#990000">),</font> <b><font color="#000000">mNumChannels</font></b><font color="#990000">(</font>inNumChannels<font color="#990000">),</font> <b><font color="#000000">mMaxFrames</font></b><font color="#990000">(</font>inMaxFrames<font color="#990000">),</font>
	<b><font color="#000000">mLog2FFTSize</font></b><font color="#990000">(</font><b><font color="#000000">Log2Ceil</font></b><font color="#990000">(</font>mFFTSize<font color="#990000">)),</font> 
	<b><font color="#000000">mFFTMask</font></b><font color="#990000">(</font>mFFTSize <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">),</font>
	<b><font color="#000000">mFFTByteSize</font></b><font color="#990000">(</font>mFFTSize <font color="#990000">*</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>Float32<font color="#990000">)),</font>
	<b><font color="#000000">mIOBufSize</font></b><font color="#990000">(</font><b><font color="#000000">NextPowerOfTwo</font></b><font color="#990000">(</font>mFFTSize <font color="#990000">+</font> mMaxFrames<font color="#990000">)),</font>
	<b><font color="#000000">mIOMask</font></b><font color="#990000">(</font>mIOBufSize <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">),</font>
	<b><font color="#000000">mInputSize</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">),</font>
	<b><font color="#000000">mInputPos</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">),</font> <b><font color="#000000">mOutputPos</font></b><font color="#990000">(-</font>mFFTSize <font color="#990000">&amp;</font> mIOMask<font color="#990000">),</font> 
	<b><font color="#000000">mInFFTPos</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">),</font> <b><font color="#000000">mOutFFTPos</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">),</font>
	<b><font color="#000000">mSpectralFunction</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">),</font> <b><font color="#000000">mUserData</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
	mWindow<font color="#990000">.</font><b><font color="#000000">alloc</font></b><font color="#990000">(</font>mFFTSize<font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">);</font>
	<b><font color="#000000">SineWindow</font></b><font color="#990000">();</font> <i><font color="#9A1900">// set default window.</font></i>
	
	mChannels<font color="#990000">.</font><b><font color="#000000">alloc</font></b><font color="#990000">(</font>mNumChannels<font color="#990000">);</font>
	mSpectralBufferList<font color="#990000">.</font><b><font color="#000000">allocBytes</font></b><font color="#990000">(</font><b><font color="#000000">OFFSETOF</font></b><font color="#990000">(</font>SpectralBufferList<font color="#990000">,</font> mDSPSplitComplex<font color="#990000">[</font>mNumChannels<font color="#990000">]),</font> <b><font color="#0000FF">true</font></b><font color="#990000">);</font>
	mSpectralBufferList<font color="#990000">-&gt;</font>mNumberSpectra <font color="#990000">=</font> mNumChannels<font color="#990000">;</font>
	<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> mNumChannels<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font> 
	<font color="#FF0000">{</font>
		mChannels<font color="#990000">[</font>i<font color="#990000">].</font>mInputBuf<font color="#990000">.</font><b><font color="#000000">alloc</font></b><font color="#990000">(</font>mIOBufSize<font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">);</font>
		mChannels<font color="#990000">[</font>i<font color="#990000">].</font>mOutputBuf<font color="#990000">.</font><b><font color="#000000">alloc</font></b><font color="#990000">(</font>mIOBufSize<font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">);</font>
		mChannels<font color="#990000">[</font>i<font color="#990000">].</font>mFFTBuf<font color="#990000">.</font><b><font color="#000000">alloc</font></b><font color="#990000">(</font>mFFTSize<font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">);</font>
		mChannels<font color="#990000">[</font>i<font color="#990000">].</font>mSplitFFTBuf<font color="#990000">.</font><b><font color="#000000">alloc</font></b><font color="#990000">(</font>mFFTSize<font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">);</font>
		mSpectralBufferList<font color="#990000">-&gt;</font>mDSPSplitComplex<font color="#990000">[</font>i<font color="#990000">].</font>realp <font color="#990000">=</font> mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mSplitFFTBuf</font></b><font color="#990000">();</font>
		mSpectralBufferList<font color="#990000">-&gt;</font>mDSPSplitComplex<font color="#990000">[</font>i<font color="#990000">].</font>imagp <font color="#990000">=</font> mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mSplitFFTBuf</font></b><font color="#990000">()</font> <font color="#990000">+</font> <font color="#990000">(</font>mFFTSize <font color="#990000">&gt;&gt;</font> <font color="#993399">1</font><font color="#990000">);</font>
	<font color="#FF0000">}</font>

	mFFTSetup <font color="#990000">=</font> <b><font color="#000000">vDSP_create_fftsetup</font></b> <font color="#990000">(</font>mLog2FFTSize<font color="#990000">,</font> FFT_RADIX2<font color="#990000">);</font>
	
<font color="#FF0000">}</font>

CASpectralProcessor<font color="#990000">::~</font><b><font color="#000000">CASpectralProcessor</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
	mWindow<font color="#990000">.</font><b><font color="#000000">free</font></b><font color="#990000">();</font>
	mChannels<font color="#990000">.</font><b><font color="#000000">free</font></b><font color="#990000">();</font>
	mSpectralBufferList<font color="#990000">.</font><b><font color="#000000">free</font></b><font color="#990000">();</font>
	<b><font color="#000000">vDSP_destroy_fftsetup</font></b><font color="#990000">(</font>mFFTSetup<font color="#990000">);</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font> CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">Reset</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
	mInputPos <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	mOutputPos <font color="#990000">=</font> <font color="#990000">-</font>mFFTSize <font color="#990000">&amp;</font> mIOMask<font color="#990000">;</font>
	mInFFTPos <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	mOutFFTPos <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	
	<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> mNumChannels<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font> 
	<font color="#FF0000">{</font>
		<b><font color="#000000">memset</font></b><font color="#990000">(</font>mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mInputBuf</font></b><font color="#990000">(),</font> <font color="#993399">0</font><font color="#990000">,</font> mIOBufSize <font color="#990000">*</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>Float32<font color="#990000">));</font>
		<b><font color="#000000">memset</font></b><font color="#990000">(</font>mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mOutputBuf</font></b><font color="#990000">(),</font> <font color="#993399">0</font><font color="#990000">,</font> mIOBufSize <font color="#990000">*</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>Float32<font color="#990000">));</font>
		<b><font color="#000000">memset</font></b><font color="#990000">(</font>mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mFFTBuf</font></b><font color="#990000">(),</font> <font color="#993399">0</font><font color="#990000">,</font> mFFTSize <font color="#990000">*</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>Float32<font color="#990000">));</font>
	<font color="#FF0000">}</font>
<font color="#FF0000">}</font>

<b><font color="#0000FF">const</font></b> <font color="#009900">double</font> two_pi <font color="#990000">=</font> <font color="#993399">2</font><font color="#990000">.</font> <font color="#990000">*</font> M_PI<font color="#990000">;</font>

<font color="#009900">void</font> CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">HanningWindow</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font> 
	<i><font color="#9A1900">// this is also vector optimized</font></i>

	<font color="#009900">double</font> w <font color="#990000">=</font> two_pi <font color="#990000">/</font> <font color="#990000">(</font><font color="#009900">double</font><font color="#990000">)(</font>mFFTSize <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">);</font>
	<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> mFFTSize<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font>
	<font color="#FF0000">{</font>
		mWindow<font color="#990000">[</font>i<font color="#990000">]</font> <font color="#990000">=</font> <font color="#990000">(</font><font color="#993399">0.5</font> <font color="#990000">-</font> <font color="#993399">0.5</font> <font color="#990000">*</font> <b><font color="#000000">cos</font></b><font color="#990000">(</font>w <font color="#990000">*</font> <font color="#990000">(</font><font color="#009900">double</font><font color="#990000">)</font>i<font color="#990000">));</font>	
	<font color="#FF0000">}</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font> CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">SineWindow</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
	<font color="#009900">double</font> w <font color="#990000">=</font> M_PI <font color="#990000">/</font> <font color="#990000">(</font><font color="#009900">double</font><font color="#990000">)(</font>mFFTSize <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">);</font>
	<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> mFFTSize<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font>
	<font color="#FF0000">{</font>
		mWindow<font color="#990000">[</font>i<font color="#990000">]</font> <font color="#990000">=</font> <b><font color="#000000">sin</font></b><font color="#990000">(</font>w <font color="#990000">*</font> <font color="#990000">(</font><font color="#009900">double</font><font color="#990000">)</font>i<font color="#990000">);</font>
	<font color="#FF0000">}</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font> CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">Process</font></b><font color="#990000">(</font><font color="#008080">UInt32</font> inNumFrames<font color="#990000">,</font> AudioBufferList<font color="#990000">*</font> inInput<font color="#990000">,</font> AudioBufferList<font color="#990000">*</font> outOutput<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<i><font color="#9A1900">// copy from buffer list to input buffer</font></i>
	<b><font color="#000000">CopyInput</font></b><font color="#990000">(</font>inNumFrames<font color="#990000">,</font> inInput<font color="#990000">);</font>
	
	<i><font color="#9A1900">// if enough input to process, then process.</font></i>
	<b><font color="#0000FF">while</font></b> <font color="#990000">(</font>mInputSize <font color="#990000">&gt;=</font> mFFTSize<font color="#990000">)</font> 
	<font color="#FF0000">{</font>
		<b><font color="#000000">CopyInputToFFT</font></b><font color="#990000">();</font> <i><font color="#9A1900">// copy from input buffer to fft buffer</font></i>
		<b><font color="#000000">DoWindowing</font></b><font color="#990000">();</font>
		<b><font color="#000000">DoFwdFFT</font></b><font color="#990000">();</font>
		<b><font color="#000000">ProcessSpectrum</font></b><font color="#990000">(</font>mFFTSize<font color="#990000">,</font> <b><font color="#000000">mSpectralBufferList</font></b><font color="#990000">());</font>
		<b><font color="#000000">DoInvFFT</font></b><font color="#990000">();</font>
		<b><font color="#000000">DoWindowing</font></b><font color="#990000">();</font>
		<b><font color="#000000">OverlapAddOutput</font></b><font color="#990000">();</font>
	<font color="#FF0000">}</font>

	<i><font color="#9A1900">// copy from output buffer to buffer list</font></i>
	<b><font color="#000000">CopyOutput</font></b><font color="#990000">(</font>inNumFrames<font color="#990000">,</font> outOutput<font color="#990000">);</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font> CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">DoWindowing</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
	<font color="#008080">Float32</font> <font color="#990000">*</font>win <font color="#990000">=</font> <b><font color="#000000">mWindow</font></b><font color="#990000">();</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>win<font color="#990000">)</font> <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
	<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">;</font> i<font color="#990000">&lt;</font>mNumChannels<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font> <font color="#FF0000">{</font>
		<font color="#008080">Float32</font> <font color="#990000">*</font>x <font color="#990000">=</font> mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mFFTBuf</font></b><font color="#990000">();</font>
		<b><font color="#000000">vDSP_vmul</font></b><font color="#990000">(</font>x<font color="#990000">,</font> <font color="#993399">1</font><font color="#990000">,</font> win<font color="#990000">,</font> <font color="#993399">1</font><font color="#990000">,</font> x<font color="#990000">,</font> <font color="#993399">1</font><font color="#990000">,</font> mFFTSize<font color="#990000">);</font>
	<font color="#FF0000">}</font>
	<i><font color="#9A1900">//printf("DoWindowing %g %g\n", mChannels[0].mFFTBuf()[0], mChannels[0].mFFTBuf()[200]);</font></i>
<font color="#FF0000">}</font>



<font color="#009900">void</font> CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">CopyInput</font></b><font color="#990000">(</font><font color="#008080">UInt32</font> inNumFrames<font color="#990000">,</font> AudioBufferList<font color="#990000">*</font> inInput<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<font color="#008080">UInt32</font> numBytes <font color="#990000">=</font> inNumFrames <font color="#990000">*</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>Float32<font color="#990000">);</font>
	<font color="#008080">UInt32</font> firstPart <font color="#990000">=</font> mIOBufSize <font color="#990000">-</font> mInputPos<font color="#990000">;</font>
	

	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>firstPart <font color="#990000">&lt;</font> inNumFrames<font color="#990000">)</font> <font color="#FF0000">{</font>
		<font color="#008080">UInt32</font> firstPartBytes <font color="#990000">=</font> firstPart <font color="#990000">*</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>Float32<font color="#990000">);</font>
		<font color="#008080">UInt32</font> secondPartBytes <font color="#990000">=</font> numBytes <font color="#990000">-</font> firstPartBytes<font color="#990000">;</font>
		<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">;</font> i<font color="#990000">&lt;</font>mNumChannels<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font> <font color="#FF0000">{</font>		
			<b><font color="#000000">memcpy</font></b><font color="#990000">(</font>mChannels<font color="#990000">[</font>i<font color="#990000">].</font>mInputBuf <font color="#990000">+</font> mInputPos<font color="#990000">,</font> inInput<font color="#990000">-&gt;</font>mBuffers<font color="#990000">[</font>i<font color="#990000">].</font>mData<font color="#990000">,</font> firstPartBytes<font color="#990000">);</font>
			<b><font color="#000000">memcpy</font></b><font color="#990000">(</font>mChannels<font color="#990000">[</font>i<font color="#990000">].</font>mInputBuf<font color="#990000">,</font> <font color="#990000">(</font>UInt8<font color="#990000">*)</font>inInput<font color="#990000">-&gt;</font>mBuffers<font color="#990000">[</font>i<font color="#990000">].</font>mData <font color="#990000">+</font> firstPartBytes<font color="#990000">,</font> secondPartBytes<font color="#990000">);</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
		<font color="#008080">UInt32</font> numBytes <font color="#990000">=</font> inNumFrames <font color="#990000">*</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>Float32<font color="#990000">);</font>
		<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">;</font> i<font color="#990000">&lt;</font>mNumChannels<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font> <font color="#FF0000">{</font>		
			<b><font color="#000000">memcpy</font></b><font color="#990000">(</font>mChannels<font color="#990000">[</font>i<font color="#990000">].</font>mInputBuf <font color="#990000">+</font> mInputPos<font color="#990000">,</font> inInput<font color="#990000">-&gt;</font>mBuffers<font color="#990000">[</font>i<font color="#990000">].</font>mData<font color="#990000">,</font> numBytes<font color="#990000">);</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font>
	<i><font color="#9A1900">//printf("CopyInput %g %g\n", mChannels[0].mInputBuf[mInputPos], mChannels[0].mInputBuf[(mInputPos + 200) &amp; mIOMask]);</font></i>
	<i><font color="#9A1900">//printf("CopyInput mInputPos %u   mIOBufSize %u\n", (unsigned)mInputPos, (unsigned)mIOBufSize);</font></i>
	mInputSize <font color="#990000">+=</font> inNumFrames<font color="#990000">;</font>
	mInputPos <font color="#990000">=</font> <font color="#990000">(</font>mInputPos <font color="#990000">+</font> inNumFrames<font color="#990000">)</font> <font color="#990000">&amp;</font> mIOMask<font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font> CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">CopyOutput</font></b><font color="#990000">(</font><font color="#008080">UInt32</font> inNumFrames<font color="#990000">,</font> AudioBufferList<font color="#990000">*</font> outOutput<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<i><font color="#9A1900">//printf("-&gt;CopyOutput %g %g\n", mChannels[0].mOutputBuf[mOutputPos], mChannels[0].mOutputBuf[(mOutputPos + 200) &amp; mIOMask]);</font></i>
	<i><font color="#9A1900">//printf("CopyOutput mOutputPos %u\n", (unsigned)mOutputPos);</font></i>
	<font color="#008080">UInt32</font> numBytes <font color="#990000">=</font> inNumFrames <font color="#990000">*</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>Float32<font color="#990000">);</font>
	<font color="#008080">UInt32</font> firstPart <font color="#990000">=</font> mIOBufSize <font color="#990000">-</font> mOutputPos<font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>firstPart <font color="#990000">&lt;</font> inNumFrames<font color="#990000">)</font> <font color="#FF0000">{</font>
		<font color="#008080">UInt32</font> firstPartBytes <font color="#990000">=</font> firstPart <font color="#990000">*</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>Float32<font color="#990000">);</font>
		<font color="#008080">UInt32</font> secondPartBytes <font color="#990000">=</font> numBytes <font color="#990000">-</font> firstPartBytes<font color="#990000">;</font>
		<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">;</font> i<font color="#990000">&lt;</font>mNumChannels<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font> <font color="#FF0000">{</font>
			<b><font color="#000000">memcpy</font></b><font color="#990000">(</font>outOutput<font color="#990000">-&gt;</font>mBuffers<font color="#990000">[</font>i<font color="#990000">].</font>mData<font color="#990000">,</font> mChannels<font color="#990000">[</font>i<font color="#990000">].</font>mOutputBuf <font color="#990000">+</font> mOutputPos<font color="#990000">,</font> firstPartBytes<font color="#990000">);</font>
			<b><font color="#000000">memcpy</font></b><font color="#990000">((</font>UInt8<font color="#990000">*)</font>outOutput<font color="#990000">-&gt;</font>mBuffers<font color="#990000">[</font>i<font color="#990000">].</font>mData <font color="#990000">+</font> firstPartBytes<font color="#990000">,</font> mChannels<font color="#990000">[</font>i<font color="#990000">].</font>mOutputBuf<font color="#990000">,</font> secondPartBytes<font color="#990000">);</font>
			<b><font color="#000000">memset</font></b><font color="#990000">(</font>mChannels<font color="#990000">[</font>i<font color="#990000">].</font>mOutputBuf <font color="#990000">+</font> mOutputPos<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> firstPartBytes<font color="#990000">);</font>
			<b><font color="#000000">memset</font></b><font color="#990000">(</font>mChannels<font color="#990000">[</font>i<font color="#990000">].</font>mOutputBuf<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> secondPartBytes<font color="#990000">);</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
		<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">;</font> i<font color="#990000">&lt;</font>mNumChannels<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font> <font color="#FF0000">{</font>
			<b><font color="#000000">memcpy</font></b><font color="#990000">(</font>outOutput<font color="#990000">-&gt;</font>mBuffers<font color="#990000">[</font>i<font color="#990000">].</font>mData<font color="#990000">,</font> mChannels<font color="#990000">[</font>i<font color="#990000">].</font>mOutputBuf <font color="#990000">+</font> mOutputPos<font color="#990000">,</font> numBytes<font color="#990000">);</font>
			<b><font color="#000000">memset</font></b><font color="#990000">(</font>mChannels<font color="#990000">[</font>i<font color="#990000">].</font>mOutputBuf <font color="#990000">+</font> mOutputPos<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> numBytes<font color="#990000">);</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font>
	<i><font color="#9A1900">//printf("&lt;-CopyOutput %g %g\n", ((Float32*)outOutput-&gt;mBuffers[0].mData)[0], ((Float32*)outOutput-&gt;mBuffers[0].mData)[200]);</font></i>
	mOutputPos <font color="#990000">=</font> <font color="#990000">(</font>mOutputPos <font color="#990000">+</font> inNumFrames<font color="#990000">)</font> <font color="#990000">&amp;</font> mIOMask<font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font> CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">PrintSpectralBufferList</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
	<font color="#008080">UInt32</font> half <font color="#990000">=</font> mFFTSize <font color="#990000">&gt;&gt;</font> <font color="#993399">1</font><font color="#990000">;</font>
	<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">;</font> i<font color="#990000">&lt;</font>mNumChannels<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font> <font color="#FF0000">{</font>
		<font color="#008080">DSPSplitComplex</font>	<font color="#990000">&amp;</font>freqData <font color="#990000">=</font> mSpectralBufferList<font color="#990000">-&gt;</font>mDSPSplitComplex<font color="#990000">[</font>i<font color="#990000">];</font>
	
		<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> j<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">;</font> j<font color="#990000">&lt;</font>half<font color="#990000">;</font> j<font color="#990000">++)</font><font color="#FF0000">{</font>
			<b><font color="#000000">printf</font></b><font color="#990000">(</font><font color="#FF0000">" bin[%d]: %lf + %lfi</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">,</font> <font color="#990000">(</font><font color="#009900">int</font><font color="#990000">)</font> j<font color="#990000">,</font> freqData<font color="#990000">.</font>realp<font color="#990000">[</font>j<font color="#990000">],</font> freqData<font color="#990000">.</font>imagp<font color="#990000">[</font>j<font color="#990000">]);</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font>
<font color="#FF0000">}</font>


<font color="#009900">void</font> CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">CopyInputToFFT</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
	<i><font color="#9A1900">//printf("CopyInputToFFT mInFFTPos %u\n", (unsigned)mInFFTPos);</font></i>
	<font color="#008080">UInt32</font> firstPart <font color="#990000">=</font> mIOBufSize <font color="#990000">-</font> mInFFTPos<font color="#990000">;</font>
	<font color="#008080">UInt32</font> firstPartBytes <font color="#990000">=</font> firstPart <font color="#990000">*</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>Float32<font color="#990000">);</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>firstPartBytes <font color="#990000">&lt;</font> mFFTByteSize<font color="#990000">)</font> <font color="#FF0000">{</font>
		<font color="#008080">UInt32</font> secondPartBytes <font color="#990000">=</font> mFFTByteSize <font color="#990000">-</font> firstPartBytes<font color="#990000">;</font>
		<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">;</font> i<font color="#990000">&lt;</font>mNumChannels<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font> <font color="#FF0000">{</font>
			<b><font color="#000000">memcpy</font></b><font color="#990000">(</font>mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mFFTBuf</font></b><font color="#990000">(),</font> mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mInputBuf</font></b><font color="#990000">()</font> <font color="#990000">+</font> mInFFTPos<font color="#990000">,</font> firstPartBytes<font color="#990000">);</font>
			<b><font color="#000000">memcpy</font></b><font color="#990000">((</font>UInt8<font color="#990000">*)</font>mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mFFTBuf</font></b><font color="#990000">()</font> <font color="#990000">+</font> firstPartBytes<font color="#990000">,</font> mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mInputBuf</font></b><font color="#990000">(),</font> secondPartBytes<font color="#990000">);</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
		<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">;</font> i<font color="#990000">&lt;</font>mNumChannels<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font> <font color="#FF0000">{</font>
			<b><font color="#000000">memcpy</font></b><font color="#990000">(</font>mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mFFTBuf</font></b><font color="#990000">(),</font> mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mInputBuf</font></b><font color="#990000">()</font> <font color="#990000">+</font> mInFFTPos<font color="#990000">,</font> mFFTByteSize<font color="#990000">);</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font>
	mInputSize <font color="#990000">-=</font> mHopSize<font color="#990000">;</font>
	mInFFTPos <font color="#990000">=</font> <font color="#990000">(</font>mInFFTPos <font color="#990000">+</font> mHopSize<font color="#990000">)</font> <font color="#990000">&amp;</font> mIOMask<font color="#990000">;</font>
	<i><font color="#9A1900">//printf("CopyInputToFFT %g %g\n", mChannels[0].mFFTBuf()[0], mChannels[0].mFFTBuf()[200]);</font></i>
<font color="#FF0000">}</font>

<font color="#009900">void</font> CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">OverlapAddOutput</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
	<i><font color="#9A1900">//printf("OverlapAddOutput mOutFFTPos %u\n", (unsigned)mOutFFTPos);</font></i>
	<font color="#008080">UInt32</font> firstPart <font color="#990000">=</font> mIOBufSize <font color="#990000">-</font> mOutFFTPos<font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>firstPart <font color="#990000">&lt;</font> mFFTSize<font color="#990000">)</font> <font color="#FF0000">{</font>
		<font color="#008080">UInt32</font> secondPart <font color="#990000">=</font> mFFTSize <font color="#990000">-</font> firstPart<font color="#990000">;</font>
		<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">;</font> i<font color="#990000">&lt;</font>mNumChannels<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font> <font color="#FF0000">{</font>
			<font color="#009900">float</font><font color="#990000">*</font> out1 <font color="#990000">=</font> mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mOutputBuf</font></b><font color="#990000">()</font> <font color="#990000">+</font> mOutFFTPos<font color="#990000">;</font>
			<b><font color="#000000">vDSP_vadd</font></b><font color="#990000">(</font>out1<font color="#990000">,</font> <font color="#993399">1</font><font color="#990000">,</font> mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mFFTBuf</font></b><font color="#990000">(),</font> <font color="#993399">1</font><font color="#990000">,</font> out1<font color="#990000">,</font> <font color="#993399">1</font><font color="#990000">,</font> firstPart<font color="#990000">);</font>
			<font color="#009900">float</font><font color="#990000">*</font> out2 <font color="#990000">=</font> mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mOutputBuf</font></b><font color="#990000">();</font>
			<b><font color="#000000">vDSP_vadd</font></b><font color="#990000">(</font>out2<font color="#990000">,</font> <font color="#993399">1</font><font color="#990000">,</font> mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mFFTBuf</font></b><font color="#990000">()</font> <font color="#990000">+</font> firstPart<font color="#990000">,</font> <font color="#993399">1</font><font color="#990000">,</font> out2<font color="#990000">,</font> <font color="#993399">1</font><font color="#990000">,</font> secondPart<font color="#990000">);</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
		<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">;</font> i<font color="#990000">&lt;</font>mNumChannels<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font> <font color="#FF0000">{</font>
			<font color="#009900">float</font><font color="#990000">*</font> out1 <font color="#990000">=</font> mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mOutputBuf</font></b><font color="#990000">()</font> <font color="#990000">+</font> mOutFFTPos<font color="#990000">;</font>
			<b><font color="#000000">vDSP_vadd</font></b><font color="#990000">(</font>out1<font color="#990000">,</font> <font color="#993399">1</font><font color="#990000">,</font> mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mFFTBuf</font></b><font color="#990000">(),</font> <font color="#993399">1</font><font color="#990000">,</font> out1<font color="#990000">,</font> <font color="#993399">1</font><font color="#990000">,</font> mFFTSize<font color="#990000">);</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font>
	<i><font color="#9A1900">//printf("OverlapAddOutput %g %g\n", mChannels[0].mOutputBuf[mOutFFTPos], mChannels[0].mOutputBuf[(mOutFFTPos + 200) &amp; mIOMask]);</font></i>
	mOutFFTPos <font color="#990000">=</font> <font color="#990000">(</font>mOutFFTPos <font color="#990000">+</font> mHopSize<font color="#990000">)</font> <font color="#990000">&amp;</font> mIOMask<font color="#990000">;</font>
<font color="#FF0000">}</font>


<font color="#009900">void</font> CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">DoFwdFFT</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
	<i><font color="#9A1900">//printf("-&gt;DoFwdFFT %g %g\n", mChannels[0].mFFTBuf()[0], mChannels[0].mFFTBuf()[200]);</font></i>
	<font color="#008080">UInt32</font> half <font color="#990000">=</font> mFFTSize <font color="#990000">&gt;&gt;</font> <font color="#993399">1</font><font color="#990000">;</font>
	<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">;</font> i<font color="#990000">&lt;</font>mNumChannels<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font> 
	<font color="#FF0000">{</font>
		<b><font color="#000000">vDSP_ctoz</font></b><font color="#990000">((</font>DSPComplex<font color="#990000">*)</font>mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mFFTBuf</font></b><font color="#990000">(),</font> <font color="#993399">2</font><font color="#990000">,</font> <font color="#990000">&amp;</font>mSpectralBufferList<font color="#990000">-&gt;</font>mDSPSplitComplex<font color="#990000">[</font>i<font color="#990000">],</font> <font color="#993399">1</font><font color="#990000">,</font> half<font color="#990000">);</font>
		<b><font color="#000000">vDSP_fft_zrip</font></b><font color="#990000">(</font>mFFTSetup<font color="#990000">,</font> <font color="#990000">&amp;</font>mSpectralBufferList<font color="#990000">-&gt;</font>mDSPSplitComplex<font color="#990000">[</font>i<font color="#990000">],</font> <font color="#993399">1</font><font color="#990000">,</font> mLog2FFTSize<font color="#990000">,</font> FFT_FORWARD<font color="#990000">);</font>
	<font color="#FF0000">}</font>
	<i><font color="#9A1900">//printf("&lt;-DoFwdFFT %g %g\n", direction, mChannels[0].mFFTBuf()[0], mChannels[0].mFFTBuf()[200]);</font></i>
<font color="#FF0000">}</font>

<font color="#009900">void</font> CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">DoInvFFT</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
	<i><font color="#9A1900">//printf("-&gt;DoInvFFT %g %g\n", mChannels[0].mFFTBuf()[0], mChannels[0].mFFTBuf()[200]);</font></i>
	<font color="#008080">UInt32</font> half <font color="#990000">=</font> mFFTSize <font color="#990000">&gt;&gt;</font> <font color="#993399">1</font><font color="#990000">;</font>
	<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">;</font> i<font color="#990000">&lt;</font>mNumChannels<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font> 
	<font color="#FF0000">{</font>
		<b><font color="#000000">vDSP_fft_zrip</font></b><font color="#990000">(</font>mFFTSetup<font color="#990000">,</font> <font color="#990000">&amp;</font>mSpectralBufferList<font color="#990000">-&gt;</font>mDSPSplitComplex<font color="#990000">[</font>i<font color="#990000">],</font> <font color="#993399">1</font><font color="#990000">,</font> mLog2FFTSize<font color="#990000">,</font> FFT_INVERSE<font color="#990000">);</font>
		<b><font color="#000000">vDSP_ztoc</font></b><font color="#990000">(&amp;</font>mSpectralBufferList<font color="#990000">-&gt;</font>mDSPSplitComplex<font color="#990000">[</font>i<font color="#990000">],</font> <font color="#993399">1</font><font color="#990000">,</font> <font color="#990000">(</font>DSPComplex<font color="#990000">*)</font>mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mFFTBuf</font></b><font color="#990000">(),</font> <font color="#993399">2</font><font color="#990000">,</font> half<font color="#990000">);</font>		
		<font color="#009900">float</font> scale <font color="#990000">=</font> <font color="#993399">0.5</font> <font color="#990000">/</font> mFFTSize<font color="#990000">;</font>
		<b><font color="#000000">vDSP_vsmul</font></b><font color="#990000">(</font>mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mFFTBuf</font></b><font color="#990000">(),</font> <font color="#993399">1</font><font color="#990000">,</font> <font color="#990000">&amp;</font>scale<font color="#990000">,</font> mChannels<font color="#990000">[</font>i<font color="#990000">].</font><b><font color="#000000">mFFTBuf</font></b><font color="#990000">(),</font> <font color="#993399">1</font><font color="#990000">,</font> mFFTSize <font color="#990000">);</font>
	<font color="#FF0000">}</font>
	<i><font color="#9A1900">//printf("&lt;-DoInvFFT %g %g\n", direction, mChannels[0].mFFTBuf()[0], mChannels[0].mFFTBuf()[200]);</font></i>
<font color="#FF0000">}</font>

<font color="#009900">void</font> CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">SetSpectralFunction</font></b><font color="#990000">(</font><font color="#008080">SpectralFunction</font> inFunction<font color="#990000">,</font> <font color="#009900">void</font><font color="#990000">*</font> inUserData<font color="#990000">)</font>
<font color="#FF0000">{</font>
	mSpectralFunction <font color="#990000">=</font> inFunction<font color="#990000">;</font> 
	mUserData <font color="#990000">=</font> inUserData<font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font> CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">ProcessSpectrum</font></b><font color="#990000">(</font><font color="#008080">UInt32</font> inFFTSize<font color="#990000">,</font> SpectralBufferList<font color="#990000">*</font> inSpectra<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mSpectralFunction<font color="#990000">)</font>
		<font color="#990000">(</font>mSpectralFunction<font color="#990000">)(</font>inSpectra<font color="#990000">,</font> mUserData<font color="#990000">);</font>
<font color="#FF0000">}</font>

<b><font color="#000080">#pragma</font></b> <font color="#008080">mark</font> ___Utility___

<font color="#009900">void</font> CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">GetMagnitude</font></b><font color="#990000">(</font>AudioBufferList<font color="#990000">*</font> list<font color="#990000">,</font> Float32<font color="#990000">*</font> min<font color="#990000">,</font> Float32<font color="#990000">*</font> max<font color="#990000">)</font> 
<font color="#FF0000">{</font>	
	<font color="#008080">UInt32</font> half <font color="#990000">=</font> mFFTSize <font color="#990000">&gt;&gt;</font> <font color="#993399">1</font><font color="#990000">;</font>	
	<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">;</font> i<font color="#990000">&lt;</font>mNumChannels<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font> <font color="#FF0000">{</font>
		<font color="#008080">DSPSplitComplex</font>	<font color="#990000">&amp;</font>freqData <font color="#990000">=</font> mSpectralBufferList<font color="#990000">-&gt;</font>mDSPSplitComplex<font color="#990000">[</font>i<font color="#990000">];</font>		
		
		Float32<font color="#990000">*</font> b <font color="#990000">=</font> <font color="#990000">(</font>Float32<font color="#990000">*)</font> list<font color="#990000">-&gt;</font>mBuffers<font color="#990000">[</font>i<font color="#990000">].</font>mData<font color="#990000">;</font>
		
		<b><font color="#000000">vDSP_zvabs</font></b><font color="#990000">(&amp;</font>freqData<font color="#990000">,</font><font color="#993399">1</font><font color="#990000">,</font>b<font color="#990000">,</font><font color="#993399">1</font><font color="#990000">,</font>half<font color="#990000">);</font> 		
   
		<b><font color="#000000">vDSP_maxmgv</font></b><font color="#990000">(</font>b<font color="#990000">,</font> <font color="#993399">1</font><font color="#990000">,</font> <font color="#990000">&amp;</font>max<font color="#990000">[</font>i<font color="#990000">],</font> half<font color="#990000">);</font> 
 		<b><font color="#000000">vDSP_minmgv</font></b><font color="#990000">(</font>b<font color="#990000">,</font> <font color="#993399">1</font><font color="#990000">,</font> <font color="#990000">&amp;</font>min<font color="#990000">[</font>i<font color="#990000">],</font> half<font color="#990000">);</font> 
		
   <font color="#FF0000">}</font> 
<font color="#FF0000">}</font>


<font color="#009900">void</font> CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">GetFrequencies</font></b><font color="#990000">(</font>Float32<font color="#990000">*</font> freqs<font color="#990000">,</font> <font color="#008080">Float32</font> sampleRate<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<font color="#008080">UInt32</font> half <font color="#990000">=</font> mFFTSize <font color="#990000">&gt;&gt;</font> <font color="#993399">1</font><font color="#990000">;</font>	

	<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i<font color="#990000">=</font><font color="#993399">0</font><font color="#990000">;</font> i<font color="#990000">&lt;</font> half<font color="#990000">;</font> i<font color="#990000">++)</font><font color="#FF0000">{</font>
		freqs<font color="#990000">[</font>i<font color="#990000">]</font> <font color="#990000">=</font> <font color="#990000">((</font>Float32<font color="#990000">)(</font>i<font color="#990000">))*</font>sampleRate<font color="#990000">/((</font>Float32<font color="#990000">)</font>mFFTSize<font color="#990000">);</font>	
	<font color="#FF0000">}</font>
<font color="#FF0000">}</font>


<font color="#009900">bool</font> CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">ProcessForwards</font></b><font color="#990000">(</font><font color="#008080">UInt32</font> inNumFrames<font color="#990000">,</font> AudioBufferList<font color="#990000">*</font> inInput<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<i><font color="#9A1900">// copy from buffer list to input buffer</font></i>
	<b><font color="#000000">CopyInput</font></b><font color="#990000">(</font>inNumFrames<font color="#990000">,</font> inInput<font color="#990000">);</font>
		
	<font color="#009900">bool</font> processed <font color="#990000">=</font> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
	<i><font color="#9A1900">// if enough input to process, then process.</font></i>
	<b><font color="#0000FF">while</font></b> <font color="#990000">(</font>mInputSize <font color="#990000">&gt;=</font> mFFTSize<font color="#990000">)</font> 
	<font color="#FF0000">{</font>
		<b><font color="#000000">CopyInputToFFT</font></b><font color="#990000">();</font> <i><font color="#9A1900">// copy from input buffer to fft buffer</font></i>
		<b><font color="#000000">DoWindowing</font></b><font color="#990000">();</font>
		<b><font color="#000000">DoFwdFFT</font></b><font color="#990000">();</font>
		<b><font color="#000000">ProcessSpectrum</font></b><font color="#990000">(</font>mFFTSize<font color="#990000">,</font> <b><font color="#000000">mSpectralBufferList</font></b><font color="#990000">());</font> <i><font color="#9A1900">// here you would copy the fft results out to a buffer indicated in mUserData, say for sonogram drawing</font></i>
		processed <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
	<font color="#FF0000">}</font>
	
	<b><font color="#0000FF">return</font></b> processed<font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">bool</font> CASpectralProcessor<font color="#990000">::</font><b><font color="#000000">ProcessBackwards</font></b><font color="#990000">(</font><font color="#008080">UInt32</font> inNumFrames<font color="#990000">,</font> AudioBufferList<font color="#990000">*</font> outOutput<font color="#990000">)</font>
<font color="#FF0000">{</font>		
	
	<b><font color="#000000">ProcessSpectrum</font></b><font color="#990000">(</font>mFFTSize<font color="#990000">,</font> <b><font color="#000000">mSpectralBufferList</font></b><font color="#990000">());</font>
	<b><font color="#000000">DoInvFFT</font></b><font color="#990000">();</font>
	<b><font color="#000000">DoWindowing</font></b><font color="#990000">();</font>
	<b><font color="#000000">OverlapAddOutput</font></b><font color="#990000">();</font>		
	
	<i><font color="#9A1900">// copy from output buffer to buffer list</font></i>
	<b><font color="#000000">CopyOutput</font></b><font color="#990000">(</font>inNumFrames<font color="#990000">,</font> outOutput<font color="#990000">);</font>
	
	<b><font color="#0000FF">return</font></b> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>


</tt></pre>
