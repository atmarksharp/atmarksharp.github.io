<!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<i><font color="#9A1900">/*   Path: ~/lab/CoreAudioUtilityClasses/Mac/CoreAudioUtilityClasses/CoreAudio/AudioUnits/AUPublic/AUCarbonViewBase/AUCarbonViewControl.cpp  */</font></i>

<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900">     File: AUCarbonViewControl.cpp </font></i>
<i><font color="#9A1900"> Abstract:  AUCarbonViewControl.h  </font></i>
<i><font color="#9A1900">  Version: 1.0.4 </font></i>
<i><font color="#9A1900">  </font></i>
<i><font color="#9A1900"> Disclaimer: IMPORTANT:  This Apple software is supplied to you by Apple </font></i>
<i><font color="#9A1900"> Inc. ("Apple") in consideration of your agreement to the following </font></i>
<i><font color="#9A1900"> terms, and your use, installation, modification or redistribution of </font></i>
<i><font color="#9A1900"> this Apple software constitutes acceptance of these terms.  If you do </font></i>
<i><font color="#9A1900"> not agree with these terms, please do not use, install, modify or </font></i>
<i><font color="#9A1900"> redistribute this Apple software. </font></i>
<i><font color="#9A1900">  </font></i>
<i><font color="#9A1900"> In consideration of your agreement to abide by the following terms, and </font></i>
<i><font color="#9A1900"> subject to these terms, Apple grants you a personal, non-exclusive </font></i>
<i><font color="#9A1900"> license, under Apple's copyrights in this original Apple software (the </font></i>
<i><font color="#9A1900"> "Apple Software"), to use, reproduce, modify and redistribute the Apple </font></i>
<i><font color="#9A1900"> Software, with or without modifications, in source and/or binary forms; </font></i>
<i><font color="#9A1900"> provided that if you redistribute the Apple Software in its entirety and </font></i>
<i><font color="#9A1900"> without modifications, you must retain this notice and the following </font></i>
<i><font color="#9A1900"> text and disclaimers in all such redistributions of the Apple Software. </font></i>
<i><font color="#9A1900"> Neither the name, trademarks, service marks or logos of Apple Inc. may </font></i>
<i><font color="#9A1900"> be used to endorse or promote products derived from the Apple Software </font></i>
<i><font color="#9A1900"> without specific prior written permission from Apple.  Except as </font></i>
<i><font color="#9A1900"> expressly stated in this notice, no other rights or licenses, express or </font></i>
<i><font color="#9A1900"> implied, are granted by Apple herein, including but not limited to any </font></i>
<i><font color="#9A1900"> patent rights that may be infringed by your derivative works or by other </font></i>
<i><font color="#9A1900"> works in which the Apple Software may be incorporated. </font></i>
<i><font color="#9A1900">  </font></i>
<i><font color="#9A1900"> The Apple Software is provided by Apple on an "AS IS" basis.  APPLE </font></i>
<i><font color="#9A1900"> MAKES NO WARRANTIES, EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION </font></i>
<i><font color="#9A1900"> THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY AND FITNESS </font></i>
<i><font color="#9A1900"> FOR A PARTICULAR PURPOSE, REGARDING THE APPLE SOFTWARE OR ITS USE AND </font></i>
<i><font color="#9A1900"> OPERATION ALONE OR IN COMBINATION WITH YOUR PRODUCTS. </font></i>
<i><font color="#9A1900">  </font></i>
<i><font color="#9A1900"> IN NO EVENT SHALL APPLE BE LIABLE FOR ANY SPECIAL, INDIRECT, INCIDENTAL </font></i>
<i><font color="#9A1900"> OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF </font></i>
<i><font color="#9A1900"> SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS </font></i>
<i><font color="#9A1900"> INTERRUPTION) ARISING IN ANY WAY OUT OF THE USE, REPRODUCTION, </font></i>
<i><font color="#9A1900"> MODIFICATION AND/OR DISTRIBUTION OF THE APPLE SOFTWARE, HOWEVER CAUSED </font></i>
<i><font color="#9A1900"> AND WHETHER UNDER THEORY OF CONTRACT, TORT (INCLUDING NEGLIGENCE), </font></i>
<i><font color="#9A1900"> STRICT LIABILITY OR OTHERWISE, EVEN IF APPLE HAS BEEN ADVISED OF THE </font></i>
<i><font color="#9A1900"> POSSIBILITY OF SUCH DAMAGE. </font></i>
<i><font color="#9A1900">  </font></i>
<i><font color="#9A1900"> Copyright (C) 2013 Apple Inc. All Rights Reserved. </font></i>
<i><font color="#9A1900">  </font></i>
<i><font color="#9A1900">*/</font></i>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"AUCarbonViewControl.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"AUCarbonViewBase.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"AUViewLocalizedStringKeys.h"</font>

AUCarbonViewControl<font color="#990000">::</font><b><font color="#000000">AUCarbonViewControl</font></b><font color="#990000">(</font><font color="#008080">AUCarbonViewBase</font> <font color="#990000">*</font>ownerView<font color="#990000">,</font> <font color="#008080">AUParameterListenerRef</font> listener<font color="#990000">,</font> <font color="#008080">ControlType</font> type<font color="#990000">,</font> <b><font color="#0000FF">const</font></b> <font color="#008080">CAAUParameter</font> <font color="#990000">&amp;</font>param<font color="#990000">,</font> <font color="#008080">ControlRef</font> control<font color="#990000">)</font> <font color="#990000">:</font>
	<b><font color="#000000">mOwnerView</font></b><font color="#990000">(</font>ownerView<font color="#990000">),</font>
	<b><font color="#000000">mListener</font></b><font color="#990000">(</font>listener<font color="#990000">),</font>
	<b><font color="#000000">mType</font></b><font color="#990000">(</font>type<font color="#990000">),</font>
	<b><font color="#000000">mParam</font></b><font color="#990000">(</font>param<font color="#990000">),</font>
	<b><font color="#000000">mControl</font></b><font color="#990000">(</font>control<font color="#990000">),</font>
	<b><font color="#000000">mInControlInitialization</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">)</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__
	<b><font color="#000000">SetControlReference</font></b><font color="#990000">(</font>control<font color="#990000">,</font> <b><font color="#000000">SRefCon</font></b><font color="#990000">(</font><b><font color="#0000FF">this</font></b><font color="#990000">));</font>
<b><font color="#000080">#endif</font></b>
<font color="#FF0000">}</font>

AUCarbonViewControl<font color="#990000">::~</font><b><font color="#000000">AUCarbonViewControl</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
	<b><font color="#000000">AUListenerRemoveParameter</font></b><font color="#990000">(</font>mListener<font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">,</font> <font color="#990000">&amp;</font>mParam<font color="#990000">);</font>
<font color="#FF0000">}</font>

AUCarbonViewControl<font color="#990000">*</font> AUCarbonViewControl<font color="#990000">::</font>mLastControl <font color="#990000">=</font> NULL<font color="#990000">;</font>

<font color="#009900">void</font>	AUCarbonViewControl<font color="#990000">::</font><b><font color="#000000">Bind</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__
	mInControlInitialization <font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">;</font>   <i><font color="#9A1900">// true</font></i>
	<b><font color="#000000">AUListenerAddParameter</font></b><font color="#990000">(</font>mListener<font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">,</font> <font color="#990000">&amp;</font>mParam<font color="#990000">);</font>
		<i><font color="#9A1900">// will cause an almost-immediate callback</font></i>
	
	<font color="#008080">EventTypeSpec</font> events<font color="#990000">[]</font> <font color="#990000">=</font> <font color="#FF0000">{</font>
		<font color="#FF0000">{</font> kEventClassControl<font color="#990000">,</font> kEventControlValueFieldChanged <font color="#FF0000">}</font>	<i><font color="#9A1900">// N.B. OS X only</font></i>
	<font color="#FF0000">}</font><font color="#990000">;</font>
	
	<b><font color="#000000">WantEventTypes</font></b><font color="#990000">(</font><b><font color="#000000">GetControlEventTarget</font></b><font color="#990000">(</font>mControl<font color="#990000">),</font> <b><font color="#000000">GetEventTypeCount</font></b><font color="#990000">(</font>events<font color="#990000">),</font> events<font color="#990000">);</font>

	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mType <font color="#990000">==</font> kTypeContinuous <font color="#990000">||</font> mType <font color="#990000">==</font> kTypeText <font color="#990000">||</font> mType <font color="#990000">==</font> kTypeDiscrete<font color="#990000">)</font> <font color="#FF0000">{</font>
		<font color="#008080">EventTypeSpec</font> events<font color="#990000">[]</font> <font color="#990000">=</font> <font color="#FF0000">{</font>
			<font color="#FF0000">{</font> kEventClassControl<font color="#990000">,</font> kEventControlHit <font color="#FF0000">}</font><font color="#990000">,</font>
			<font color="#FF0000">{</font> kEventClassControl<font color="#990000">,</font> kEventControlClick <font color="#FF0000">}</font><font color="#990000">,</font>
		    <font color="#FF0000">{</font> kEventClassControl<font color="#990000">,</font> kEventControlTrack <font color="#FF0000">}</font>
		<font color="#FF0000">}</font><font color="#990000">;</font>
		<b><font color="#000000">WantEventTypes</font></b><font color="#990000">(</font><b><font color="#000000">GetControlEventTarget</font></b><font color="#990000">(</font>mControl<font color="#990000">),</font> <b><font color="#000000">GetEventTypeCount</font></b><font color="#990000">(</font>events<font color="#990000">),</font> events<font color="#990000">);</font>
	<font color="#FF0000">}</font> 

	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mType <font color="#990000">==</font> kTypeText<font color="#990000">)</font> <font color="#FF0000">{</font>
		<font color="#008080">EventTypeSpec</font> events<font color="#990000">[]</font> <font color="#990000">=</font> <font color="#FF0000">{</font>
			<font color="#FF0000">{</font> kEventClassControl<font color="#990000">,</font> kEventControlSetFocusPart <font color="#FF0000">}</font>
		<font color="#FF0000">}</font><font color="#990000">;</font>
		<b><font color="#000000">WantEventTypes</font></b><font color="#990000">(</font><b><font color="#000000">GetControlEventTarget</font></b><font color="#990000">(</font>mControl<font color="#990000">),</font> <b><font color="#000000">GetEventTypeCount</font></b><font color="#990000">(</font>events<font color="#990000">),</font> events<font color="#990000">);</font> 
		<font color="#008080">ControlKeyFilterUPP</font> proc <font color="#990000">=</font> mParam<font color="#990000">.</font><b><font color="#000000">ValuesHaveStrings</font></b><font color="#990000">()</font> <font color="#990000">?</font> StdKeyFilterCallback <font color="#990000">:</font> NumericKeyFilterCallback<font color="#990000">;</font>
			<i><font color="#9A1900">// this will fail for a static text field</font></i>
		<b><font color="#000000">SetControlData</font></b><font color="#990000">(</font>mControl<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> kControlEditTextKeyFilterTag<font color="#990000">,</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>proc<font color="#990000">),</font> <font color="#990000">&amp;</font>proc<font color="#990000">);</font>
	<font color="#FF0000">}</font>
	
	<b><font color="#000000">Update</font></b><font color="#990000">(</font><b><font color="#0000FF">true</font></b><font color="#990000">);</font>
	mInControlInitialization <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>   <i><font color="#9A1900">// false</font></i>
<b><font color="#000080">#endif</font></b>
<font color="#FF0000">}</font>

<font color="#009900">void</font>	AUCarbonViewControl<font color="#990000">::</font><b><font color="#000000">ParameterToControl</font></b><font color="#990000">(</font><font color="#008080">Float32</font> paramValue<font color="#990000">)</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__
	<font color="#990000">++</font>mInControlInitialization<font color="#990000">;</font>
	<b><font color="#0000FF">switch</font></b> <font color="#990000">(</font>mType<font color="#990000">)</font> <font color="#FF0000">{</font>
	<b><font color="#0000FF">case</font></b> kTypeContinuous<font color="#990000">:</font>
		<b><font color="#000000">SetValueFract</font></b><font color="#990000">(</font><b><font color="#000000">AUParameterValueToLinear</font></b><font color="#990000">(</font>paramValue<font color="#990000">,</font> <font color="#990000">&amp;</font>mParam<font color="#990000">));</font>
		<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
	<b><font color="#0000FF">case</font></b> kTypeDiscrete<font color="#990000">:</font>
		<font color="#FF0000">{</font>
			<font color="#009900">long</font> value <font color="#990000">=</font> <font color="#009900">long</font><font color="#990000">(</font>paramValue<font color="#990000">);</font>
			
			<i><font color="#9A1900">// special case [1] -- menu parameters</font></i>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mParam<font color="#990000">.</font><b><font color="#000000">HasNamedParams</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
				<i><font color="#9A1900">// if we're dealing with menus they behave differently!</font></i>
				<i><font color="#9A1900">// becaue setting min and max doesn't work correctly for the control value</font></i>
				<i><font color="#9A1900">// first menu item always reports a control value of 1</font></i>
				<font color="#008080">ControlKind</font> ctrlKind<font color="#990000">;</font>
				<b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#000000">GetControlKind</font></b><font color="#990000">(</font>mControl<font color="#990000">,</font> <font color="#990000">&amp;</font>ctrlKind<font color="#990000">)</font> <font color="#990000">==</font> noErr<font color="#990000">)</font> <font color="#FF0000">{</font>
					<b><font color="#0000FF">if</font></b> <font color="#990000">((</font>ctrlKind<font color="#990000">.</font>kind <font color="#990000">==</font> kControlKindPopupArrow<font color="#990000">)</font> 
						<font color="#990000">||</font> <font color="#990000">(</font>ctrlKind<font color="#990000">.</font>kind <font color="#990000">==</font> kControlKindPopupButton<font color="#990000">))</font>				
					<font color="#FF0000">{</font>
						value <font color="#990000">=</font> value <font color="#990000">-</font> <font color="#009900">long</font><font color="#990000">(</font>mParam<font color="#990000">.</font><b><font color="#000000">ParamInfo</font></b><font color="#990000">().</font>minValue<font color="#990000">)</font> <font color="#990000">+</font> <font color="#993399">1</font><font color="#990000">;</font>
					<font color="#FF0000">}</font>
				<font color="#FF0000">}</font>
			<font color="#FF0000">}</font>
			
			<i><font color="#9A1900">// special case [2] -- Write-only boolean parameters</font></i>
			<font color="#008080">AudioUnitParameterInfo</font> AUPI <font color="#990000">=</font> mParam<font color="#990000">.</font><b><font color="#000000">ParamInfo</font></b><font color="#990000">();</font>
			
			<font color="#009900">bool</font> isWriteOnlyBoolParameter <font color="#990000">=</font> <font color="#990000">(</font>	<font color="#990000">(</font>AUPI<font color="#990000">.</font>unit <font color="#990000">==</font> kAudioUnitParameterUnit_Boolean<font color="#990000">)</font> <font color="#990000">&amp;&amp;</font>
												<font color="#990000">(</font>AUPI<font color="#990000">.</font>flags <font color="#990000">&amp;</font> kAudioUnitParameterFlag_IsWritable<font color="#990000">)</font> <font color="#990000">&amp;&amp;</font>
												<font color="#990000">!(</font>AUPI<font color="#990000">.</font>flags <font color="#990000">&amp;</font> kAudioUnitParameterFlag_IsReadable<font color="#990000">)</font>	<font color="#990000">);</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>isWriteOnlyBoolParameter<font color="#990000">)</font> <font color="#FF0000">{</font>
				<b><font color="#000000">SetValue</font></b> <font color="#990000">(</font>value<font color="#990000">);</font>
			<font color="#FF0000">}</font>
		<font color="#FF0000">}</font>
		<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
	<b><font color="#0000FF">case</font></b> kTypeText<font color="#990000">:</font>
		<font color="#FF0000">{</font>
			<font color="#008080">CFStringRef</font> cfstr <font color="#990000">=</font> mParam<font color="#990000">.</font><b><font color="#000000">GetStringFromValueCopy</font></b><font color="#990000">(&amp;</font>paramValue<font color="#990000">);</font>

			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">!(</font>mParam<font color="#990000">.</font><b><font color="#000000">ParamInfo</font></b><font color="#990000">().</font>flags <font color="#990000">&amp;</font> kAudioUnitParameterFlag_IsWritable<font color="#990000">)</font>			<i><font color="#9A1900">//READ ONLY PARAMS</font></i>
					<font color="#990000">&amp;&amp;</font> <font color="#990000">(</font>mParam<font color="#990000">.</font><b><font color="#000000">ParamInfo</font></b><font color="#990000">().</font>flags <font color="#990000">&amp;</font> kAudioUnitParameterFlag_IsReadable<font color="#990000">))</font> 
			<font color="#FF0000">{</font>
				<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mParam<font color="#990000">.</font><b><font color="#000000">GetParamTag</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
					<font color="#008080">CFMutableStringRef</font> str <font color="#990000">=</font> <b><font color="#000000">CFStringCreateMutableCopy</font></b><font color="#990000">(</font>NULL<font color="#990000">,</font> <font color="#993399">256</font><font color="#990000">,</font> cfstr<font color="#990000">);</font>
					<b><font color="#000000">CFRelease</font></b> <font color="#990000">(</font>cfstr<font color="#990000">);</font>
					<b><font color="#000000">CFStringAppend</font></b> <font color="#990000">(</font>str<font color="#990000">,</font> <b><font color="#000000">CFSTR</font></b><font color="#990000">(</font><font color="#FF0000">" "</font><font color="#990000">));</font>
					<b><font color="#000000">CFStringAppend</font></b> <font color="#990000">(</font>str<font color="#990000">,</font> mParam<font color="#990000">.</font><b><font color="#000000">GetParamTag</font></b><font color="#990000">());</font>
					cfstr <font color="#990000">=</font> str<font color="#990000">;</font>
				<font color="#FF0000">}</font>
			<font color="#FF0000">}</font>
			<b><font color="#000000">SetTextValue</font></b><font color="#990000">(</font>cfstr<font color="#990000">);</font>
			<b><font color="#000000">CFRelease</font></b> <font color="#990000">(</font>cfstr<font color="#990000">);</font>
		<font color="#FF0000">}</font>
		<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
	<font color="#FF0000">}</font>
	<font color="#990000">--</font>mInControlInitialization<font color="#990000">;</font>
<b><font color="#000080">#endif</font></b>
<font color="#FF0000">}</font>

<font color="#009900">void</font>	AUCarbonViewControl<font color="#990000">::</font><b><font color="#000000">ControlToParameter</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mInControlInitialization<font color="#990000">)</font>
		<b><font color="#0000FF">return</font></b><font color="#990000">;</font>

	<b><font color="#0000FF">switch</font></b> <font color="#990000">(</font>mType<font color="#990000">)</font> <font color="#FF0000">{</font>
	<b><font color="#0000FF">case</font></b> kTypeContinuous<font color="#990000">:</font>
		<font color="#FF0000">{</font>
			<font color="#009900">double</font> controlValue <font color="#990000">=</font> <b><font color="#000000">GetValueFract</font></b><font color="#990000">();</font>
			<font color="#008080">Float32</font> paramValue <font color="#990000">=</font> <b><font color="#000000">AUParameterValueFromLinear</font></b><font color="#990000">(</font>controlValue<font color="#990000">,</font> <font color="#990000">&amp;</font>mParam<font color="#990000">);</font>
			mParam<font color="#990000">.</font><b><font color="#000000">SetValue</font></b><font color="#990000">(</font>mListener<font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">,</font> paramValue<font color="#990000">);</font>
		<font color="#FF0000">}</font>
		<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
	<b><font color="#0000FF">case</font></b> kTypeDiscrete<font color="#990000">:</font>
		<font color="#FF0000">{</font>
			<font color="#009900">long</font> value <font color="#990000">=</font> <b><font color="#000000">GetValue</font></b><font color="#990000">();</font>
			
			<i><font color="#9A1900">// special case [1] -- Menus</font></i>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mParam<font color="#990000">.</font><b><font color="#000000">HasNamedParams</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
				<i><font color="#9A1900">// if we're dealing with menus they behave differently!</font></i>
				<i><font color="#9A1900">// becaue setting min and max doesn't work correctly for the control value</font></i>
				<i><font color="#9A1900">// first menu item always reports a control value of 1</font></i>
				<font color="#008080">ControlKind</font> ctrlKind<font color="#990000">;</font>
				<b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#000000">GetControlKind</font></b><font color="#990000">(</font>mControl<font color="#990000">,</font> <font color="#990000">&amp;</font>ctrlKind<font color="#990000">)</font> <font color="#990000">==</font> noErr<font color="#990000">)</font> <font color="#FF0000">{</font>
					<b><font color="#0000FF">if</font></b> <font color="#990000">((</font>ctrlKind<font color="#990000">.</font>kind <font color="#990000">==</font> kControlKindPopupArrow<font color="#990000">)</font> 
						<font color="#990000">||</font> <font color="#990000">(</font>ctrlKind<font color="#990000">.</font>kind <font color="#990000">==</font> kControlKindPopupButton<font color="#990000">))</font>				
					<font color="#FF0000">{</font>
						value <font color="#990000">=</font> value <font color="#990000">+</font> <font color="#009900">long</font><font color="#990000">(</font>mParam<font color="#990000">.</font><b><font color="#000000">ParamInfo</font></b><font color="#990000">().</font>minValue<font color="#990000">)</font> <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">;</font>
					<font color="#FF0000">}</font>
				<font color="#FF0000">}</font>
			<font color="#FF0000">}</font>
			
			<i><font color="#9A1900">// special case [2] -- Write-only boolean parameters</font></i>
			<font color="#008080">AudioUnitParameterInfo</font> AUPI <font color="#990000">=</font> mParam<font color="#990000">.</font><b><font color="#000000">ParamInfo</font></b><font color="#990000">();</font>
			
			<font color="#009900">bool</font> isWriteOnlyBoolParameter <font color="#990000">=</font> <font color="#990000">(</font>	<font color="#990000">(</font>AUPI<font color="#990000">.</font>unit <font color="#990000">==</font> kAudioUnitParameterUnit_Boolean<font color="#990000">)</font> <font color="#990000">&amp;&amp;</font>
												<font color="#990000">(</font>AUPI<font color="#990000">.</font>flags <font color="#990000">&amp;</font> kAudioUnitParameterFlag_IsWritable<font color="#990000">)</font> <font color="#990000">&amp;&amp;</font>
												<font color="#990000">!(</font>AUPI<font color="#990000">.</font>flags <font color="#990000">&amp;</font> kAudioUnitParameterFlag_IsReadable<font color="#990000">)</font>	<font color="#990000">);</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>isWriteOnlyBoolParameter<font color="#990000">)</font> <font color="#FF0000">{</font>
				value <font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">;</font>
			<font color="#FF0000">}</font>
			
			mParam<font color="#990000">.</font><b><font color="#000000">SetValue</font></b> <font color="#990000">(</font>mListener<font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">,</font> value<font color="#990000">);</font>
		<font color="#FF0000">}</font>
		<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
	<b><font color="#0000FF">case</font></b> kTypeText<font color="#990000">:</font>
		<font color="#FF0000">{</font>
			<font color="#008080">Float32</font> val <font color="#990000">=</font> mParam<font color="#990000">.</font><b><font color="#000000">GetValueFromString</font></b> <font color="#990000">(</font><b><font color="#000000">GetTextValue</font></b><font color="#990000">());</font>
			mParam<font color="#990000">.</font><b><font color="#000000">SetValue</font></b><font color="#990000">(</font>mListener<font color="#990000">,</font> <b><font color="#0000FF">this</font></b><font color="#990000">,</font> <font color="#990000">(</font>mParam<font color="#990000">.</font><b><font color="#000000">IsIndexedParam</font></b><font color="#990000">()</font> <font color="#990000">?</font> <font color="#990000">(</font><font color="#009900">int</font><font color="#990000">)</font>val <font color="#990000">:</font> val<font color="#990000">));</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mParam<font color="#990000">.</font><b><font color="#000000">ValuesHaveStrings</font></b><font color="#990000">())</font>
				<b><font color="#000000">ParameterToControl</font></b><font color="#990000">(</font>val<font color="#990000">);</font> <i><font color="#9A1900">//make sure we display the correct text (from the AU)</font></i>
		<font color="#FF0000">}</font>
		<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
	<font color="#FF0000">}</font>
<b><font color="#000080">#endif</font></b>
<font color="#FF0000">}</font>

<font color="#009900">void</font>	AUCarbonViewControl<font color="#990000">::</font><b><font color="#000000">SetValueFract</font></b><font color="#990000">(</font><font color="#009900">double</font> value<font color="#990000">)</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__
	<font color="#008080">SInt32</font> minimum <font color="#990000">=</font> <b><font color="#000000">GetControl32BitMinimum</font></b><font color="#990000">(</font>mControl<font color="#990000">);</font>
	<font color="#008080">SInt32</font> maximum <font color="#990000">=</font> <b><font color="#000000">GetControl32BitMaximum</font></b><font color="#990000">(</font>mControl<font color="#990000">);</font>
	<font color="#008080">SInt32</font> cval <font color="#990000">=</font> <b><font color="#000000">SInt32</font></b><font color="#990000">(</font>value <font color="#990000">*</font> <font color="#990000">(</font>maximum <font color="#990000">-</font> minimum<font color="#990000">)</font> <font color="#990000">+</font> minimum <font color="#990000">+</font> <font color="#993399">0.5</font><font color="#990000">);</font>
	<b><font color="#000000">SetControl32BitValue</font></b><font color="#990000">(</font>mControl<font color="#990000">,</font> cval<font color="#990000">);</font>
<i><font color="#9A1900">//	printf("set: value=%lf, min=%ld, max=%ld, ctl value=%ld\n", value, minimum, maximum, cval);</font></i>
<b><font color="#000080">#endif</font></b>
<font color="#FF0000">}</font>

<font color="#009900">double</font>	AUCarbonViewControl<font color="#990000">::</font><b><font color="#000000">GetValueFract</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__
	<font color="#008080">SInt32</font> minimum <font color="#990000">=</font> <b><font color="#000000">GetControl32BitMinimum</font></b><font color="#990000">(</font>mControl<font color="#990000">);</font>
	<font color="#008080">SInt32</font> maximum <font color="#990000">=</font> <b><font color="#000000">GetControl32BitMaximum</font></b><font color="#990000">(</font>mControl<font color="#990000">);</font>
	<font color="#008080">SInt32</font> cval <font color="#990000">=</font> <b><font color="#000000">GetControl32BitValue</font></b><font color="#990000">(</font>mControl<font color="#990000">);</font>
	<font color="#009900">double</font> result <font color="#990000">=</font> <font color="#009900">double</font><font color="#990000">(</font>cval <font color="#990000">-</font> minimum<font color="#990000">)</font> <font color="#990000">/</font> <font color="#009900">double</font><font color="#990000">(</font>maximum <font color="#990000">-</font> minimum<font color="#990000">);</font>
<i><font color="#9A1900">//	printf("get: min=%ld, max=%ld, value=%ld, result=%f\n", minimum, maximum, cval, result);</font></i>
	<b><font color="#0000FF">return</font></b> result<font color="#990000">;</font>
<b><font color="#000080">#else</font></b>
	<b><font color="#0000FF">return</font></b> <font color="#993399">0</font><font color="#990000">;</font>
<b><font color="#000080">#endif</font></b>
<font color="#FF0000">}</font>

<font color="#009900">void</font>	AUCarbonViewControl<font color="#990000">::</font><b><font color="#000000">SetTextValue</font></b><font color="#990000">(</font><font color="#008080">CFStringRef</font> cfstr<font color="#990000">)</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__
	<b><font color="#000000">verify_noerr</font></b><font color="#990000">(</font><b><font color="#000000">SetControlData</font></b><font color="#990000">(</font>mControl<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> kControlEditTextCFStringTag<font color="#990000">,</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>CFStringRef<font color="#990000">),</font> <font color="#990000">&amp;</font>cfstr<font color="#990000">));</font>
<b><font color="#000080">#endif</font></b>
<font color="#FF0000">}</font>

<font color="#008080">CFStringRef</font>	AUCarbonViewControl<font color="#990000">::</font><b><font color="#000000">GetTextValue</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__
	<font color="#008080">CFStringRef</font> cfstr<font color="#990000">;</font>
	<b><font color="#000000">verify_noerr</font></b><font color="#990000">(</font><b><font color="#000000">GetControlData</font></b><font color="#990000">(</font>mControl<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> kControlEditTextCFStringTag<font color="#990000">,</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>CFStringRef<font color="#990000">),</font> <font color="#990000">&amp;</font>cfstr<font color="#990000">,</font> NULL<font color="#990000">));</font>
	<b><font color="#0000FF">return</font></b> cfstr<font color="#990000">;</font>
<b><font color="#000080">#else</font></b>
	<b><font color="#0000FF">return</font></b> <b><font color="#000000">CFSTR</font></b><font color="#990000">(</font><font color="#FF0000">""</font><font color="#990000">);</font>
<b><font color="#000080">#endif</font></b>
<font color="#FF0000">}</font>

<font color="#009900">void</font>	AUCarbonViewControl<font color="#990000">::</font><b><font color="#000000">SetValue</font></b><font color="#990000">(</font><font color="#009900">long</font> value<font color="#990000">)</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__
	<b><font color="#000000">SetControl32BitValue</font></b><font color="#990000">(</font>mControl<font color="#990000">,</font> value<font color="#990000">);</font>
<b><font color="#000080">#endif</font></b>
<font color="#FF0000">}</font>

<font color="#009900">long</font>	AUCarbonViewControl<font color="#990000">::</font><b><font color="#000000">GetValue</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__
	<b><font color="#0000FF">return</font></b> <b><font color="#000000">GetControl32BitValue</font></b><font color="#990000">(</font>mControl<font color="#990000">);</font>
<b><font color="#000080">#else</font></b>
	<b><font color="#0000FF">return</font></b> <font color="#993399">0</font><font color="#990000">;</font>
<b><font color="#000080">#endif</font></b>
<font color="#FF0000">}</font>

<i><font color="#9A1900">/* Notes on event handling </font></i>
<i><font color="#9A1900">	</font></i>
<i><font color="#9A1900">	Button (Click and release on button)</font></i>
<i><font color="#9A1900">		kEventControlClick received</font></i>
<i><font color="#9A1900">		kEventControlTrack received</font></i>
<i><font color="#9A1900">		kEventControlValueFieldChanged received</font></i>
<i><font color="#9A1900">		kEventControlHit received</font></i>
<i><font color="#9A1900">	</font></i>
<i><font color="#9A1900">	Button (Click and release outside of button bounds)</font></i>
<i><font color="#9A1900">		kEventControlClick received</font></i>
<i><font color="#9A1900">		kEventControlTrack received</font></i>
<i><font color="#9A1900">	</font></i>
<i><font color="#9A1900">	Slider (Click, drag, and release)</font></i>
<i><font color="#9A1900">		kEventControlClick received</font></i>
<i><font color="#9A1900">		kEventControlTrack received</font></i>
<i><font color="#9A1900">		kEventControlValueFieldChanged received</font></i>
<i><font color="#9A1900">		kEventControlValueFieldChanged received</font></i>
<i><font color="#9A1900">		kEventControlHit received</font></i>
<i><font color="#9A1900">		</font></i>
<i><font color="#9A1900">	Slider (Click, release without changing value)</font></i>
<i><font color="#9A1900">		kEventControlClick received</font></i>
<i><font color="#9A1900">		kEventControlTrack received</font></i>
<i><font color="#9A1900">*/</font></i>
<font color="#009900">bool</font>	AUCarbonViewControl<font color="#990000">::</font><b><font color="#000000">HandleEvent</font></b><font color="#990000">(</font><font color="#008080">EventHandlerCallRef</font> inHandlerRef<font color="#990000">,</font> <font color="#008080">EventRef</font> event<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<font color="#008080">UInt32</font> eclass <font color="#990000">=</font> <b><font color="#000000">GetEventClass</font></b><font color="#990000">(</font>event<font color="#990000">);</font>
	<font color="#008080">UInt32</font> ekind <font color="#990000">=</font> <b><font color="#000000">GetEventKind</font></b><font color="#990000">(</font>event<font color="#990000">);</font>
	<font color="#008080">ControlRef</font> control<font color="#990000">;</font>
	<font color="#009900">bool</font>		handled <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
	
	<b><font color="#0000FF">switch</font></b> <font color="#990000">(</font>eclass<font color="#990000">)</font> <font color="#FF0000">{</font>
		<b><font color="#0000FF">case</font></b> kEventClassControl<font color="#990000">:</font>
		<font color="#FF0000">{</font>
			<font color="#008080">AudioUnitParameterInfo</font> AUPI <font color="#990000">=</font> mParam<font color="#990000">.</font><b><font color="#000000">ParamInfo</font></b><font color="#990000">();</font>
			
			<font color="#009900">bool</font> isWriteOnlyBoolParameter <font color="#990000">=</font> <font color="#990000">(</font>	<font color="#990000">(</font>AUPI<font color="#990000">.</font>unit <font color="#990000">==</font> kAudioUnitParameterUnit_Boolean<font color="#990000">)</font> <font color="#990000">&amp;&amp;</font>
												<font color="#990000">(</font>AUPI<font color="#990000">.</font>flags <font color="#990000">&amp;</font> kAudioUnitParameterFlag_IsWritable<font color="#990000">)</font> <font color="#990000">&amp;&amp;</font>
												<font color="#990000">!(</font>AUPI<font color="#990000">.</font>flags <font color="#990000">&amp;</font> kAudioUnitParameterFlag_IsReadable<font color="#990000">)</font>	<font color="#990000">);</font>
			
			<b><font color="#0000FF">switch</font></b> <font color="#990000">(</font>ekind<font color="#990000">)</font> <font color="#FF0000">{</font>
				<b><font color="#0000FF">case</font></b> kEventControlSetFocusPart<font color="#990000">:</font>	<i><font color="#9A1900">// tab</font></i>
					handled <font color="#990000">=</font> <font color="#990000">!</font>handled<font color="#990000">;</font>		<i><font color="#9A1900">// fall through to next case</font></i>
					mLastControl <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">;</font>
				<b><font color="#0000FF">case</font></b> kEventControlValueFieldChanged<font color="#990000">:</font>
					<b><font color="#000000">GetEventParameter</font></b><font color="#990000">(</font>event<font color="#990000">,</font> kEventParamDirectObject<font color="#990000">,</font> typeControlRef<font color="#990000">,</font> NULL<font color="#990000">,</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>ControlRef<font color="#990000">),</font> NULL<font color="#990000">,</font> <font color="#990000">&amp;</font>control<font color="#990000">);</font>
					<b><font color="#000000">verify</font></b><font color="#990000">(</font>control <font color="#990000">==</font> mControl<font color="#990000">);</font>
					<b><font color="#000000">ControlToParameter</font></b><font color="#990000">();</font>
					<b><font color="#0000FF">return</font></b> handled<font color="#990000">;</font>			
				<b><font color="#0000FF">case</font></b> kEventControlClick<font color="#990000">:</font>
					<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>isWriteOnlyBoolParameter<font color="#990000">)</font> <font color="#FF0000">{</font>
						<b><font color="#000000">GetEventParameter</font></b><font color="#990000">(</font>event<font color="#990000">,</font> kEventParamDirectObject<font color="#990000">,</font> typeControlRef<font color="#990000">,</font> NULL<font color="#990000">,</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>ControlRef<font color="#990000">),</font> NULL<font color="#990000">,</font> <font color="#990000">&amp;</font>control<font color="#990000">);</font>
						<b><font color="#000000">verify</font></b><font color="#990000">(</font>control <font color="#990000">==</font> mControl<font color="#990000">);</font>
						<b><font color="#000000">ControlToParameter</font></b><font color="#990000">();</font>
					<font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mLastControl <font color="#990000">!=</font> <b><font color="#0000FF">this</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
						<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mLastControl <font color="#990000">!=</font> NULL<font color="#990000">)</font> <font color="#FF0000">{</font>
							mLastControl<font color="#990000">-&gt;</font><b><font color="#000000">Update</font></b><font color="#990000">(</font><b><font color="#0000FF">false</font></b><font color="#990000">);</font>
						<font color="#FF0000">}</font>
						mLastControl <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">;</font>	
					<font color="#FF0000">}</font>
					mOwnerView<font color="#990000">-&gt;</font><b><font color="#000000">TellListener</font></b><font color="#990000">(</font>mParam<font color="#990000">,</font> kAudioUnitCarbonViewEvent_MouseDownInControl<font color="#990000">,</font> NULL<font color="#990000">);</font>
					<b><font color="#0000FF">break</font></b><font color="#990000">;</font>	<i><font color="#9A1900">// don't return true, continue normal processing</font></i>
				<b><font color="#0000FF">case</font></b> kEventControlHit<font color="#990000">:</font>
					<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mLastControl <font color="#990000">!=</font> <b><font color="#0000FF">this</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
						<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mLastControl <font color="#990000">!=</font> NULL<font color="#990000">)</font>
							mLastControl<font color="#990000">-&gt;</font><b><font color="#000000">Update</font></b><font color="#990000">(</font><b><font color="#0000FF">false</font></b><font color="#990000">);</font>
						mLastControl <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">;</font>	
					<font color="#FF0000">}</font> 
					mOwnerView<font color="#990000">-&gt;</font><b><font color="#000000">TellListener</font></b><font color="#990000">(</font>mParam<font color="#990000">,</font> kAudioUnitCarbonViewEvent_MouseUpInControl<font color="#990000">,</font> NULL<font color="#990000">);</font>
					<b><font color="#0000FF">break</font></b><font color="#990000">;</font>	<i><font color="#9A1900">// don't return true, continue normal processing</font></i>
				<b><font color="#0000FF">case</font></b> kEventControlTrack<font color="#990000">:</font>		
					<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mLastControl <font color="#990000">!=</font> <b><font color="#0000FF">this</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
						<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mLastControl <font color="#990000">!=</font> NULL<font color="#990000">)</font>
							mLastControl<font color="#990000">-&gt;</font><b><font color="#000000">Update</font></b><font color="#990000">(</font><b><font color="#0000FF">false</font></b><font color="#990000">);</font>
						mLastControl <font color="#990000">=</font> <b><font color="#0000FF">this</font></b><font color="#990000">;</font>	
					<font color="#FF0000">}</font>
					
					<b><font color="#000000">CallNextEventHandler</font></b><font color="#990000">(</font>inHandlerRef<font color="#990000">,</font> event<font color="#990000">);</font>
					<b><font color="#000000">ControlToParameter</font></b><font color="#990000">();</font>						<i><font color="#9A1900">// new code</font></i>
					mOwnerView<font color="#990000">-&gt;</font><b><font color="#000000">TellListener</font></b><font color="#990000">(</font>mParam<font color="#990000">,</font> kAudioUnitCarbonViewEvent_MouseUpInControl<font color="#990000">,</font> NULL<font color="#990000">);</font>
					<i><font color="#9A1900">// old code:</font></i>
					<i><font color="#9A1900">//		break;	// don't return true, continue normal processing</font></i>

					<b><font color="#0000FF">return</font></b> handled<font color="#990000">;</font>	<i><font color="#9A1900">// don't return true, continue normal processing</font></i>
			<font color="#FF0000">}</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font>
	<b><font color="#0000FF">return</font></b> <font color="#990000">!</font>handled<font color="#990000">;</font>
<font color="#FF0000">}</font>

<b><font color="#0000FF">pascal</font></b> <font color="#009900">void</font>	AUCarbonViewControl<font color="#990000">::</font><b><font color="#000000">SliderTrackProc</font></b><font color="#990000">(</font><font color="#008080">ControlRef</font> theControl<font color="#990000">,</font> <font color="#008080">ControlPartCode</font> partCode<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<i><font color="#9A1900">// this doesn't need to actually do anything</font></i>
<i><font color="#9A1900">//	AUCarbonViewControl *This = (AUCarbonViewControl *)GetControlReference(theControl);</font></i>
<font color="#FF0000">}</font>

<b><font color="#0000FF">pascal</font></b> <font color="#008080">ControlKeyFilterResult</font>	AUCarbonViewControl<font color="#990000">::</font><b><font color="#000000">StdKeyFilterCallback</font></b><font color="#990000">(</font><font color="#008080">ControlRef</font> theControl<font color="#990000">,</font> 
												<font color="#008080">SInt16</font> <font color="#990000">*</font>keyCode<font color="#990000">,</font> <font color="#008080">SInt16</font> <font color="#990000">*</font>charCode<font color="#990000">,</font> 
												<font color="#008080">EventModifiers</font> <font color="#990000">*</font>modifiers<font color="#990000">)</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__
	<font color="#008080">SInt16</font> c <font color="#990000">=</font> <font color="#990000">*</font>charCode<font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>c <font color="#990000">&gt;=</font> <font color="#FF0000">' '</font> <font color="#990000">||</font> c <font color="#990000">==</font> <font color="#FF0000">'</font><font color="#CC33CC">\b</font><font color="#FF0000">'</font> <font color="#990000">||</font> c <font color="#990000">==</font> <font color="#993399">0x7F</font> <font color="#990000">||</font> <font color="#990000">(</font>c <font color="#990000">&gt;=</font> <font color="#993399">0x1c</font> <font color="#990000">&amp;&amp;</font> c <font color="#990000">&lt;=</font> <font color="#993399">0x1f</font><font color="#990000">)</font> <font color="#990000">||</font> c <font color="#990000">==</font> <font color="#FF0000">'</font><font color="#CC33CC">\t</font><font color="#FF0000">'</font><font color="#990000">)</font>
		<b><font color="#0000FF">return</font></b> kControlKeyFilterPassKey<font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>c <font color="#990000">==</font> <font color="#FF0000">'</font><font color="#CC33CC">\r</font><font color="#FF0000">'</font> <font color="#990000">||</font> c <font color="#990000">==</font> <font color="#993399">3</font><font color="#990000">)</font> <font color="#FF0000">{</font>	<i><font color="#9A1900">// return or Enter</font></i>
		<font color="#008080">AUCarbonViewControl</font> <font color="#990000">*</font>This <font color="#990000">=</font> <font color="#990000">(</font>AUCarbonViewControl <font color="#990000">*)</font><b><font color="#000000">GetControlReference</font></b><font color="#990000">(</font>theControl<font color="#990000">);</font>
		<font color="#008080">ControlEditTextSelectionRec</font> sel <font color="#990000">=</font> <font color="#FF0000">{</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">32767</font> <font color="#FF0000">}</font><font color="#990000">;</font>
		<b><font color="#000000">SetControlData</font></b><font color="#990000">(</font>This<font color="#990000">-&gt;</font>mControl<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> kControlEditTextSelectionTag<font color="#990000">,</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>sel<font color="#990000">),</font> <font color="#990000">&amp;</font>sel<font color="#990000">);</font>
		This<font color="#990000">-&gt;</font><b><font color="#000000">ControlToParameter</font></b><font color="#990000">();</font>
	<font color="#FF0000">}</font>
<b><font color="#000080">#endif</font></b>
	<b><font color="#0000FF">return</font></b> kControlKeyFilterBlockKey<font color="#990000">;</font>
<font color="#FF0000">}</font>

<b><font color="#0000FF">pascal</font></b> <font color="#008080">ControlKeyFilterResult</font>	AUCarbonViewControl<font color="#990000">::</font><b><font color="#000000">NumericKeyFilterCallback</font></b><font color="#990000">(</font><font color="#008080">ControlRef</font> theControl<font color="#990000">,</font> 
												<font color="#008080">SInt16</font> <font color="#990000">*</font>keyCode<font color="#990000">,</font> <font color="#008080">SInt16</font> <font color="#990000">*</font>charCode<font color="#990000">,</font> 
												<font color="#008080">EventModifiers</font> <font color="#990000">*</font>modifiers<font color="#990000">)</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__
	<font color="#008080">SInt16</font> c <font color="#990000">=</font> <font color="#990000">*</font>charCode<font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#000000">isdigit</font></b><font color="#990000">(</font>c<font color="#990000">)</font> <font color="#990000">||</font> c <font color="#990000">==</font> <font color="#FF0000">'+'</font> <font color="#990000">||</font> c <font color="#990000">==</font> <font color="#FF0000">'-'</font> <font color="#990000">||</font> c <font color="#990000">==</font> <font color="#FF0000">'.'</font> <font color="#990000">||</font> c <font color="#990000">==</font> <font color="#FF0000">'</font><font color="#CC33CC">\b</font><font color="#FF0000">'</font> <font color="#990000">||</font> c <font color="#990000">==</font> <font color="#993399">0x7F</font> <font color="#990000">||</font> <font color="#990000">(</font>c <font color="#990000">&gt;=</font> <font color="#993399">0x1c</font> <font color="#990000">&amp;&amp;</font> c <font color="#990000">&lt;=</font> <font color="#993399">0x1f</font><font color="#990000">)</font>
	<font color="#990000">||</font> c <font color="#990000">==</font> <font color="#FF0000">'</font><font color="#CC33CC">\t</font><font color="#FF0000">'</font><font color="#990000">)</font>
		<b><font color="#0000FF">return</font></b> kControlKeyFilterPassKey<font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>c <font color="#990000">==</font> <font color="#FF0000">'</font><font color="#CC33CC">\r</font><font color="#FF0000">'</font> <font color="#990000">||</font> c <font color="#990000">==</font> <font color="#993399">3</font><font color="#990000">)</font> <font color="#FF0000">{</font>	<i><font color="#9A1900">// return or Enter</font></i>
		<font color="#008080">AUCarbonViewControl</font> <font color="#990000">*</font>This <font color="#990000">=</font> <font color="#990000">(</font>AUCarbonViewControl <font color="#990000">*)</font><b><font color="#000000">GetControlReference</font></b><font color="#990000">(</font>theControl<font color="#990000">);</font>
		<font color="#008080">ControlEditTextSelectionRec</font> sel <font color="#990000">=</font> <font color="#FF0000">{</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">32767</font> <font color="#FF0000">}</font><font color="#990000">;</font>
		<b><font color="#000000">SetControlData</font></b><font color="#990000">(</font>This<font color="#990000">-&gt;</font>mControl<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> kControlEditTextSelectionTag<font color="#990000">,</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>sel<font color="#990000">),</font> <font color="#990000">&amp;</font>sel<font color="#990000">);</font>
		This<font color="#990000">-&gt;</font><b><font color="#000000">ControlToParameter</font></b><font color="#990000">();</font>
	<font color="#FF0000">}</font>
<b><font color="#000080">#endif</font></b>
	<b><font color="#0000FF">return</font></b> kControlKeyFilterBlockKey<font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#008080">Boolean</font>	AUCarbonViewControl<font color="#990000">::</font><b><font color="#000000">SizeControlToFit</font></b><font color="#990000">(</font><font color="#008080">ControlRef</font> inControl<font color="#990000">,</font> <font color="#008080">SInt16</font> <font color="#990000">*</font>outWidth<font color="#990000">,</font> <font color="#008080">SInt16</font> <font color="#990000">*</font>outHeight<font color="#990000">)</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inControl <font color="#990000">==</font> <font color="#993399">0</font><font color="#990000">)</font> <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
	
	<font color="#008080">Boolean</font> bValue <font color="#990000">=</font> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
	<i><font color="#9A1900">// this only works on text controls -- returns an error for other controls, but doesn't do anything,</font></i>
	<i><font color="#9A1900">// so the error is irrelevant</font></i>
	<b><font color="#000000">SetControlData</font></b><font color="#990000">(</font>inControl<font color="#990000">,</font> kControlEntireControl<font color="#990000">,</font> <font color="#FF0000">'stim'</font> <i><font color="#9A1900">/* kControlStaticTextIsMultilineTag */</font></i><font color="#990000">,</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>Boolean<font color="#990000">),</font> <font color="#990000">&amp;</font>bValue<font color="#990000">);</font>
	
	<font color="#008080">SInt16</font> baseLineOffset<font color="#990000">;</font>
	<font color="#008080">Rect</font> bestRect<font color="#990000">;</font>
	<font color="#008080">OSErr</font> err <font color="#990000">=</font> <b><font color="#000000">GetBestControlRect</font></b><font color="#990000">(</font>inControl<font color="#990000">,</font> <font color="#990000">&amp;</font>bestRect<font color="#990000">,</font> <font color="#990000">&amp;</font>baseLineOffset<font color="#990000">);</font>  
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>err <font color="#990000">!=</font> noErr<font color="#990000">)</font> <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
	
	<font color="#009900">int</font> width <font color="#990000">=</font> <font color="#990000">(</font>bestRect<font color="#990000">.</font>right <font color="#990000">-</font> bestRect<font color="#990000">.</font>left<font color="#990000">)</font> <font color="#990000">+</font> <font color="#993399">1</font><font color="#990000">;</font>
	<font color="#009900">int</font> height <font color="#990000">=</font> <font color="#990000">(</font>bestRect<font color="#990000">.</font>bottom <font color="#990000">-</font> bestRect<font color="#990000">.</font>top<font color="#990000">)</font> <font color="#990000">+</font> <font color="#993399">1</font><font color="#990000">;</font>
	
	<font color="#008080">Rect</font> boundsRect<font color="#990000">;</font>
	<b><font color="#000000">GetControlBounds</font></b> <font color="#990000">(</font>inControl<font color="#990000">,</font> <font color="#990000">&amp;</font>boundsRect<font color="#990000">);</font>
	
	<font color="#008080">Rect</font> newRect<font color="#990000">;</font>
	newRect<font color="#990000">.</font>top <font color="#990000">=</font> boundsRect<font color="#990000">.</font>top<font color="#990000">;</font>
	newRect<font color="#990000">.</font>bottom <font color="#990000">=</font> newRect<font color="#990000">.</font>top <font color="#990000">+</font> height<font color="#990000">;</font>
	newRect<font color="#990000">.</font>left <font color="#990000">=</font> boundsRect<font color="#990000">.</font>left<font color="#990000">;</font>
	newRect<font color="#990000">.</font>right <font color="#990000">=</font> newRect<font color="#990000">.</font>left <font color="#990000">+</font> width<font color="#990000">;</font>
	
	<b><font color="#000000">SetControlBounds</font></b> <font color="#990000">(</font>inControl<font color="#990000">,</font> <font color="#990000">&amp;</font>newRect<font color="#990000">);</font>
	
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outWidth<font color="#990000">)</font>
		<font color="#990000">*</font>outWidth <font color="#990000">=</font> width<font color="#990000">;</font>
	
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outHeight<font color="#990000">)</font>
		<font color="#990000">*</font>outHeight <font color="#990000">=</font> height<font color="#990000">;</font>
<b><font color="#000080">#endif</font></b>	
	<b><font color="#0000FF">return</font></b> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<b><font color="#000080">#pragma</font></b> <font color="#008080">mark</font> ___AUPropertyControl
<font color="#009900">bool</font>	AUPropertyControl<font color="#990000">::</font><b><font color="#000000">HandleEvent</font></b><font color="#990000">(</font><font color="#008080">EventHandlerCallRef</font> inHandlerRef<font color="#990000">,</font> <font color="#008080">EventRef</font> event<font color="#990000">)</font>
<font color="#FF0000">{</font>	
	<font color="#008080">UInt32</font> eclass <font color="#990000">=</font> <b><font color="#000000">GetEventClass</font></b><font color="#990000">(</font>event<font color="#990000">);</font>
	<font color="#008080">UInt32</font> ekind <font color="#990000">=</font> <b><font color="#000000">GetEventKind</font></b><font color="#990000">(</font>event<font color="#990000">);</font>
	<b><font color="#0000FF">switch</font></b> <font color="#990000">(</font>eclass<font color="#990000">)</font> <font color="#FF0000">{</font>
	<b><font color="#0000FF">case</font></b> kEventClassControl<font color="#990000">:</font>
		<b><font color="#0000FF">switch</font></b> <font color="#990000">(</font>ekind<font color="#990000">)</font> <font color="#FF0000">{</font>
		<b><font color="#0000FF">case</font></b> kEventControlValueFieldChanged<font color="#990000">:</font>
			<b><font color="#000000">HandleControlChange</font></b><font color="#990000">();</font>
			<b><font color="#0000FF">return</font></b> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>	<i><font color="#9A1900">// handled</font></i>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font>

	<b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>	AUPropertyControl<font color="#990000">::</font><b><font color="#000000">RegisterEvents</font></b> <font color="#990000">()</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__
	<font color="#008080">EventTypeSpec</font> events<font color="#990000">[]</font> <font color="#990000">=</font> <font color="#FF0000">{</font>
		<font color="#FF0000">{</font> kEventClassControl<font color="#990000">,</font> kEventControlValueFieldChanged <font color="#FF0000">}</font>	<i><font color="#9A1900">// N.B. OS X only</font></i>
	<font color="#FF0000">}</font><font color="#990000">;</font>
	
	<b><font color="#000000">WantEventTypes</font></b><font color="#990000">(</font><b><font color="#000000">GetControlEventTarget</font></b><font color="#990000">(</font>mControl<font color="#990000">),</font> <b><font color="#000000">GetEventTypeCount</font></b><font color="#990000">(</font>events<font color="#990000">),</font> events<font color="#990000">);</font>
<b><font color="#000080">#endif</font></b>
<font color="#FF0000">}</font>

<font color="#009900">void</font>	AUPropertyControl<font color="#990000">::</font><b><font color="#000000">EmbedControl</font></b> <font color="#990000">(</font><font color="#008080">ControlRef</font> theControl<font color="#990000">)</font> 
<font color="#FF0000">{</font> 
	mView<font color="#990000">-&gt;</font><b><font color="#000000">EmbedControl</font></b> <font color="#990000">(</font>theControl<font color="#990000">);</font> 
<font color="#FF0000">}</font>

<font color="#008080">WindowRef</font> 	AUPropertyControl<font color="#990000">::</font><b><font color="#000000">GetCarbonWindow</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">return</font></b> mView<font color="#990000">-&gt;</font><b><font color="#000000">GetCarbonWindow</font></b><font color="#990000">();</font>
<font color="#FF0000">}</font>

<b><font color="#000080">#pragma</font></b> <font color="#008080">mark</font> ___AUVPreset
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__
<b><font color="#0000FF">static</font></b> <font color="#008080">CFStringRef</font> kStringFactoryPreset <font color="#990000">=</font> kAUViewLocalizedStringKey_FactoryPreset<font color="#990000">;</font>
<b><font color="#0000FF">static</font></b> <font color="#009900">bool</font> sAUVPresetLocalized <font color="#990000">=</font> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
<b><font color="#000080">#endif</font></b>

AUVPresets<font color="#990000">::</font><b><font color="#000000">AUVPresets</font></b> <font color="#990000">(</font>AUCarbonViewBase<font color="#990000">*</font> 		inParentView<font color="#990000">,</font> 
						CFArrayRef<font color="#990000">&amp;</font> 			inPresets<font color="#990000">,</font>
						<font color="#008080">Point</font> 					inLocation<font color="#990000">,</font> 
						<font color="#009900">int</font> 					nameWidth<font color="#990000">,</font> 
						<font color="#009900">int</font> 					controlWidth<font color="#990000">,</font> 
						ControlFontStyleRec <font color="#990000">&amp;</font> 	inFontStyle<font color="#990000">)</font>
	<font color="#990000">:</font> <b><font color="#000000">AUPropertyControl</font></b> <font color="#990000">(</font>inParentView<font color="#990000">),</font>
	  <b><font color="#000000">mPresets</font></b> <font color="#990000">(</font>inPresets<font color="#990000">),</font>
	  <b><font color="#000000">mView</font></b> <font color="#990000">(</font>inParentView<font color="#990000">)</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__
	<font color="#008080">Rect</font> r<font color="#990000">;</font>
	
	<i><font color="#9A1900">// ok we now have an array of factory presets</font></i>
	<i><font color="#9A1900">// get their strings and display them</font></i>

	r<font color="#990000">.</font>top <font color="#990000">=</font> inLocation<font color="#990000">.</font>v<font color="#990000">;</font>		r<font color="#990000">.</font>bottom <font color="#990000">=</font> r<font color="#990000">.</font>top<font color="#990000">;</font>
	r<font color="#990000">.</font>left <font color="#990000">=</font> inLocation<font color="#990000">.</font>h<font color="#990000">;</font>		r<font color="#990000">.</font>right <font color="#990000">=</font> r<font color="#990000">.</font>left<font color="#990000">;</font>
	
    <i><font color="#9A1900">// localize as necessary</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>sAUVPresetLocalized<font color="#990000">)</font> <font color="#FF0000">{</font>
        <font color="#008080">CFBundleRef</font> mainBundle <font color="#990000">=</font> <b><font color="#000000">CFBundleGetBundleWithIdentifier</font></b><font color="#990000">(</font>kLocalizedStringBundle_AUView<font color="#990000">);</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mainBundle<font color="#990000">)</font> <font color="#FF0000">{</font>
            kStringFactoryPreset <font color="#990000">=</font>	<b><font color="#000000">CFCopyLocalizedStringFromTableInBundle</font></b><font color="#990000">(</font>
                                        kAUViewLocalizedStringKey_FactoryPreset<font color="#990000">,</font> kLocalizedStringTable_AUView<font color="#990000">,</font>
                                        mainBundle<font color="#990000">,</font> <b><font color="#000000">CFSTR</font></b><font color="#990000">(</font><font color="#FF0000">"FactoryPreset title string"</font><font color="#990000">));</font>
            sAUVPresetLocalized <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
        <font color="#FF0000">}</font>
    <font color="#FF0000">}</font>
    
    <i><font color="#9A1900">// create localized title string</font></i>
    <font color="#008080">CFMutableStringRef</font> factoryPresetsTitle <font color="#990000">=</font> <b><font color="#000000">CFStringCreateMutable</font></b><font color="#990000">(</font>NULL<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">);</font>
    <b><font color="#000000">CFStringAppend</font></b><font color="#990000">(</font>factoryPresetsTitle<font color="#990000">,</font> kStringFactoryPreset<font color="#990000">);</font>
    <b><font color="#000000">CFStringAppend</font></b><font color="#990000">(</font>factoryPresetsTitle<font color="#990000">,</font> kAUViewUnlocalizedString_TitleSeparator<font color="#990000">);</font>
    
	<font color="#008080">ControlRef</font> theControl<font color="#990000">;</font>
    <b><font color="#000000">verify_noerr</font></b><font color="#990000">(</font><b><font color="#000000">CreateStaticTextControl</font></b><font color="#990000">(</font>mView<font color="#990000">-&gt;</font><b><font color="#000000">GetCarbonWindow</font></b><font color="#990000">(),</font> <font color="#990000">&amp;</font>r<font color="#990000">,</font> factoryPresetsTitle<font color="#990000">,</font> <font color="#990000">&amp;</font>inFontStyle<font color="#990000">,</font> <font color="#990000">&amp;</font>theControl<font color="#990000">));</font>
	<font color="#008080">SInt16</font> width <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	AUCarbonViewControl<font color="#990000">::</font><b><font color="#000000">SizeControlToFit</font></b><font color="#990000">(</font>theControl<font color="#990000">,</font> <font color="#990000">&amp;</font>width<font color="#990000">,</font> <font color="#990000">&amp;</font>mHeight<font color="#990000">);</font>
    <b><font color="#000000">CFRelease</font></b><font color="#990000">(</font>factoryPresetsTitle<font color="#990000">);</font>
	<b><font color="#000000">EmbedControl</font></b><font color="#990000">(</font>theControl<font color="#990000">);</font>
	
	r<font color="#990000">.</font>top <font color="#990000">-=</font> <font color="#993399">2</font><font color="#990000">;</font>
	r<font color="#990000">.</font>left <font color="#990000">+=</font> width <font color="#990000">+</font> <font color="#993399">10</font><font color="#990000">;</font>
	r<font color="#990000">.</font>right <font color="#990000">=</font> r<font color="#990000">.</font>left<font color="#990000">;</font>
	r<font color="#990000">.</font>bottom <font color="#990000">=</font> r<font color="#990000">.</font>top<font color="#990000">;</font>
	
	<b><font color="#000000">verify_noerr</font></b><font color="#990000">(</font><b><font color="#000000">CreatePopupButtonControl</font></b> <font color="#990000">(</font>	mView<font color="#990000">-&gt;</font><b><font color="#000000">GetCarbonWindow</font></b><font color="#990000">(),</font> <font color="#990000">&amp;</font>r<font color="#990000">,</font> NULL<font color="#990000">,</font> 
											<font color="#990000">-</font><font color="#993399">12345</font><font color="#990000">,</font>	<i><font color="#9A1900">// DON'T GET MENU FROM RESOURCE mMenuID,!!!</font></i>
											FALSE<font color="#990000">,</font>	<i><font color="#9A1900">// variableWidth, </font></i>
											<font color="#993399">0</font><font color="#990000">,</font>		<i><font color="#9A1900">// titleWidth, </font></i>
											<font color="#993399">0</font><font color="#990000">,</font>		<i><font color="#9A1900">// titleJustification, </font></i>
											<font color="#993399">0</font><font color="#990000">,</font>		<i><font color="#9A1900">// titleStyle, </font></i>
											<font color="#990000">&amp;</font>mControl<font color="#990000">));</font>
	
	<font color="#008080">MenuRef</font> menuRef<font color="#990000">;</font>
	<b><font color="#000000">verify_noerr</font></b><font color="#990000">(</font><b><font color="#000000">CreateNewMenu</font></b><font color="#990000">(</font><font color="#993399">1</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#990000">&amp;</font>menuRef<font color="#990000">));</font>
	
	<font color="#009900">int</font> numPresets <font color="#990000">=</font> <b><font color="#000000">CFArrayGetCount</font></b><font color="#990000">(</font>mPresets<font color="#990000">);</font>
	
	<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#009900">int</font> i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> numPresets<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font>
	<font color="#FF0000">{</font>
		AUPreset<font color="#990000">*</font> preset <font color="#990000">=</font> <font color="#990000">(</font>AUPreset<font color="#990000">*)</font> <b><font color="#000000">CFArrayGetValueAtIndex</font></b> <font color="#990000">(</font>mPresets<font color="#990000">,</font> i<font color="#990000">);</font>
		<b><font color="#000000">verify_noerr</font></b><font color="#990000">(</font><b><font color="#000000">AppendMenuItemTextWithCFString</font></b> <font color="#990000">(</font>menuRef<font color="#990000">,</font> preset<font color="#990000">-&gt;</font>presetName<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">));</font>
	<font color="#FF0000">}</font>
	
	<b><font color="#000000">verify_noerr</font></b><font color="#990000">(</font><b><font color="#000000">SetControlData</font></b><font color="#990000">(</font>mControl<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> kControlPopupButtonMenuRefTag<font color="#990000">,</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>menuRef<font color="#990000">),</font> <font color="#990000">&amp;</font>menuRef<font color="#990000">));</font>
	<b><font color="#000000">verify_noerr</font></b> <font color="#990000">(</font><b><font color="#000000">SetControlFontStyle</font></b> <font color="#990000">(</font>mControl<font color="#990000">,</font> <font color="#990000">&amp;</font>inFontStyle<font color="#990000">));</font>
	
	<b><font color="#000000">SetControl32BitMaximum</font></b> <font color="#990000">(</font>mControl<font color="#990000">,</font> numPresets<font color="#990000">);</font>
	
	<i><font color="#9A1900">// size popup</font></i>
	<font color="#008080">SInt16</font> height <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	
	AUCarbonViewControl<font color="#990000">::</font><b><font color="#000000">SizeControlToFit</font></b><font color="#990000">(</font>mControl<font color="#990000">,</font> <font color="#990000">&amp;</font>width<font color="#990000">,</font> <font color="#990000">&amp;</font>height<font color="#990000">);</font>
	
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>height <font color="#990000">&gt;</font> mHeight<font color="#990000">)</font> mHeight <font color="#990000">=</font> height<font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mHeight <font color="#990000">&lt;</font> <font color="#993399">0</font><font color="#990000">)</font> mHeight <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	
	<i><font color="#9A1900">// find which menu item is the Default preset</font></i>
	<font color="#008080">UInt32</font> propertySize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>AUPreset<font color="#990000">);</font>
	<font color="#008080">AUPreset</font> defaultPreset<font color="#990000">;</font>
	<font color="#008080">OSStatus</font> result <font color="#990000">=</font> <b><font color="#000000">AudioUnitGetProperty</font></b> <font color="#990000">(</font>mView<font color="#990000">-&gt;</font><b><font color="#000000">GetEditAudioUnit</font></b><font color="#990000">(),</font> 
									kAudioUnitProperty_PresentPreset<font color="#990000">,</font>
									kAudioUnitScope_Global<font color="#990000">,</font> 
									<font color="#993399">0</font><font color="#990000">,</font> 
									<font color="#990000">&amp;</font>defaultPreset<font color="#990000">,</font> 
									<font color="#990000">&amp;</font>propertySize<font color="#990000">);</font>
	
	mPropertyID <font color="#990000">=</font> kAudioUnitProperty_PresentPreset<font color="#990000">;</font>
<b><font color="#000080">#endif</font></b>	
<b><font color="#000080">#ifndef</font></b> __LP64__
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>result <font color="#990000">!=</font> noErr<font color="#990000">)</font> <font color="#FF0000">{</font>	<i><font color="#9A1900">// if the PresentPreset property is not implemented, fall back to the CurrentPreset property</font></i>
		<font color="#008080">OSStatus</font> result <font color="#990000">=</font> <b><font color="#000000">AudioUnitGetProperty</font></b> <font color="#990000">(</font>mView<font color="#990000">-&gt;</font><b><font color="#000000">GetEditAudioUnit</font></b><font color="#990000">(),</font> 
									kAudioUnitProperty_CurrentPreset<font color="#990000">,</font>
									kAudioUnitScope_Global<font color="#990000">,</font> 
									<font color="#993399">0</font><font color="#990000">,</font> 
									<font color="#990000">&amp;</font>defaultPreset<font color="#990000">,</font> 
									<font color="#990000">&amp;</font>propertySize<font color="#990000">);</font>
		mPropertyID <font color="#990000">=</font> kAudioUnitProperty_CurrentPreset<font color="#990000">;</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>result <font color="#990000">==</font> noErr<font color="#990000">)</font>
			<b><font color="#000000">CFRetain</font></b> <font color="#990000">(</font>defaultPreset<font color="#990000">.</font>presetName<font color="#990000">);</font>
	<font color="#FF0000">}</font> 
<b><font color="#000080">#endif</font></b>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__		
	<b><font color="#000000">EmbedControl</font></b> <font color="#990000">(</font>mControl<font color="#990000">);</font>
	
	<b><font color="#000000">HandlePropertyChange</font></b><font color="#990000">(</font>defaultPreset<font color="#990000">);</font>
	
	<b><font color="#000000">RegisterEvents</font></b><font color="#990000">();</font>
<b><font color="#000080">#endif</font></b>
<font color="#FF0000">}</font>

<font color="#009900">void</font>	AUVPresets<font color="#990000">::</font><b><font color="#000000">AddInterest</font></b> <font color="#990000">(</font><font color="#008080">AUEventListenerRef</font>		inListener<font color="#990000">,</font>
											<font color="#009900">void</font> <font color="#990000">*</font>		inObject<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<font color="#008080">AudioUnitEvent</font> e<font color="#990000">;</font>
	e<font color="#990000">.</font>mEventType <font color="#990000">=</font> kAudioUnitEvent_PropertyChange<font color="#990000">;</font>
	e<font color="#990000">.</font>mArgument<font color="#990000">.</font>mProperty<font color="#990000">.</font>mAudioUnit <font color="#990000">=</font> mView<font color="#990000">-&gt;</font><b><font color="#000000">GetEditAudioUnit</font></b><font color="#990000">();</font>
	e<font color="#990000">.</font>mArgument<font color="#990000">.</font>mProperty<font color="#990000">.</font>mPropertyID <font color="#990000">=</font> mPropertyID<font color="#990000">;</font>
	e<font color="#990000">.</font>mArgument<font color="#990000">.</font>mProperty<font color="#990000">.</font>mScope <font color="#990000">=</font> kAudioUnitScope_Global<font color="#990000">;</font>
	e<font color="#990000">.</font>mArgument<font color="#990000">.</font>mProperty<font color="#990000">.</font>mElement <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	
	<b><font color="#000000">AUEventListenerAddEventType</font></b><font color="#990000">(</font>inListener<font color="#990000">,</font> inObject<font color="#990000">,</font> <font color="#990000">&amp;</font>e<font color="#990000">);</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>	AUVPresets<font color="#990000">::</font><b><font color="#000000">RemoveInterest</font></b> <font color="#990000">(</font><font color="#008080">AUEventListenerRef</font>	inListener<font color="#990000">,</font>
											<font color="#009900">void</font> <font color="#990000">*</font>		inObject<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<font color="#008080">AudioUnitEvent</font> e<font color="#990000">;</font>
	e<font color="#990000">.</font>mEventType <font color="#990000">=</font> kAudioUnitEvent_PropertyChange<font color="#990000">;</font>
	e<font color="#990000">.</font>mArgument<font color="#990000">.</font>mProperty<font color="#990000">.</font>mAudioUnit <font color="#990000">=</font> mView<font color="#990000">-&gt;</font><b><font color="#000000">GetEditAudioUnit</font></b><font color="#990000">();</font>
	e<font color="#990000">.</font>mArgument<font color="#990000">.</font>mProperty<font color="#990000">.</font>mPropertyID <font color="#990000">=</font> mPropertyID<font color="#990000">;</font>
	e<font color="#990000">.</font>mArgument<font color="#990000">.</font>mProperty<font color="#990000">.</font>mScope <font color="#990000">=</font> kAudioUnitScope_Global<font color="#990000">;</font>
	e<font color="#990000">.</font>mArgument<font color="#990000">.</font>mProperty<font color="#990000">.</font>mElement <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>

	<b><font color="#000000">AUEventListenerRemoveEventType</font></b><font color="#990000">(</font>inListener<font color="#990000">,</font> inObject<font color="#990000">,</font> <font color="#990000">&amp;</font>e<font color="#990000">);</font>
<font color="#FF0000">}</font>

<font color="#009900">void</font>	AUVPresets<font color="#990000">::</font><b><font color="#000000">HandleControlChange</font></b> <font color="#990000">()</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__
	<font color="#008080">SInt32</font> i <font color="#990000">=</font> <b><font color="#000000">GetControl32BitValue</font></b><font color="#990000">(</font>mControl<font color="#990000">);</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>i <font color="#990000">&gt;</font> <font color="#993399">0</font><font color="#990000">)</font>
	<font color="#FF0000">{</font>
		AUPreset<font color="#990000">*</font> preset <font color="#990000">=</font> <font color="#990000">(</font>AUPreset<font color="#990000">*)</font> <b><font color="#000000">CFArrayGetValueAtIndex</font></b> <font color="#990000">(</font>mPresets<font color="#990000">,</font> i<font color="#990000">-</font><font color="#993399">1</font><font color="#990000">);</font>
	
		<b><font color="#000000">verify_noerr</font></b><font color="#990000">(</font><b><font color="#000000">AudioUnitSetProperty</font></b> <font color="#990000">(</font>mView<font color="#990000">-&gt;</font><b><font color="#000000">GetEditAudioUnit</font></b><font color="#990000">(),</font> 
									mPropertyID<font color="#990000">,</font>	<i><font color="#9A1900">// either currentPreset or PresentPreset depending on which is supported</font></i>
									kAudioUnitScope_Global<font color="#990000">,</font> 
									<font color="#993399">0</font><font color="#990000">,</font> 
									preset<font color="#990000">,</font> 
									<b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>AUPreset<font color="#990000">)));</font>
									
		<i><font color="#9A1900">// when we change a preset we can't expect the AU to update its state</font></i>
		<i><font color="#9A1900">// as it isn't meant to know that its being viewed!</font></i>
		<i><font color="#9A1900">// so we broadcast a notification to all listeners that all parameters on this AU have changed</font></i>
		<font color="#008080">AudioUnitParameter</font> changedUnit<font color="#990000">;</font>
		changedUnit<font color="#990000">.</font>mAudioUnit <font color="#990000">=</font> mView<font color="#990000">-&gt;</font><b><font color="#000000">GetEditAudioUnit</font></b><font color="#990000">();</font>
		changedUnit<font color="#990000">.</font>mParameterID <font color="#990000">=</font> kAUParameterListener_AnyParameter<font color="#990000">;</font>
		<b><font color="#000000">verify_noerr</font></b> <font color="#990000">(</font><b><font color="#000000">AUParameterListenerNotify</font></b> <font color="#990000">(</font>NULL<font color="#990000">,</font> NULL<font color="#990000">,</font> <font color="#990000">&amp;</font>changedUnit<font color="#990000">)</font> <font color="#990000">);</font>
	<font color="#FF0000">}</font>
<b><font color="#000080">#endif</font></b>
<font color="#FF0000">}</font>

<font color="#009900">void</font>	AUVPresets<font color="#990000">::</font><b><font color="#000000">HandlePropertyChange</font></b><font color="#990000">(</font><font color="#008080">AUPreset</font> <font color="#990000">&amp;</font>preset<font color="#990000">)</font> 
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>__LP64__
	<i><font color="#9A1900">// check to see if the preset is in our menu</font></i>
	<font color="#009900">int</font> numPresets <font color="#990000">=</font> <b><font color="#000000">CFArrayGetCount</font></b><font color="#990000">(</font>mPresets<font color="#990000">);</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>preset<font color="#990000">.</font>presetNumber <font color="#990000">&lt;</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#FF0000">{</font>	
		<b><font color="#000000">SetControl32BitValue</font></b> <font color="#990000">(</font>mControl<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">);</font> <i><font color="#9A1900">//controls are one-based</font></i>
	<font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
		<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">SInt32</font> i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> numPresets<font color="#990000">;</font> <font color="#990000">++</font>i<font color="#990000">)</font> <font color="#FF0000">{</font>
			AUPreset<font color="#990000">*</font> currPreset <font color="#990000">=</font> <font color="#990000">(</font>AUPreset<font color="#990000">*)</font> <b><font color="#000000">CFArrayGetValueAtIndex</font></b> <font color="#990000">(</font>mPresets<font color="#990000">,</font> i<font color="#990000">);</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>preset<font color="#990000">.</font>presetNumber <font color="#990000">==</font> currPreset<font color="#990000">-&gt;</font>presetNumber<font color="#990000">)</font> <font color="#FF0000">{</font>
				<b><font color="#000000">SetControl32BitValue</font></b> <font color="#990000">(</font>mControl<font color="#990000">,</font> <font color="#990000">++</font>i<font color="#990000">);</font> <i><font color="#9A1900">//controls are one-based</font></i>
				<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
			<font color="#FF0000">}</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font>
	
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>preset<font color="#990000">.</font>presetName<font color="#990000">)</font>
		<b><font color="#000000">CFRelease</font></b> <font color="#990000">(</font>preset<font color="#990000">.</font>presetName<font color="#990000">);</font>
<b><font color="#000080">#endif</font></b>
<font color="#FF0000">}</font>

<font color="#009900">bool</font>	AUVPresets<font color="#990000">::</font><b><font color="#000000">HandlePropertyChange</font></b> <font color="#990000">(</font><b><font color="#0000FF">const</font></b> <font color="#008080">AudioUnitProperty</font> <font color="#990000">&amp;</font>inProp<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inProp<font color="#990000">.</font>mPropertyID <font color="#990000">==</font> mPropertyID<font color="#990000">)</font> 
	<font color="#FF0000">{</font>
		<font color="#008080">UInt32</font> theSize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>AUPreset<font color="#990000">);</font>
		<font color="#008080">AUPreset</font> currentPreset<font color="#990000">;</font>
		
		<font color="#008080">OSStatus</font> result <font color="#990000">=</font> <b><font color="#000000">AudioUnitGetProperty</font></b><font color="#990000">(</font>inProp<font color="#990000">.</font>mAudioUnit<font color="#990000">,</font> 
												inProp<font color="#990000">.</font>mPropertyID<font color="#990000">,</font> 
												inProp<font color="#990000">.</font>mScope<font color="#990000">,</font> 
												inProp<font color="#990000">.</font>mElement<font color="#990000">,</font> <font color="#990000">&amp;</font>currentPreset<font color="#990000">,</font> <font color="#990000">&amp;</font>theSize<font color="#990000">);</font>
		
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>result <font color="#990000">==</font> noErr<font color="#990000">)</font> <font color="#FF0000">{</font>
<b><font color="#000080">#ifndef</font></b> __LP64__
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inProp<font color="#990000">.</font>mPropertyID <font color="#990000">==</font> kAudioUnitProperty_CurrentPreset <font color="#990000">&amp;&amp;</font> currentPreset<font color="#990000">.</font>presetName<font color="#990000">)</font>
				<b><font color="#000000">CFRetain</font></b> <font color="#990000">(</font>currentPreset<font color="#990000">.</font>presetName<font color="#990000">);</font>
<b><font color="#000080">#endif</font></b>
			<b><font color="#000000">HandlePropertyChange</font></b><font color="#990000">(</font>currentPreset<font color="#990000">);</font>
			<b><font color="#0000FF">return</font></b> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font>
	<b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>
</tt></pre>
