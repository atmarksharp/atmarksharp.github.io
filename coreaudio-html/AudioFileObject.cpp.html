<!-- Generator: GNU source-highlight 3.1.7
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite -->
<pre><tt>
<i><font color="#9A1900">/*   Path: ~/lab/CoreAudioUtilityClasses/Mac/CoreAudioUtilityClasses/CoreAudio/AudioFile/AFPublic/AudioFileObject.cpp  */</font></i>

<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900">     File: AudioFileObject.cpp </font></i>
<i><font color="#9A1900"> Abstract:  AudioFileObject.h  </font></i>
<i><font color="#9A1900">  Version: 1.0.4 </font></i>
<i><font color="#9A1900">  </font></i>
<i><font color="#9A1900"> Disclaimer: IMPORTANT:  This Apple software is supplied to you by Apple </font></i>
<i><font color="#9A1900"> Inc. ("Apple") in consideration of your agreement to the following </font></i>
<i><font color="#9A1900"> terms, and your use, installation, modification or redistribution of </font></i>
<i><font color="#9A1900"> this Apple software constitutes acceptance of these terms.  If you do </font></i>
<i><font color="#9A1900"> not agree with these terms, please do not use, install, modify or </font></i>
<i><font color="#9A1900"> redistribute this Apple software. </font></i>
<i><font color="#9A1900">  </font></i>
<i><font color="#9A1900"> In consideration of your agreement to abide by the following terms, and </font></i>
<i><font color="#9A1900"> subject to these terms, Apple grants you a personal, non-exclusive </font></i>
<i><font color="#9A1900"> license, under Apple's copyrights in this original Apple software (the </font></i>
<i><font color="#9A1900"> "Apple Software"), to use, reproduce, modify and redistribute the Apple </font></i>
<i><font color="#9A1900"> Software, with or without modifications, in source and/or binary forms; </font></i>
<i><font color="#9A1900"> provided that if you redistribute the Apple Software in its entirety and </font></i>
<i><font color="#9A1900"> without modifications, you must retain this notice and the following </font></i>
<i><font color="#9A1900"> text and disclaimers in all such redistributions of the Apple Software. </font></i>
<i><font color="#9A1900"> Neither the name, trademarks, service marks or logos of Apple Inc. may </font></i>
<i><font color="#9A1900"> be used to endorse or promote products derived from the Apple Software </font></i>
<i><font color="#9A1900"> without specific prior written permission from Apple.  Except as </font></i>
<i><font color="#9A1900"> expressly stated in this notice, no other rights or licenses, express or </font></i>
<i><font color="#9A1900"> implied, are granted by Apple herein, including but not limited to any </font></i>
<i><font color="#9A1900"> patent rights that may be infringed by your derivative works or by other </font></i>
<i><font color="#9A1900"> works in which the Apple Software may be incorporated. </font></i>
<i><font color="#9A1900">  </font></i>
<i><font color="#9A1900"> The Apple Software is provided by Apple on an "AS IS" basis.  APPLE </font></i>
<i><font color="#9A1900"> MAKES NO WARRANTIES, EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION </font></i>
<i><font color="#9A1900"> THE IMPLIED WARRANTIES OF NON-INFRINGEMENT, MERCHANTABILITY AND FITNESS </font></i>
<i><font color="#9A1900"> FOR A PARTICULAR PURPOSE, REGARDING THE APPLE SOFTWARE OR ITS USE AND </font></i>
<i><font color="#9A1900"> OPERATION ALONE OR IN COMBINATION WITH YOUR PRODUCTS. </font></i>
<i><font color="#9A1900">  </font></i>
<i><font color="#9A1900"> IN NO EVENT SHALL APPLE BE LIABLE FOR ANY SPECIAL, INDIRECT, INCIDENTAL </font></i>
<i><font color="#9A1900"> OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF </font></i>
<i><font color="#9A1900"> SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS </font></i>
<i><font color="#9A1900"> INTERRUPTION) ARISING IN ANY WAY OUT OF THE USE, REPRODUCTION, </font></i>
<i><font color="#9A1900"> MODIFICATION AND/OR DISTRIBUTION OF THE APPLE SOFTWARE, HOWEVER CAUSED </font></i>
<i><font color="#9A1900"> AND WHETHER UNDER THEORY OF CONTRACT, TORT (INCLUDING NEGLIGENCE), </font></i>
<i><font color="#9A1900"> STRICT LIABILITY OR OTHERWISE, EVEN IF APPLE HAS BEEN ADVISED OF THE </font></i>
<i><font color="#9A1900"> POSSIBILITY OF SUCH DAMAGE. </font></i>
<i><font color="#9A1900">  </font></i>
<i><font color="#9A1900"> Copyright (C) 2013 Apple Inc. All Rights Reserved. </font></i>
<i><font color="#9A1900">  </font></i>
<i><font color="#9A1900">*/</font></i>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"AudioFileObject.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">"CADebugMacros.h"</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;algorithm&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;sys/stat.h&gt;</font>

<b><font color="#000080">#define</font></b> kAudioFileNoCacheMask		<font color="#993399">0x20</font>

<i><font color="#9A1900">//////////////////////////////////////////////////////////////////////////////////////////////////////////</font></i>

AudioFileObject<font color="#990000">::~</font><b><font color="#000000">AudioFileObject</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">delete</font></b> mDataSource<font color="#990000">;</font>
	<b><font color="#000000">DeletePacketTable</font></b><font color="#990000">();</font>
	<b><font color="#000000">SetURL</font></b><font color="#990000">(</font>NULL<font color="#990000">);</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">DoCreate</font></b><font color="#990000">(</font>		
									<font color="#008080">CFURLRef</font>							inFileRef<font color="#990000">,</font>
									<b><font color="#0000FF">const</font></b> <font color="#008080">AudioStreamBasicDescription</font>	<font color="#990000">*</font>inFormat<font color="#990000">,</font>
									<font color="#008080">UInt32</font>								inFlags<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<i><font color="#9A1900">// common prologue</font></i>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font><b><font color="#000000">IsDataFormatValid</font></b><font color="#990000">(</font>inFormat<font color="#990000">))</font>
		<b><font color="#0000FF">return</font></b> kAudioFileUnsupportedDataFormatError<font color="#990000">;</font>

	<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font><b><font color="#000000">IsDataFormatSupported</font></b><font color="#990000">(</font>inFormat<font color="#990000">))</font> 
		<b><font color="#0000FF">return</font></b> kAudioFileUnsupportedDataFormatError<font color="#990000">;</font>

	<b><font color="#000000">SetPermissions</font></b><font color="#990000">(</font>kAudioFileReadWritePermission<font color="#990000">);</font>
	
	<b><font color="#000000">SetAlignDataWithFillerChunks</font></b><font color="#990000">(!(</font>inFlags <font color="#990000">&amp;</font> <font color="#993399">2</font> <i><font color="#9A1900">/* kAudioFileFlags_DontPageAlignAudioData */</font></i> <font color="#990000">));</font>
	
	<i><font color="#9A1900">// call virtual method for particular format.</font></i>
	<b><font color="#0000FF">return</font></b> <b><font color="#000000">Create</font></b><font color="#990000">(</font>inFileRef<font color="#990000">,</font> inFormat<font color="#990000">);</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>
                                
<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">Create</font></b><font color="#990000">(</font>		
									<font color="#008080">CFURLRef</font>							inFileRef<font color="#990000">,</font>
									<b><font color="#0000FF">const</font></b> <font color="#008080">AudioStreamBasicDescription</font>	<font color="#990000">*</font>inFormat<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<font color="#009900">int</font> fileD<font color="#990000">;</font>
	<font color="#008080">OSStatus</font> err <font color="#990000">=</font> <b><font color="#000000">CreateDataFile</font></b> <font color="#990000">(</font>inFileRef<font color="#990000">,</font> fileD<font color="#990000">);</font>
    <b><font color="#000000">FailIf</font></b> <font color="#990000">(</font>err <font color="#990000">!=</font> noErr<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"CreateDataFile failed"</font><font color="#990000">);</font>
	
	<b><font color="#000000">SetURL</font></b> <font color="#990000">(</font>inFileRef<font color="#990000">);</font>

	err <font color="#990000">=</font> <b><font color="#000000">OpenFile</font></b><font color="#990000">(</font>kAudioFileReadWritePermission<font color="#990000">,</font> fileD<font color="#990000">);</font>
    <b><font color="#000000">FailIf</font></b> <font color="#990000">(</font>err <font color="#990000">!=</font> noErr<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"OpenFile failed"</font><font color="#990000">);</font>

	err <font color="#990000">=</font> <b><font color="#000000">SetDataFormat</font></b><font color="#990000">(</font>inFormat<font color="#990000">);</font>
    <b><font color="#000000">FailIf</font></b> <font color="#990000">(</font>err <font color="#990000">!=</font> noErr<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"SetDataFormat failed"</font><font color="#990000">);</font>
	
    mIsInitialized <font color="#990000">=</font> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
	
<b><font color="#008080">Bail:</font></b>
	<b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">DoOpen</font></b><font color="#990000">(</font>	
									<font color="#008080">CFURLRef</font>		inFileRef<font color="#990000">,</font> 
									<font color="#008080">SInt8</font>  			inPermissions<font color="#990000">,</font>
									<font color="#009900">int</font>				inFD<font color="#990000">)</font>
<font color="#FF0000">{</font>		
	<font color="#008080">OSStatus</font> err <font color="#990000">=</font> noErr<font color="#990000">;</font>
	<b><font color="#000000">SetPermissions</font></b><font color="#990000">(</font>inPermissions<font color="#990000">);</font>
	
	err <font color="#990000">=</font> <b><font color="#000000">Open</font></b><font color="#990000">(</font>inFileRef<font color="#990000">,</font> inPermissions<font color="#990000">,</font> inFD<font color="#990000">);</font>
    <b><font color="#000000">FailIf</font></b> <font color="#990000">(</font>err <font color="#990000">!=</font> noErr<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"Open failed"</font><font color="#990000">);</font>

	err <font color="#990000">=</font> <b><font color="#000000">ValidateFormatAndData</font></b><font color="#990000">();</font>
    <b><font color="#000000">FailIf</font></b> <font color="#990000">(</font>err <font color="#990000">!=</font> noErr<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"ValidateFormatAndData failed"</font><font color="#990000">);</font>

<b><font color="#008080">Bail:</font></b>
	<b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">Open</font></b><font color="#990000">(</font>			
									<font color="#008080">CFURLRef</font>		inFileRef<font color="#990000">,</font> 
									<font color="#008080">SInt8</font>  			inPermissions<font color="#990000">,</font>
									<font color="#009900">int</font>				inFD<font color="#990000">)</font>
<font color="#FF0000">{</font>		
	<b><font color="#0000FF">if</font></b> <font color="#990000">(!(</font>inPermissions <font color="#990000">&amp;</font> kAudioFileReadPermission<font color="#990000">))</font>
		<b><font color="#0000FF">return</font></b> kAudioFilePermissionsError<font color="#990000">;</font> <i><font color="#9A1900">// file must have read permissions</font></i>
 
	<b><font color="#000000">SetURL</font></b><font color="#990000">(</font>inFileRef<font color="#990000">);</font>
	
	<font color="#008080">OSStatus</font> err <font color="#990000">=</font> <b><font color="#000000">OpenFile</font></b><font color="#990000">(</font>inPermissions<font color="#990000">,</font> inFD<font color="#990000">);</font>
    <b><font color="#000000">FailIf</font></b> <font color="#990000">(</font>err <font color="#990000">!=</font> noErr<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"OpenFile failed"</font><font color="#990000">);</font>
		
	err <font color="#990000">=</font> <b><font color="#000000">OpenFromDataSource</font></b><font color="#990000">();</font>
    <b><font color="#000000">FailIf</font></b> <font color="#990000">(</font>err <font color="#990000">!=</font> noErr<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"OpenFromDataSource failed"</font><font color="#990000">);</font>
	
<b><font color="#008080">Bail:</font></b>
	<b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">ValidateFormatAndData</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
	

	<font color="#008080">AudioStreamBasicDescription</font> asbd <font color="#990000">=</font> <b><font color="#000000">GetDataFormat</font></b><font color="#990000">();</font>

	<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font><b><font color="#000000">IsDataFormatValid</font></b><font color="#990000">(&amp;</font>asbd<font color="#990000">))</font>
		<b><font color="#0000FF">return</font></b> kAudioFileInvalidFileError<font color="#990000">;</font>

	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>asbd<font color="#990000">.</font>mFormatID <font color="#990000">==</font> kAudioFormatLinearPCM<font color="#990000">)</font> 
	<font color="#FF0000">{</font>
		<font color="#008080">SInt64</font> maxPackets <font color="#990000">=</font> <b><font color="#000000">GetNumBytes</font></b><font color="#990000">()</font> <font color="#990000">/</font> asbd<font color="#990000">.</font>mBytesPerPacket<font color="#990000">;</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#000000">GetNumPackets</font></b><font color="#990000">()</font> <font color="#990000">&gt;</font> maxPackets<font color="#990000">)</font> 
			<b><font color="#0000FF">return</font></b> kAudioFileInvalidFileError<font color="#990000">;</font>
	<font color="#FF0000">}</font>
	<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">DoOpenWithCallbacks</font></b><font color="#990000">(</font>
				<font color="#009900">void</font> <font color="#990000">*</font>								inRefCon<font color="#990000">,</font> 
				<font color="#008080">AudioFile_ReadProc</font>					inReadFunc<font color="#990000">,</font> 
				<font color="#008080">AudioFile_WriteProc</font>					inWriteFunc<font color="#990000">,</font> 
				<font color="#008080">AudioFile_GetSizeProc</font>				inGetSizeFunc<font color="#990000">,</font>
				<font color="#008080">AudioFile_SetSizeProc</font>				inSetSizeFunc<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<font color="#008080">SInt8</font>	perms <font color="#990000">=</font> <font color="#990000">(</font>inSetSizeFunc <font color="#990000">||</font> inWriteFunc<font color="#990000">)</font> <font color="#990000">?</font> kAudioFileReadWritePermission <font color="#990000">:</font> kAudioFileReadPermission<font color="#990000">;</font>
	<b><font color="#000000">SetPermissions</font></b><font color="#990000">(</font>perms<font color="#990000">);</font>
	
	DataSource<font color="#990000">*</font> dataSource <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Seekable_DataSource</font></b><font color="#990000">(</font>inRefCon<font color="#990000">,</font> inReadFunc<font color="#990000">,</font> inWriteFunc<font color="#990000">,</font> inGetSizeFunc<font color="#990000">,</font> inSetSizeFunc<font color="#990000">);</font>
	<b><font color="#000000">SetDataSource</font></b><font color="#990000">(</font>dataSource<font color="#990000">);</font>
	<b><font color="#0000FF">return</font></b> <b><font color="#000000">OpenFromDataSource</font></b><font color="#990000">();</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>
							
<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">OpenFromDataSource</font></b><font color="#990000">(</font><font color="#009900">void</font><font color="#990000">)</font>
<font color="#FF0000">{</font>		
	<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>
<font color="#FF0000">}</font>


<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">DoInitializeWithCallbacks</font></b><font color="#990000">(</font>
				<font color="#009900">void</font> <font color="#990000">*</font>								inRefCon<font color="#990000">,</font> 
				<font color="#008080">AudioFile_ReadProc</font>					inReadFunc<font color="#990000">,</font> 
				<font color="#008080">AudioFile_WriteProc</font>					inWriteFunc<font color="#990000">,</font> 
				<font color="#008080">AudioFile_GetSizeProc</font>				inGetSizeFunc<font color="#990000">,</font>
				<font color="#008080">AudioFile_SetSizeProc</font>				inSetSizeFunc<font color="#990000">,</font>
                <font color="#008080">UInt32</font>								inFileType<font color="#990000">,</font>
				<b><font color="#0000FF">const</font></b> <font color="#008080">AudioStreamBasicDescription</font>	<font color="#990000">*</font>inFormat<font color="#990000">,</font>
				<font color="#008080">UInt32</font>								inFlags<font color="#990000">)</font>
<font color="#FF0000">{</font>		
	DataSource<font color="#990000">*</font> dataSource <font color="#990000">=</font> <b><font color="#0000FF">new</font></b> <b><font color="#000000">Seekable_DataSource</font></b><font color="#990000">(</font>inRefCon<font color="#990000">,</font> inReadFunc<font color="#990000">,</font> inWriteFunc<font color="#990000">,</font> inGetSizeFunc<font color="#990000">,</font> inSetSizeFunc<font color="#990000">);</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>dataSource<font color="#990000">-&gt;</font><b><font color="#000000">CanWrite</font></b><font color="#990000">())</font> <b><font color="#0000FF">return</font></b> <font color="#990000">-</font><font color="#993399">54</font><i><font color="#9A1900">/*permErr*/</font></i><font color="#990000">;</font>
	dataSource<font color="#990000">-&gt;</font><b><font color="#000000">SetSize</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">);</font>
	<b><font color="#000000">SetDataSource</font></b><font color="#990000">(</font>dataSource<font color="#990000">);</font>
	<b><font color="#000000">SetPermissions</font></b><font color="#990000">(</font>kAudioFileReadWritePermission<font color="#990000">);</font>

	<b><font color="#000000">SetAlignDataWithFillerChunks</font></b><font color="#990000">(!(</font>inFlags <font color="#990000">&amp;</font> <font color="#993399">2</font> <i><font color="#9A1900">/* kAudioFileFlags_DontPageAlignAudioData */</font></i> <font color="#990000">));</font>

	<font color="#008080">OSStatus</font> err <font color="#990000">=</font> <b><font color="#000000">SetDataFormat</font></b><font color="#990000">(</font>inFormat<font color="#990000">);</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>err<font color="#990000">)</font> <b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
	
	<b><font color="#0000FF">return</font></b> <b><font color="#000000">InitializeDataSource</font></b><font color="#990000">(</font>inFormat<font color="#990000">,</font> inFlags<font color="#990000">);</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>
					
<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">DoInitialize</font></b><font color="#990000">(</font>	
									<font color="#008080">CFURLRef</font>							inFileRef<font color="#990000">,</font>
									<b><font color="#0000FF">const</font></b> <font color="#008080">AudioStreamBasicDescription</font>	<font color="#990000">*</font>inFormat<font color="#990000">,</font>
									<font color="#008080">UInt32</font>			inFlags<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#000000">SetURL</font></b> <font color="#990000">(</font>inFileRef<font color="#990000">);</font>
	<b><font color="#000000">SetPermissions</font></b><font color="#990000">(</font>kAudioFileReadWritePermission<font color="#990000">);</font>

	<b><font color="#000000">SetAlignDataWithFillerChunks</font></b><font color="#990000">(!(</font>inFlags <font color="#990000">&amp;</font> <font color="#993399">2</font> <i><font color="#9A1900">/* kAudioFileFlags_DontPageAlignAudioData */</font></i> <font color="#990000">));</font>

	<b><font color="#0000FF">return</font></b> <b><font color="#000000">Initialize</font></b><font color="#990000">(</font>inFileRef<font color="#990000">,</font> inFormat<font color="#990000">,</font> inFlags<font color="#990000">);</font>
<font color="#FF0000">}</font>
<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>
					
<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">Initialize</font></b><font color="#990000">(</font>	
									<font color="#008080">CFURLRef</font>							inFileRef<font color="#990000">,</font>
									<b><font color="#0000FF">const</font></b> <font color="#008080">AudioStreamBasicDescription</font>	<font color="#990000">*</font>inFormat<font color="#990000">,</font>
									<font color="#008080">UInt32</font>								inFlags<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<font color="#008080">OSStatus</font> err <font color="#990000">=</font> noErr<font color="#990000">;</font>
		
	<font color="#008080">UInt8</font> fPath<font color="#990000">[</font>FILENAME_MAX<font color="#990000">];</font>	
	<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font><b><font color="#000000">CFURLGetFileSystemRepresentation</font></b> <font color="#990000">(</font>inFileRef<font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> fPath<font color="#990000">,</font> FILENAME_MAX<font color="#990000">))</font>
		<b><font color="#0000FF">return</font></b> kAudio_FileNotFoundError<font color="#990000">;</font>

<b><font color="#000080">#if</font></b> TARGET_OS_WIN32
	<font color="#009900">int</font> filePerms <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	<font color="#009900">int</font> flags <font color="#990000">=</font> O_TRUNC <font color="#990000">|</font> O_RDWR <font color="#990000">|</font> O_BINARY<font color="#990000">;</font>
<b><font color="#000080">#else</font></b>
	<font color="#008080">mode_t</font> filePerms <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	<font color="#009900">int</font> flags <font color="#990000">=</font> O_TRUNC <font color="#990000">|</font> O_RDWR<font color="#990000">;</font>
<b><font color="#000080">#endif</font></b>

	<font color="#009900">int</font> fileD <font color="#990000">=</font> <b><font color="#000000">open</font></b><font color="#990000">((</font><b><font color="#0000FF">const</font></b> <font color="#009900">char</font><font color="#990000">*)</font>fPath<font color="#990000">,</font> flags<font color="#990000">,</font> filePerms<font color="#990000">);</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fileD <font color="#990000">&lt;</font> <font color="#993399">0</font><font color="#990000">)</font>
		<b><font color="#0000FF">return</font></b> kAudioFilePermissionsError<font color="#990000">;</font>
	
	err <font color="#990000">=</font> <b><font color="#000000">OpenFile</font></b><font color="#990000">(</font>kAudioFileReadWritePermission<font color="#990000">,</font> fileD<font color="#990000">);</font>
    <b><font color="#000000">FailIf</font></b> <font color="#990000">(</font>err <font color="#990000">!=</font> noErr<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"OpenFile failed"</font><font color="#990000">);</font>
	
		<i><font color="#9A1900">// don't need to do this as open has an option to truncate the file</font></i>
<i><font color="#9A1900">//	GetDataSource()-&gt;SetSize(0);</font></i>

	err <font color="#990000">=</font> <b><font color="#000000">SetDataFormat</font></b><font color="#990000">(</font>inFormat<font color="#990000">);</font>
    <b><font color="#000000">FailIf</font></b> <font color="#990000">(</font>err <font color="#990000">!=</font> noErr<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"SetDataFormat failed"</font><font color="#990000">);</font>

	<b><font color="#000000">InitializeDataSource</font></b><font color="#990000">(</font>inFormat<font color="#990000">,</font> inFlags<font color="#990000">);</font>
	
<b><font color="#008080">Bail:	</font></b>
	<b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>
							
<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">InitializeDataSource</font></b><font color="#990000">(</font><b><font color="#0000FF">const</font></b> <font color="#008080">AudioStreamBasicDescription</font>	<font color="#990000">*</font>inFormat<font color="#990000">,</font> UInt32 <i><font color="#9A1900">/*inFlags*/</font></i><font color="#990000">)</font>
<font color="#FF0000">{</font>		
	<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">DoClose</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
	<font color="#008080">OSStatus</font> err <font color="#990000">=</font> <b><font color="#000000">UpdateSizeIfNeeded</font></b><font color="#990000">();</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>err<font color="#990000">)</font> <b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
	
	<b><font color="#0000FF">return</font></b> <b><font color="#000000">Close</font></b><font color="#990000">();</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">Close</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
    <b><font color="#0000FF">try</font></b> <font color="#FF0000">{</font>
		<b><font color="#0000FF">delete</font></b> mDataSource<font color="#990000">;</font>
		mDataSource <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	<font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(</font><font color="#008080">OSStatus</font> err<font color="#990000">)</font> <font color="#FF0000">{</font>
		<b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
	<font color="#FF0000">}</font> <b><font color="#0000FF">catch</font></b> <font color="#990000">(...)</font> <font color="#FF0000">{</font>
		<b><font color="#0000FF">return</font></b> kAudioFileUnspecifiedError<font color="#990000">;</font>
	<font color="#FF0000">}</font>
	<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>


<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">Optimize</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
	<i><font color="#9A1900">// default is that nothing needs to be done. This happens to be true for Raw, SD2 and NeXT/Sun types.</font></i>
	<b><font color="#000000">SetIsOptimized</font></b><font color="#990000">(</font><b><font color="#0000FF">true</font></b><font color="#990000">);</font> 
	<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>


<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">DoOptimize</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font><b><font color="#000000">CanWrite</font></b><font color="#990000">())</font> <b><font color="#0000FF">return</font></b> kAudioFilePermissionsError<font color="#990000">;</font>

	<font color="#008080">OSStatus</font> err <font color="#990000">=</font> <b><font color="#000000">UpdateSizeIfNeeded</font></b><font color="#990000">();</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>err<font color="#990000">)</font> <b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
	
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#000000">IsOptimized</font></b><font color="#990000">())</font> <b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>

	err <font color="#990000">=</font> <b><font color="#000000">Optimize</font></b><font color="#990000">();</font>
	<b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">UpdateNumBytes</font></b><font color="#990000">(</font><font color="#008080">SInt64</font> inNumBytes<font color="#990000">)</font>	
<font color="#FF0000">{</font>
    <font color="#008080">OSStatus</font> err <font color="#990000">=</font> noErr<font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inNumBytes <font color="#990000">!=</font> <b><font color="#000000">GetNumBytes</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
		<b><font color="#000000">SetNumBytes</font></b><font color="#990000">(</font>inNumBytes<font color="#990000">);</font>
        
        <i><font color="#9A1900">// #warning " this will not work for vbr formats"</font></i>
		<b><font color="#000000">SetNumPackets</font></b><font color="#990000">(</font><b><font color="#000000">GetNumBytes</font></b><font color="#990000">()</font> <font color="#990000">/</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">);</font>
		<b><font color="#000000">SizeChanged</font></b><font color="#990000">();</font>
	<font color="#FF0000">}</font>
	<b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">UpdateNumPackets</font></b><font color="#990000">(</font><font color="#008080">SInt64</font> inNumPackets<font color="#990000">)</font>	
<font color="#FF0000">{</font>
    <font color="#008080">OSStatus</font> err <font color="#990000">=</font> noErr<font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inNumPackets <font color="#990000">!=</font> <b><font color="#000000">GetNumPackets</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
		<i><font color="#9A1900">// sync current state.</font></i>
		<b><font color="#000000">SetNeedsSizeUpdate</font></b><font color="#990000">(</font><b><font color="#0000FF">true</font></b><font color="#990000">);</font>
		<b><font color="#000000">UpdateSizeIfNeeded</font></b><font color="#990000">();</font>
		<b><font color="#000000">SetNumPackets</font></b><font color="#990000">(</font>inNumPackets<font color="#990000">);</font>
        
        <i><font color="#9A1900">// #warning " this will not work for vbr formats"</font></i>
		<b><font color="#000000">SetNumBytes</font></b><font color="#990000">(</font><b><font color="#000000">GetNumPackets</font></b><font color="#990000">()</font> <font color="#990000">*</font> mDataFormat<font color="#990000">.</font>mBytesPerFrame<font color="#990000">);</font>
		<b><font color="#000000">SizeChanged</font></b><font color="#990000">();</font>
	<font color="#FF0000">}</font>
	<b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>


<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">PacketToFrame</font></b><font color="#990000">(</font><font color="#008080">SInt64</font> inPacket<font color="#990000">,</font> SInt64<font color="#990000">&amp;</font> outFirstFrameInPacket<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mDataFormat<font color="#990000">.</font>mFramesPerPacket <font color="#990000">==</font> <font color="#993399">0</font><font color="#990000">)</font>
	<font color="#FF0000">{</font>
		<font color="#008080">OSStatus</font> err <font color="#990000">=</font> <b><font color="#000000">ScanForPackets</font></b><font color="#990000">(</font>inPacket<font color="#990000">+</font><font color="#993399">1</font><font color="#990000">);</font> <i><font color="#9A1900">// the packet count must be one greater than the packet index</font></i>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>err<font color="#990000">)</font> <b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
		
		<font color="#008080">SInt64</font> packetTableSize <font color="#990000">=</font> <b><font color="#000000">GetPacketTableSize</font></b><font color="#990000">();</font>
		
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mPacketTable <font color="#990000">&amp;&amp;</font> inPacket <font color="#990000">&gt;=</font> packetTableSize<font color="#990000">)</font>
			<b><font color="#0000FF">return</font></b> kAudioFileEndOfFileError<font color="#990000">;</font>
		
		CompressedPacketTable<font color="#990000">*</font> packetTable <font color="#990000">=</font> <b><font color="#000000">GetPacketTable</font></b><font color="#990000">();</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>packetTable<font color="#990000">)</font>
			<b><font color="#0000FF">return</font></b> kAudioFileInvalidPacketOffsetError<font color="#990000">;</font>
			
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inPacket <font color="#990000">&lt;</font> <font color="#993399">0</font> <font color="#990000">||</font> inPacket <font color="#990000">&gt;=</font> packetTableSize<font color="#990000">)</font>
			<b><font color="#0000FF">return</font></b> kAudioFileInvalidPacketOffsetError<font color="#990000">;</font>
			
		outFirstFrameInPacket <font color="#990000">=</font> <font color="#990000">(*</font>packetTable<font color="#990000">)[(</font>size_t<font color="#990000">)</font>inPacket<font color="#990000">].</font>mFrameOffset<font color="#990000">;</font>
	<font color="#FF0000">}</font>
	<b><font color="#0000FF">else</font></b>
	<font color="#FF0000">{</font>
		outFirstFrameInPacket <font color="#990000">=</font> inPacket <font color="#990000">*</font> mDataFormat<font color="#990000">.</font>mFramesPerPacket<font color="#990000">;</font>
	<font color="#FF0000">}</font>
	<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">FrameToPacket</font></b><font color="#990000">(</font><font color="#008080">SInt64</font> inFrame<font color="#990000">,</font> SInt64<font color="#990000">&amp;</font> outPacket<font color="#990000">,</font> UInt32<font color="#990000">&amp;</font> outFrameOffsetInPacket<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mDataFormat<font color="#990000">.</font>mFramesPerPacket <font color="#990000">==</font> <font color="#993399">0</font><font color="#990000">)</font>
	<font color="#FF0000">{</font>
		CompressedPacketTable<font color="#990000">*</font> packetTable <font color="#990000">=</font> <b><font color="#000000">GetPacketTable</font></b><font color="#990000">();</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>packetTable<font color="#990000">)</font>
			<b><font color="#0000FF">return</font></b> kAudioFileInvalidPacketOffsetError<font color="#990000">;</font>
			
		<i><font color="#9A1900">// search packet table</font></i>
		<font color="#008080">AudioStreamPacketDescriptionExtended</font> pext<font color="#990000">;</font>
		<b><font color="#000000">memset</font></b><font color="#990000">(&amp;</font>pext<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>pext<font color="#990000">));</font>
		pext<font color="#990000">.</font>mFrameOffset <font color="#990000">=</font> inFrame<font color="#990000">;</font>
		CompressedPacketTable<font color="#990000">::</font><font color="#008080">iterator</font> iter <font color="#990000">=</font> std<font color="#990000">::</font><b><font color="#000000">lower_bound</font></b><font color="#990000">(</font>packetTable<font color="#990000">-&gt;</font><b><font color="#000000">begin</font></b><font color="#990000">(),</font> packetTable<font color="#990000">-&gt;</font><b><font color="#000000">end</font></b><font color="#990000">(),</font> pext<font color="#990000">);</font>
		
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>iter <font color="#990000">==</font> packetTable<font color="#990000">-&gt;</font><b><font color="#000000">end</font></b><font color="#990000">())</font>
			<b><font color="#0000FF">return</font></b> kAudioFileInvalidPacketOffsetError<font color="#990000">;</font>
		
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>iter <font color="#990000">&gt;</font> packetTable<font color="#990000">-&gt;</font><b><font color="#000000">begin</font></b><font color="#990000">())</font> <font color="#990000">--</font>iter<font color="#990000">;</font>
		
		outPacket <font color="#990000">=</font> iter <font color="#990000">-</font> packetTable<font color="#990000">-&gt;</font><b><font color="#000000">begin</font></b><font color="#990000">();</font>
		outFrameOffsetInPacket <font color="#990000">=</font> <font color="#990000">(</font>UInt32<font color="#990000">)(</font>inFrame <font color="#990000">-</font> iter<font color="#990000">-&gt;</font>mFrameOffset<font color="#990000">);</font>
	<font color="#FF0000">}</font>
	<b><font color="#0000FF">else</font></b>
	<font color="#FF0000">{</font>
		outPacket <font color="#990000">=</font> inFrame <font color="#990000">/</font> mDataFormat<font color="#990000">.</font>mFramesPerPacket<font color="#990000">;</font>
		outFrameOffsetInPacket <font color="#990000">=</font> <font color="#990000">(</font>UInt32<font color="#990000">)(</font>inFrame <font color="#990000">%</font> mDataFormat<font color="#990000">.</font>mFramesPerPacket<font color="#990000">);</font>
	<font color="#FF0000">}</font>
	<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">PacketToByte</font></b><font color="#990000">(</font>AudioBytePacketTranslation<font color="#990000">*</font> abpt<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mDataFormat<font color="#990000">.</font>mBytesPerPacket <font color="#990000">==</font> <font color="#993399">0</font><font color="#990000">)</font>
	<font color="#FF0000">{</font>
		CompressedPacketTable<font color="#990000">*</font> packetTable <font color="#990000">=</font> <b><font color="#000000">GetPacketTable</font></b><font color="#990000">();</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>packetTable<font color="#990000">)</font>
			<b><font color="#0000FF">return</font></b> kAudioFileInvalidPacketOffsetError<font color="#990000">;</font>
			
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>abpt<font color="#990000">-&gt;</font>mPacket <font color="#990000">&lt;</font> <font color="#993399">0</font><font color="#990000">)</font>
			<b><font color="#0000FF">return</font></b> kAudioFileInvalidPacketOffsetError<font color="#990000">;</font>

		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>abpt<font color="#990000">-&gt;</font>mPacket <font color="#990000">&lt;</font> <b><font color="#000000">GetPacketTableSize</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
			abpt<font color="#990000">-&gt;</font>mByte <font color="#990000">=</font> <font color="#990000">(*</font>packetTable<font color="#990000">)[(</font><font color="#009900">int</font><font color="#990000">)</font>abpt<font color="#990000">-&gt;</font>mPacket<font color="#990000">].</font>mStartOffset<font color="#990000">;</font>
			abpt<font color="#990000">-&gt;</font>mFlags <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
		<font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
			<font color="#008080">SInt64</font> numPackets <font color="#990000">=</font> packetTable<font color="#990000">-&gt;</font><b><font color="#000000">size</font></b><font color="#990000">();</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>numPackets <font color="#990000">&lt;</font> <font color="#993399">8</font><font color="#990000">)</font> 
				<b><font color="#0000FF">return</font></b> <font color="#FF0000">'more'</font> <i><font color="#9A1900">/*kAudioFileStreamError_DataUnavailable*/</font></i> <font color="#990000">;</font>
				
			<b><font color="#0000FF">const</font></b> <font color="#008080">AudioStreamPacketDescriptionExtended</font> lastPacket <font color="#990000">=</font> <font color="#990000">(*</font>packetTable<font color="#990000">)[</font>numPackets <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">];</font>
			<font color="#008080">SInt64</font> bytesReadSoFar <font color="#990000">=</font> lastPacket<font color="#990000">.</font>mStartOffset <font color="#990000">+</font> lastPacket<font color="#990000">.</font>mDataByteSize<font color="#990000">;</font>
			<font color="#009900">double</font> averageBytesPerPacket <font color="#990000">=</font> <font color="#990000">(</font><font color="#009900">double</font><font color="#990000">)(</font>bytesReadSoFar <font color="#990000">-</font> <b><font color="#000000">GetDataOffset</font></b><font color="#990000">())</font> <font color="#990000">/</font> <font color="#990000">(</font><font color="#009900">double</font><font color="#990000">)</font>numPackets<font color="#990000">;</font>
			abpt<font color="#990000">-&gt;</font>mByte <font color="#990000">=</font> <font color="#990000">(</font>SInt64<font color="#990000">)</font><b><font color="#000000">floor</font></b><font color="#990000">((</font><font color="#009900">double</font><font color="#990000">)</font>abpt<font color="#990000">-&gt;</font>mPacket <font color="#990000">*</font> averageBytesPerPacket<font color="#990000">);</font>
			abpt<font color="#990000">-&gt;</font>mFlags <font color="#990000">=</font> kBytePacketTranslationFlag_IsEstimate<font color="#990000">;</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font>
	<b><font color="#0000FF">else</font></b>
	<font color="#FF0000">{</font>
		abpt<font color="#990000">-&gt;</font>mByte <font color="#990000">=</font> abpt<font color="#990000">-&gt;</font>mPacket <font color="#990000">*</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">;</font>
		abpt<font color="#990000">-&gt;</font>mFlags <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	<font color="#FF0000">}</font>
	<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<b><font color="#0000FF">inline</font></b> <font color="#009900">bool</font> <b><font color="#000000">byte_less_than</font></b> <font color="#990000">(</font><b><font color="#0000FF">const</font></b> AudioStreamPacketDescriptionExtended<font color="#990000">&amp;</font> a<font color="#990000">,</font> <b><font color="#0000FF">const</font></b> AudioStreamPacketDescriptionExtended<font color="#990000">&amp;</font> b<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">return</font></b> a<font color="#990000">.</font>mStartOffset <font color="#990000">&lt;</font> b<font color="#990000">.</font>mStartOffset<font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">ByteToPacket</font></b><font color="#990000">(</font>AudioBytePacketTranslation<font color="#990000">*</font> abpt<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mDataFormat<font color="#990000">.</font>mBytesPerPacket <font color="#990000">==</font> <font color="#993399">0</font><font color="#990000">)</font>
	<font color="#FF0000">{</font>
		CompressedPacketTable<font color="#990000">*</font> packetTable <font color="#990000">=</font> <b><font color="#000000">GetPacketTable</font></b><font color="#990000">();</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>packetTable<font color="#990000">)</font>
			<b><font color="#0000FF">return</font></b> kAudioFileInvalidPacketOffsetError<font color="#990000">;</font>
			<i><font color="#9A1900">// search packet table</font></i>
		<font color="#008080">AudioStreamPacketDescriptionExtended</font> pext<font color="#990000">;</font>
		<b><font color="#000000">memset</font></b><font color="#990000">(&amp;</font>pext<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>pext<font color="#990000">));</font>
		pext<font color="#990000">.</font>mStartOffset <font color="#990000">=</font> abpt<font color="#990000">-&gt;</font>mByte<font color="#990000">;</font>
		CompressedPacketTable<font color="#990000">::</font><font color="#008080">iterator</font> iter <font color="#990000">=</font> std<font color="#990000">::</font><b><font color="#000000">lower_bound</font></b><font color="#990000">(</font>packetTable<font color="#990000">-&gt;</font><b><font color="#000000">begin</font></b><font color="#990000">(),</font> packetTable<font color="#990000">-&gt;</font><b><font color="#000000">end</font></b><font color="#990000">(),</font> pext<font color="#990000">,</font> byte_less_than<font color="#990000">);</font>
		
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>iter <font color="#990000">==</font> packetTable<font color="#990000">-&gt;</font><b><font color="#000000">end</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
			<font color="#008080">SInt64</font> numPackets <font color="#990000">=</font> packetTable<font color="#990000">-&gt;</font><b><font color="#000000">size</font></b><font color="#990000">();</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>numPackets <font color="#990000">&lt;</font> <font color="#993399">8</font><font color="#990000">)</font> 
				<b><font color="#0000FF">return</font></b> <font color="#FF0000">'more'</font> <i><font color="#9A1900">/*kAudioFileStreamError_DataUnavailable*/</font></i> <font color="#990000">;</font>
				
			<b><font color="#0000FF">const</font></b> <font color="#008080">AudioStreamPacketDescriptionExtended</font> lastPacket <font color="#990000">=</font> <font color="#990000">(*</font>packetTable<font color="#990000">)[</font>numPackets <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">];</font>
			<font color="#008080">SInt64</font> bytesReadSoFar <font color="#990000">=</font> lastPacket<font color="#990000">.</font>mStartOffset <font color="#990000">+</font> lastPacket<font color="#990000">.</font>mDataByteSize<font color="#990000">;</font>
			<font color="#009900">double</font> averageBytesPerPacket <font color="#990000">=</font> <font color="#990000">(</font><font color="#009900">double</font><font color="#990000">)(</font>bytesReadSoFar <font color="#990000">-</font> <b><font color="#000000">GetDataOffset</font></b><font color="#990000">())</font> <font color="#990000">/</font> <font color="#990000">(</font><font color="#009900">double</font><font color="#990000">)</font>numPackets<font color="#990000">;</font>
			
			<font color="#009900">double</font> fpacket <font color="#990000">=</font> <font color="#990000">(</font><font color="#009900">double</font><font color="#990000">)</font>abpt<font color="#990000">-&gt;</font>mByte <font color="#990000">/</font> averageBytesPerPacket<font color="#990000">;</font>
			abpt<font color="#990000">-&gt;</font>mPacket <font color="#990000">=</font> <font color="#990000">(</font>SInt64<font color="#990000">)</font><b><font color="#000000">floor</font></b><font color="#990000">(</font>fpacket<font color="#990000">);</font>
			abpt<font color="#990000">-&gt;</font>mByteOffsetInPacket <font color="#990000">=</font> <font color="#990000">(</font>UInt32<font color="#990000">)</font><b><font color="#000000">floor</font></b><font color="#990000">((</font>fpacket <font color="#990000">-</font> <font color="#990000">(</font><font color="#009900">double</font><font color="#990000">)</font>abpt<font color="#990000">-&gt;</font>mPacket<font color="#990000">)</font> <font color="#990000">*</font> averageBytesPerPacket<font color="#990000">);</font>
			abpt<font color="#990000">-&gt;</font>mFlags <font color="#990000">=</font> kBytePacketTranslationFlag_IsEstimate<font color="#990000">;</font>
			
		<font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>iter <font color="#990000">&gt;</font> packetTable<font color="#990000">-&gt;</font><b><font color="#000000">begin</font></b><font color="#990000">())</font> <font color="#990000">--</font>iter<font color="#990000">;</font>
			abpt<font color="#990000">-&gt;</font>mPacket <font color="#990000">=</font> iter <font color="#990000">-</font> packetTable<font color="#990000">-&gt;</font><b><font color="#000000">begin</font></b><font color="#990000">();</font>
			abpt<font color="#990000">-&gt;</font>mByteOffsetInPacket <font color="#990000">=</font> <font color="#990000">(</font>UInt32<font color="#990000">)(</font>abpt<font color="#990000">-&gt;</font>mByte <font color="#990000">-</font> iter<font color="#990000">-&gt;</font>mStartOffset<font color="#990000">);</font>
			abpt<font color="#990000">-&gt;</font>mFlags <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font>
	<b><font color="#0000FF">else</font></b>
	<font color="#FF0000">{</font>
		abpt<font color="#990000">-&gt;</font>mPacket <font color="#990000">=</font> abpt<font color="#990000">-&gt;</font>mByte <font color="#990000">/</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">;</font>
		abpt<font color="#990000">-&gt;</font>mByteOffsetInPacket <font color="#990000">=</font> <font color="#990000">(</font>UInt32<font color="#990000">)(</font>abpt<font color="#990000">-&gt;</font>mByte <font color="#990000">%</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">);</font>
		abpt<font color="#990000">-&gt;</font>mFlags <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	<font color="#FF0000">}</font>
	<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>
<font color="#FF0000">}</font>


<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">ReadBytes</font></b><font color="#990000">(</font>		
								<font color="#008080">Boolean</font>			inUseCache<font color="#990000">,</font>
								<font color="#008080">SInt64</font>			inStartingByte<font color="#990000">,</font> 
								<font color="#008080">UInt32</font>			<font color="#990000">*</font>ioNumBytes<font color="#990000">,</font> 
								<font color="#009900">void</font>			<font color="#990000">*</font>outBuffer<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <font color="#008080">OSStatus</font>		err <font color="#990000">=</font> noErr<font color="#990000">;</font>
    <font color="#008080">UInt16</font>			mode <font color="#990000">=</font> SEEK_SET<font color="#990000">;</font>
	<font color="#008080">SInt64</font> 			fileOffset <font color="#990000">=</font> mDataOffset <font color="#990000">+</font> inStartingByte<font color="#990000">;</font>
    <font color="#009900">bool</font>			readingPastEnd <font color="#990000">=</font> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
	
    <b><font color="#000000">FailWithAction</font></b><font color="#990000">((</font>ioNumBytes <font color="#990000">==</font> NULL<font color="#990000">)</font> <font color="#990000">||</font> <font color="#990000">(</font>outBuffer <font color="#990000">==</font> NULL<font color="#990000">),</font> err <font color="#990000">=</font> kAudio_ParamError<font color="#990000">,</font> 
		Bail<font color="#990000">,</font> <font color="#FF0000">"invalid num bytes parameter"</font><font color="#990000">);</font>

	<i><font color="#9A1900">//printf("inStartingByte %lld  GetNumBytes %lld\n", inStartingByte, GetNumBytes());</font></i>

	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inStartingByte <font color="#990000">&gt;=</font> <b><font color="#000000">GetNumBytes</font></b><font color="#990000">())</font> 
	<font color="#FF0000">{</font>
		<font color="#990000">*</font>ioNumBytes <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
		<b><font color="#0000FF">return</font></b> kAudioFileEndOfFileError<font color="#990000">;</font>
	<font color="#FF0000">}</font>

	<b><font color="#0000FF">if</font></b> <font color="#990000">((</font>fileOffset <font color="#990000">+</font> <font color="#990000">*</font>ioNumBytes<font color="#990000">)</font> <font color="#990000">&gt;</font> <font color="#990000">(</font><b><font color="#000000">GetNumBytes</font></b><font color="#990000">()</font> <font color="#990000">+</font> mDataOffset<font color="#990000">))</font> 
	<font color="#FF0000">{</font>
		<font color="#990000">*</font>ioNumBytes <font color="#990000">=</font> <font color="#990000">(</font>UInt32<font color="#990000">)(</font><b><font color="#000000">GetNumBytes</font></b><font color="#990000">()</font> <font color="#990000">+</font> mDataOffset <font color="#990000">-</font> fileOffset<font color="#990000">);</font>
		readingPastEnd <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
	<font color="#FF0000">}</font>
	<i><font color="#9A1900">//printf("fileOffset %lld  mDataOffset %lld  readingPastEnd %d\n", fileOffset, mDataOffset, readingPastEnd);</font></i>

    <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>inUseCache<font color="#990000">)</font>
        mode <font color="#990000">|=</font> kAudioFileNoCacheMask<font color="#990000">;</font>
	
    err <font color="#990000">=</font> <b><font color="#000000">GetDataSource</font></b><font color="#990000">()-&gt;</font><b><font color="#000000">ReadBytes</font></b><font color="#990000">(</font>mode<font color="#990000">,</font> fileOffset<font color="#990000">,</font> <font color="#990000">*</font>ioNumBytes<font color="#990000">,</font> outBuffer<font color="#990000">,</font> ioNumBytes<font color="#990000">);</font>
	
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>readingPastEnd <font color="#990000">&amp;&amp;</font> err <font color="#990000">==</font> noErr<font color="#990000">)</font>
		err <font color="#990000">=</font> kAudioFileEndOfFileError<font color="#990000">;</font>

<b><font color="#008080">Bail:</font></b>
    <b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>


<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">WriteBytes</font></b><font color="#990000">(</font>	
								<font color="#008080">Boolean</font>			inUseCache<font color="#990000">,</font>
								<font color="#008080">SInt64</font>			inStartingByte<font color="#990000">,</font> 
								<font color="#008080">UInt32</font>			<font color="#990000">*</font>ioNumBytes<font color="#990000">,</font> 
								<b><font color="#0000FF">const</font></b> <font color="#009900">void</font>		<font color="#990000">*</font>inBuffer<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <font color="#008080">OSStatus</font>		err <font color="#990000">=</font> noErr<font color="#990000">;</font>
    <font color="#008080">UInt16</font>			mode <font color="#990000">=</font> SEEK_SET<font color="#990000">;</font>
	<font color="#009900">bool</font>			extendingTheAudioData<font color="#990000">;</font>

	<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font><b><font color="#000000">CanWrite</font></b><font color="#990000">())</font> <b><font color="#0000FF">return</font></b> kAudioFilePermissionsError<font color="#990000">;</font>

    <b><font color="#000000">FailWithAction</font></b><font color="#990000">((</font>ioNumBytes <font color="#990000">==</font> NULL<font color="#990000">)</font> <font color="#990000">||</font> <font color="#990000">(</font>inBuffer <font color="#990000">==</font> NULL<font color="#990000">),</font> err <font color="#990000">=</font> kAudioFileUnspecifiedError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"invalid parameters"</font><font color="#990000">);</font>

    <i><font color="#9A1900">// Do not try to write to a postion greater than 32 bits for some file types</font></i>
    <i><font color="#9A1900">// see if starting byte + ioNumBytes is greater than 32 bits</font></i>
    <i><font color="#9A1900">// if so, see if file type supports this and bail if not</font></i>
    err <font color="#990000">=</font> <b><font color="#000000">IsValidFilePosition</font></b><font color="#990000">(</font>inStartingByte <font color="#990000">+</font> <font color="#990000">*</font>ioNumBytes<font color="#990000">);</font>
    <b><font color="#000000">FailIf</font></b><font color="#990000">(</font>err <font color="#990000">!=</font> noErr<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"invalid file position"</font><font color="#990000">);</font>
    
    extendingTheAudioData <font color="#990000">=</font> inStartingByte <font color="#990000">+</font> <font color="#990000">*</font>ioNumBytes <font color="#990000">&gt;</font> <b><font color="#000000">GetNumBytes</font></b><font color="#990000">();</font>
    
    <i><font color="#9A1900">// if file is not optimized, then do not write data that would overwrite chunks following the sound data chunk</font></i>
    <b><font color="#000000">FailWithAction</font></b><font color="#990000">(</font>	extendingTheAudioData <font color="#990000">&amp;&amp;</font> <font color="#990000">!</font><b><font color="#000000">IsOptimized</font></b><font color="#990000">(),</font> 
                    err <font color="#990000">=</font> kAudioFileNotOptimizedError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"Can't write more data until the file is optimized"</font><font color="#990000">);</font>

    <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>inUseCache<font color="#990000">)</font>
        mode <font color="#990000">|=</font> kAudioFileNoCacheMask<font color="#990000">;</font>
    
    err <font color="#990000">=</font> <b><font color="#000000">GetDataSource</font></b><font color="#990000">()-&gt;</font><b><font color="#000000">WriteBytes</font></b><font color="#990000">(</font>mode<font color="#990000">,</font> mDataOffset <font color="#990000">+</font> inStartingByte<font color="#990000">,</font> <font color="#990000">*</font>ioNumBytes<font color="#990000">,</font> 
                        inBuffer<font color="#990000">,</font> ioNumBytes<font color="#990000">);</font>
	
    <b><font color="#000000">FailIf</font></b><font color="#990000">(</font>err <font color="#990000">!=</font> noErr<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"couldn't write new data"</font><font color="#990000">);</font>
    
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>extendingTheAudioData<font color="#990000">)</font> <font color="#FF0000">{</font>
        <font color="#008080">SInt64</font>		nuEOF<font color="#990000">;</font>						<i><font color="#9A1900">// Get the total bytes of audio data</font></i>
        <font color="#008080">SInt64</font>		nuByteTotal<font color="#990000">;</font>

		err <font color="#990000">=</font> <b><font color="#000000">GetDataSource</font></b><font color="#990000">()-&gt;</font><b><font color="#000000">GetSize</font></b><font color="#990000">(</font>nuEOF<font color="#990000">);</font>
		<b><font color="#000000">FailIf</font></b><font color="#990000">(</font>err <font color="#990000">!=</font> noErr<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"GetSize failed"</font><font color="#990000">);</font>
            
		nuByteTotal <font color="#990000">=</font> nuEOF <font color="#990000">-</font> mDataOffset<font color="#990000">;</font>
		err <font color="#990000">=</font> <b><font color="#000000">UpdateNumBytes</font></b><font color="#990000">(</font>nuByteTotal<font color="#990000">);</font>
    <font color="#FF0000">}</font>
    
<b><font color="#008080">Bail:</font></b>
    <b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">ReadPackets</font></b><font color="#990000">(</font>	
								<font color="#008080">Boolean</font>							inUseCache<font color="#990000">,</font>
								<font color="#008080">UInt32</font>							<font color="#990000">*</font>outNumBytes<font color="#990000">,</font>
								<font color="#008080">AudioStreamPacketDescription</font>	<font color="#990000">*</font>outPacketDescriptions<font color="#990000">,</font>
								<font color="#008080">SInt64</font>							inStartingPacket<font color="#990000">,</font> 
								<font color="#008080">UInt32</font>  						<font color="#990000">*</font>ioNumPackets<font color="#990000">,</font> 
								<font color="#009900">void</font>							<font color="#990000">*</font>outBuffer<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<i><font color="#9A1900">// This only works with CBR. To suppport VBR you must override.</font></i>
    <font color="#008080">OSStatus</font>		err <font color="#990000">=</font> noErr<font color="#990000">;</font>
    
    <b><font color="#000000">FailWithAction</font></b><font color="#990000">(</font>outBuffer <font color="#990000">==</font> NULL<font color="#990000">,</font> err <font color="#990000">=</font> kAudio_ParamError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"NULL buffer"</font><font color="#990000">);</font>
	
    <b><font color="#000000">FailWithAction</font></b><font color="#990000">((</font>ioNumPackets <font color="#990000">==</font> NULL<font color="#990000">)</font> <font color="#990000">||</font> <font color="#990000">(*</font>ioNumPackets <font color="#990000">&lt;</font> <font color="#993399">1</font><font color="#990000">),</font> err <font color="#990000">=</font> kAudio_ParamError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"invalid num packets parameter"</font><font color="#990000">);</font>
    
	<font color="#FF0000">{</font>
		<font color="#008080">UInt32</font>			byteCount <font color="#990000">=</font> <font color="#990000">*</font>ioNumPackets <font color="#990000">*</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">;</font>
		<font color="#008080">SInt64</font>			startingByte <font color="#990000">=</font> inStartingPacket <font color="#990000">*</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">;</font>
			
		err <font color="#990000">=</font> <b><font color="#000000">ReadBytes</font></b> <font color="#990000">(</font>inUseCache<font color="#990000">,</font> startingByte<font color="#990000">,</font> <font color="#990000">&amp;</font>byteCount<font color="#990000">,</font> outBuffer<font color="#990000">);</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">((</font>err <font color="#990000">==</font> noErr<font color="#990000">)</font> <font color="#990000">||</font> <font color="#990000">(</font>err <font color="#990000">==</font> kAudioFileEndOfFileError<font color="#990000">))</font>
		<font color="#FF0000">{</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>byteCount <font color="#990000">!=</font> <font color="#990000">(*</font>ioNumPackets <font color="#990000">*</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">))</font>
			<font color="#FF0000">{</font>
				<font color="#990000">*</font>ioNumPackets <font color="#990000">=</font> byteCount <font color="#990000">/</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">;</font>
				byteCount <font color="#990000">=</font> <font color="#990000">*</font>ioNumPackets <font color="#990000">*</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">;</font>
			<font color="#FF0000">}</font>

			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outNumBytes<font color="#990000">)</font>
				<font color="#990000">*</font>outNumBytes <font color="#990000">=</font> byteCount<font color="#990000">;</font>
			
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>err <font color="#990000">==</font> kAudioFileEndOfFileError<font color="#990000">)</font>
				err <font color="#990000">=</font> noErr<font color="#990000">;</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font>
<b><font color="#008080">Bail:</font></b>
    <b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>


<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>
<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>


<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">ReadPacketData</font></b><font color="#990000">(</font>	
								<font color="#008080">Boolean</font>							inUseCache<font color="#990000">,</font>
								<font color="#008080">UInt32</font>							<font color="#990000">*</font>ioNumBytes<font color="#990000">,</font>
								<font color="#008080">AudioStreamPacketDescription</font>	<font color="#990000">*</font>outPacketDescriptions<font color="#990000">,</font>
								<font color="#008080">SInt64</font>							inStartingPacket<font color="#990000">,</font> 
								<font color="#008080">UInt32</font>  						<font color="#990000">*</font>ioNumPackets<font color="#990000">,</font> 
								<font color="#009900">void</font>							<font color="#990000">*</font>outBuffer<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<font color="#008080">OSStatus</font>		err <font color="#990000">=</font> noErr<font color="#990000">;</font>
	<b><font color="#000000">FailWithAction</font></b><font color="#990000">(</font>ioNumPackets <font color="#990000">==</font> NULL <font color="#990000">||</font> <font color="#990000">*</font>ioNumPackets <font color="#990000">&lt;</font> <font color="#993399">1</font><font color="#990000">,</font> err <font color="#990000">=</font> kAudio_ParamError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"invalid ioNumPackets parameter"</font><font color="#990000">);</font>
	<b><font color="#000000">FailWithAction</font></b><font color="#990000">(</font>ioNumBytes   <font color="#990000">==</font> NULL <font color="#990000">||</font> <font color="#990000">*</font>ioNumBytes   <font color="#990000">&lt;</font> <font color="#993399">1</font><font color="#990000">,</font> err <font color="#990000">=</font> kAudio_ParamError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"invalid ioNumBytes parameter"</font><font color="#990000">);</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">)</font> <font color="#FF0000">{</font>
	 	<i><font color="#9A1900">// CBR</font></i>
		<b><font color="#000000">FailWithAction</font></b><font color="#990000">(</font>outBuffer    <font color="#990000">==</font> NULL<font color="#990000">,</font> err <font color="#990000">=</font> kAudio_ParamError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"NULL buffer"</font><font color="#990000">);</font>
		<font color="#008080">UInt32</font> maxPackets <font color="#990000">=</font> <font color="#990000">*</font>ioNumBytes <font color="#990000">/</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">;</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(*</font>ioNumPackets <font color="#990000">&gt;</font> maxPackets<font color="#990000">)</font> <font color="#990000">*</font>ioNumPackets <font color="#990000">=</font> maxPackets<font color="#990000">;</font>

		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outBuffer<font color="#990000">)</font> <font color="#FF0000">{</font>
			<font color="#008080">UInt32</font> byteCount <font color="#990000">=</font> <font color="#990000">*</font>ioNumPackets <font color="#990000">*</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">;</font>
			<font color="#008080">SInt64</font> startingByte <font color="#990000">=</font> inStartingPacket <font color="#990000">*</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">;</font>
			err <font color="#990000">=</font> <b><font color="#000000">ReadBytes</font></b> <font color="#990000">(</font>inUseCache<font color="#990000">,</font> startingByte<font color="#990000">,</font> <font color="#990000">&amp;</font>byteCount<font color="#990000">,</font> outBuffer<font color="#990000">);</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>err <font color="#990000">==</font> noErr <font color="#990000">||</font> err <font color="#990000">==</font> kAudioFileEndOfFileError<font color="#990000">)</font> <font color="#FF0000">{</font>
				<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>byteCount <font color="#990000">!=</font> <font color="#990000">(*</font>ioNumPackets <font color="#990000">*</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">))</font> <font color="#FF0000">{</font>
					<font color="#990000">*</font>ioNumPackets <font color="#990000">=</font> byteCount <font color="#990000">/</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">;</font>
					byteCount <font color="#990000">=</font> <font color="#990000">*</font>ioNumPackets <font color="#990000">*</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">;</font>
				<font color="#FF0000">}</font>
				<font color="#990000">*</font>ioNumBytes <font color="#990000">=</font> byteCount<font color="#990000">;</font>
			<font color="#FF0000">}</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
		<b><font color="#000000">FailWithAction</font></b><font color="#990000">(</font>outPacketDescriptions   <font color="#990000">==</font> NULL<font color="#990000">,</font> err <font color="#990000">=</font> kAudio_ParamError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"invalid outPacketDescriptions parameter"</font><font color="#990000">);</font>
		err <font color="#990000">=</font> <b><font color="#000000">ReadPacketDataVBR</font></b><font color="#990000">(</font>inUseCache<font color="#990000">,</font> ioNumBytes<font color="#990000">,</font> outPacketDescriptions<font color="#990000">,</font> inStartingPacket<font color="#990000">,</font> ioNumPackets<font color="#990000">,</font> outBuffer<font color="#990000">);</font>
	<font color="#FF0000">}</font>
<b><font color="#008080">Bail:</font></b>
	<b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">ReadPacketDataVBR</font></b><font color="#990000">(</font>	
								<font color="#008080">Boolean</font>							inUseCache<font color="#990000">,</font>
								<font color="#008080">UInt32</font>							<font color="#990000">*</font>ioNumBytes<font color="#990000">,</font>
								<font color="#008080">AudioStreamPacketDescription</font>	<font color="#990000">*</font>outPacketDescriptions<font color="#990000">,</font>
								<font color="#008080">SInt64</font>							inStartingPacket<font color="#990000">,</font> 
								<font color="#008080">UInt32</font>  						<font color="#990000">*</font>ioNumPackets<font color="#990000">,</font> 
								<font color="#009900">void</font>							<font color="#990000">*</font>outBuffer<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<font color="#008080">OSStatus</font> err <font color="#990000">=</font> <b><font color="#000000">ScanForPackets</font></b><font color="#990000">(</font>inStartingPacket<font color="#990000">+</font><font color="#993399">1</font><font color="#990000">);</font> <i><font color="#9A1900">// need to scan packets up to start</font></i>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>err <font color="#990000">&amp;&amp;</font> err <font color="#990000">!=</font> kAudioFileEndOfFileError<font color="#990000">)</font>
		<b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>

	<font color="#008080">SInt64</font> dataOffset <font color="#990000">=</font> <b><font color="#000000">GetDataOffset</font></b><font color="#990000">();</font>

	CompressedPacketTable<font color="#990000">*</font> packetTable <font color="#990000">=</font> <b><font color="#000000">GetPacketTable</font></b><font color="#990000">();</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>packetTable<font color="#990000">)</font> 
		<b><font color="#0000FF">return</font></b> kAudioFileInvalidFileError<font color="#990000">;</font>

	<font color="#008080">SInt64</font> packetTableSize <font color="#990000">=</font> <b><font color="#000000">GetPacketTableSize</font></b><font color="#990000">();</font>

	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inStartingPacket <font color="#990000">&gt;=</font> packetTableSize<font color="#990000">)</font> <font color="#FF0000">{</font>
		<font color="#990000">*</font>ioNumBytes <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
		<font color="#990000">*</font>ioNumPackets <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
		<b><font color="#0000FF">return</font></b> kAudioFileEndOfFileError<font color="#990000">;</font>
	<font color="#FF0000">}</font>
	
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inStartingPacket <font color="#990000">+</font> <font color="#990000">*</font>ioNumPackets <font color="#990000">&lt;=</font> packetTableSize<font color="#990000">)</font> <font color="#FF0000">{</font>
		err <font color="#990000">=</font> <b><font color="#000000">ReadPacketDataVBR_InTable</font></b><font color="#990000">(</font>inUseCache<font color="#990000">,</font> ioNumBytes<font color="#990000">,</font> outPacketDescriptions<font color="#990000">,</font> inStartingPacket<font color="#990000">,</font> ioNumPackets<font color="#990000">,</font> outBuffer<font color="#990000">);</font>
	<font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>

		<font color="#008080">AudioStreamPacketDescription</font> firstPacket <font color="#990000">=</font> <font color="#990000">(*</font>packetTable<font color="#990000">)[</font>inStartingPacket<font color="#990000">];</font>
		<font color="#008080">SInt64</font> firstPacketOffset <font color="#990000">=</font> firstPacket<font color="#990000">.</font>mStartOffset<font color="#990000">;</font>
		<font color="#008080">UInt32</font> bytesRead <font color="#990000">=</font> <font color="#990000">*</font>ioNumBytes<font color="#990000">;</font>
		<font color="#008080">SInt64</font> fileSize <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
		<b><font color="#000000">GetDataSource</font></b><font color="#990000">()-&gt;</font><b><font color="#000000">GetSize</font></b><font color="#990000">(</font>fileSize<font color="#990000">);</font>
		<font color="#008080">SInt64</font> remainingBytesInFile <font color="#990000">=</font> fileSize <font color="#990000">-</font> firstPacketOffset <font color="#990000">-</font> dataOffset<font color="#990000">;</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>bytesRead <font color="#990000">&gt;</font> remainingBytesInFile<font color="#990000">)</font>
			bytesRead <font color="#990000">=</font> <font color="#990000">(</font>UInt32<font color="#990000">)</font>remainingBytesInFile<font color="#990000">;</font>
		
		err <font color="#990000">=</font> <b><font color="#000000">ReadBytes</font></b> <font color="#990000">(</font>inUseCache<font color="#990000">,</font> firstPacketOffset<font color="#990000">,</font> <font color="#990000">&amp;</font>bytesRead<font color="#990000">,</font> outBuffer<font color="#990000">);</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>err <font color="#990000">&amp;&amp;</font> err <font color="#990000">!=</font> kAudioFileEndOfFileError<font color="#990000">)</font> <font color="#FF0000">{</font>
			<font color="#990000">*</font>ioNumBytes <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
			<font color="#990000">*</font>ioNumPackets <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
			<b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
		<font color="#FF0000">}</font>
		
		<font color="#008080">Buffer_DataSource</font> <b><font color="#000000">bufSrc</font></b><font color="#990000">(</font>bytesRead<font color="#990000">,</font> outBuffer<font color="#990000">,</font> dataOffset <font color="#990000">+</font> firstPacketOffset<font color="#990000">);</font>
		
		<font color="#008080">OSStatus</font> scanErr <font color="#990000">=</font> <b><font color="#000000">ScanForPackets</font></b><font color="#990000">(</font>0x7fffFFFFffffFFFFLL<font color="#990000">,</font> <font color="#990000">&amp;</font>bufSrc<font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">);</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>scanErr <font color="#990000">&amp;&amp;</font> scanErr <font color="#990000">!=</font> kAudioFileEndOfFileError<font color="#990000">)</font>
			<b><font color="#0000FF">return</font></b> scanErr<font color="#990000">;</font>
		packetTableSize <font color="#990000">=</font> packetTable<font color="#990000">-&gt;</font><b><font color="#000000">size</font></b><font color="#990000">();</font>
		
		<font color="#008080">UInt32</font> numPacketsRead <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
		<font color="#008080">UInt32</font> endOfData <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
		<font color="#008080">SInt64</font> packetNumber <font color="#990000">=</font> inStartingPacket<font color="#990000">;</font>
		<b><font color="#0000FF">for</font></b> <font color="#990000">(;</font> numPacketsRead <font color="#990000">&lt;</font> <font color="#990000">*</font>ioNumPackets <font color="#990000">&amp;&amp;</font> packetNumber <font color="#990000">&lt;</font> packetTableSize<font color="#990000">;</font> <font color="#990000">++</font>numPacketsRead<font color="#990000">,</font> <font color="#990000">++</font>packetNumber<font color="#990000">)</font> <font color="#FF0000">{</font>
			<font color="#008080">AudioStreamPacketDescription</font> curPacket <font color="#990000">=</font> <font color="#990000">(*</font>packetTable<font color="#990000">)[</font>numPacketsRead <font color="#990000">+</font> inStartingPacket<font color="#990000">];</font>
			<font color="#008080">SInt64</font> curPacketOffset <font color="#990000">=</font> curPacket<font color="#990000">.</font>mStartOffset <font color="#990000">-</font> firstPacketOffset<font color="#990000">;</font>
			<font color="#008080">SInt64</font> endOfPacket <font color="#990000">=</font> curPacketOffset <font color="#990000">+</font> curPacket<font color="#990000">.</font>mDataByteSize<font color="#990000">;</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>endOfPacket <font color="#990000">&gt;</font> bytesRead<font color="#990000">)</font> <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
			endOfData <font color="#990000">=</font> <font color="#990000">(</font>UInt32<font color="#990000">)</font>endOfPacket<font color="#990000">;</font>
			outPacketDescriptions<font color="#990000">[</font>numPacketsRead<font color="#990000">]</font> <font color="#990000">=</font> curPacket<font color="#990000">;</font>				
			outPacketDescriptions<font color="#990000">[</font>numPacketsRead<font color="#990000">].</font>mStartOffset <font color="#990000">=</font> curPacketOffset<font color="#990000">;</font>
		<font color="#FF0000">}</font>
		
		<font color="#990000">*</font>ioNumBytes <font color="#990000">=</font> endOfData<font color="#990000">;</font>
		<font color="#990000">*</font>ioNumPackets <font color="#990000">=</font> numPacketsRead<font color="#990000">;</font>
	<font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>


<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>
<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">HowManyPacketsCanBeReadIntoBuffer</font></b><font color="#990000">(</font>UInt32<font color="#990000">*</font> ioNumBytes<font color="#990000">,</font> <font color="#008080">SInt64</font> inStartingPacket<font color="#990000">,</font> <font color="#008080">UInt32</font> <font color="#990000">*</font>ioNumPackets<font color="#990000">)</font>
<font color="#FF0000">{</font>		
	CompressedPacketTable<font color="#990000">*</font>	packetTable <font color="#990000">=</font> <b><font color="#000000">GetPacketTable</font></b><font color="#990000">();</font>
	<font color="#008080">SInt64</font> packetTableSize <font color="#990000">=</font> <b><font color="#000000">GetPacketTableSize</font></b><font color="#990000">();</font>

	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inStartingPacket <font color="#990000">+</font> <font color="#990000">*</font>ioNumPackets <font color="#990000">&gt;</font> <font color="#990000">(</font>SInt64<font color="#990000">)</font>packetTableSize<font color="#990000">)</font> <font color="#FF0000">{</font>
		<font color="#990000">*</font>ioNumPackets <font color="#990000">=</font> <font color="#990000">(</font>UInt32<font color="#990000">)(</font>packetTableSize <font color="#990000">-</font> inStartingPacket<font color="#990000">);</font>
	<font color="#FF0000">}</font>
	
	<font color="#008080">AudioStreamPacketDescription</font> firstPacket <font color="#990000">=</font> <font color="#990000">(*</font>packetTable<font color="#990000">)[</font>inStartingPacket<font color="#990000">];</font>

	<b><font color="#0000FF">if</font></b> <font color="#990000">(*</font>ioNumBytes <font color="#990000">&lt;</font> firstPacket<font color="#990000">.</font>mDataByteSize<font color="#990000">)</font> <font color="#FF0000">{</font>
		<font color="#990000">*</font>ioNumBytes <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
		<font color="#990000">*</font>ioNumPackets <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
		<b><font color="#0000FF">return</font></b> kAudio_ParamError<font color="#990000">;</font>
	<font color="#FF0000">}</font>

	<font color="#008080">SInt64</font> lastPacketIndex <font color="#990000">=</font> inStartingPacket <font color="#990000">+</font> <font color="#990000">*</font>ioNumPackets <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>lastPacketIndex <font color="#990000">&gt;=</font> packetTableSize<font color="#990000">)</font> 
		lastPacketIndex <font color="#990000">=</font> packetTableSize <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">;</font>
		
	<font color="#008080">AudioStreamPacketDescription</font> lastPacket <font color="#990000">=</font> <font color="#990000">(*</font>packetTable<font color="#990000">)[</font>lastPacketIndex<font color="#990000">];</font>
	
	<font color="#008080">SInt64</font> readBytes <font color="#990000">=</font> lastPacket<font color="#990000">.</font>mStartOffset <font color="#990000">+</font> lastPacket<font color="#990000">.</font>mDataByteSize <font color="#990000">-</font> firstPacket<font color="#990000">.</font>mStartOffset<font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>readBytes <font color="#990000">&lt;=</font> <font color="#990000">*</font>ioNumBytes<font color="#990000">)</font> <font color="#FF0000">{</font>
		<font color="#990000">*</font>ioNumBytes <font color="#990000">=</font> <font color="#990000">(</font>UInt32<font color="#990000">)</font>readBytes<font color="#990000">;</font>
		<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>
	<font color="#FF0000">}</font>
	
	<font color="#008080">SInt64</font> lowBound <font color="#990000">=</font> inStartingPacket<font color="#990000">;</font>
	<font color="#008080">SInt64</font> highBound <font color="#990000">=</font> lastPacketIndex <font color="#990000">+</font> <font color="#993399">1</font><font color="#990000">;</font>
	<font color="#008080">SInt64</font> okIndex <font color="#990000">=</font> lowBound<font color="#990000">;</font>
	<b><font color="#0000FF">while</font></b> <font color="#990000">(</font>highBound <font color="#990000">&gt;=</font> lowBound<font color="#990000">)</font> <font color="#FF0000">{</font>		
		<font color="#008080">SInt64</font> tryBound <font color="#990000">=</font> <font color="#990000">(</font>lowBound <font color="#990000">+</font> highBound<font color="#990000">)</font> <font color="#990000">&gt;&gt;</font> <font color="#993399">1</font><font color="#990000">;</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>tryBound <font color="#990000">&gt;</font> lastPacketIndex<font color="#990000">)</font> 
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		<font color="#008080">AudioStreamPacketDescription</font> tryPacket <font color="#990000">=</font> <font color="#990000">(*</font>packetTable<font color="#990000">)[</font>tryBound<font color="#990000">];</font>
		
		<font color="#008080">SInt64</font> readBytes <font color="#990000">=</font> tryPacket<font color="#990000">.</font>mStartOffset <font color="#990000">+</font> tryPacket<font color="#990000">.</font>mDataByteSize <font color="#990000">-</font> firstPacket<font color="#990000">.</font>mStartOffset<font color="#990000">;</font>
		
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>readBytes <font color="#990000">&gt;</font> <font color="#990000">(</font>SInt64<font color="#990000">)*</font>ioNumBytes<font color="#990000">)</font> <font color="#FF0000">{</font>
			highBound <font color="#990000">=</font> tryBound <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">;</font>
		<font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>readBytes <font color="#990000">&lt;</font> <font color="#990000">(</font>SInt64<font color="#990000">)*</font>ioNumBytes<font color="#990000">)</font> <font color="#FF0000">{</font>
			okIndex <font color="#990000">=</font> tryBound<font color="#990000">;</font>
			lowBound <font color="#990000">=</font> tryBound <font color="#990000">+</font> <font color="#993399">1</font><font color="#990000">;</font>
		<font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
			okIndex <font color="#990000">=</font> tryBound<font color="#990000">;</font>
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font>	
	
	<font color="#008080">SInt64</font> numPackets <font color="#990000">=</font> okIndex <font color="#990000">-</font> inStartingPacket <font color="#990000">+</font> <font color="#993399">1</font><font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>numPackets <font color="#990000">&gt;</font> <font color="#990000">*</font>ioNumPackets<font color="#990000">)</font> <font color="#FF0000">{</font>
		numPackets <font color="#990000">=</font> <font color="#990000">*</font>ioNumPackets<font color="#990000">;</font>
		okIndex <font color="#990000">=</font> inStartingPacket <font color="#990000">+</font> numPackets <font color="#990000">-</font> <font color="#993399">1</font><font color="#990000">;</font>
	<font color="#FF0000">}</font>
	
	<font color="#008080">AudioStreamPacketDescription</font> packet <font color="#990000">=</font> <font color="#990000">(*</font>packetTable<font color="#990000">)[</font>okIndex<font color="#990000">];</font>
	<font color="#990000">*</font>ioNumBytes <font color="#990000">=</font> <font color="#990000">(</font>UInt32<font color="#990000">)(</font>packet<font color="#990000">.</font>mStartOffset <font color="#990000">+</font> packet<font color="#990000">.</font>mDataByteSize <font color="#990000">-</font> firstPacket<font color="#990000">.</font>mStartOffset<font color="#990000">);</font>
	<font color="#990000">*</font>ioNumPackets <font color="#990000">=</font> <font color="#990000">(</font>UInt32<font color="#990000">)</font>numPackets<font color="#990000">;</font>
	<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>



<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">ReadPacketDataVBR_InTable</font></b><font color="#990000">(</font>	
								<font color="#008080">Boolean</font>							inUseCache<font color="#990000">,</font>
								<font color="#008080">UInt32</font>							<font color="#990000">*</font>ioNumBytes<font color="#990000">,</font>
								<font color="#008080">AudioStreamPacketDescription</font>	<font color="#990000">*</font>outPacketDescriptions<font color="#990000">,</font>
								<font color="#008080">SInt64</font>							inStartingPacket<font color="#990000">,</font> 
								<font color="#008080">UInt32</font>  						<font color="#990000">*</font>ioNumPackets<font color="#990000">,</font> 
								<font color="#009900">void</font>							<font color="#990000">*</font>outBuffer<font color="#990000">)</font>
<font color="#FF0000">{</font>
	CompressedPacketTable<font color="#990000">*</font> packetTable <font color="#990000">=</font> <b><font color="#000000">GetPacketTable</font></b><font color="#990000">();</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>packetTable<font color="#990000">)</font> 
		<b><font color="#0000FF">return</font></b> kAudioFileInvalidFileError<font color="#990000">;</font>
	
	<font color="#008080">OSStatus</font> err <font color="#990000">=</font> <b><font color="#000000">HowManyPacketsCanBeReadIntoBuffer</font></b><font color="#990000">(</font>ioNumBytes<font color="#990000">,</font> inStartingPacket<font color="#990000">,</font> ioNumPackets<font color="#990000">);</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>err<font color="#990000">)</font> <b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
			
	<font color="#008080">AudioStreamPacketDescription</font> firstPacket <font color="#990000">=</font> <font color="#990000">(*</font>packetTable<font color="#990000">)[</font>inStartingPacket<font color="#990000">];</font>
	<font color="#008080">SInt64</font> firstPacketOffset <font color="#990000">=</font> firstPacket<font color="#990000">.</font>mStartOffset<font color="#990000">;</font>
	<font color="#008080">UInt32</font> bytesRead <font color="#990000">=</font> <font color="#990000">*</font>ioNumBytes<font color="#990000">;</font>
	
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outBuffer<font color="#990000">)</font> <font color="#FF0000">{</font>
		err <font color="#990000">=</font> <b><font color="#000000">ReadBytes</font></b> <font color="#990000">(</font>inUseCache<font color="#990000">,</font> firstPacketOffset<font color="#990000">,</font> <font color="#990000">&amp;</font>bytesRead<font color="#990000">,</font> outBuffer<font color="#990000">);</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>err <font color="#990000">&amp;&amp;</font> err <font color="#990000">!=</font> kAudioFileEndOfFileError<font color="#990000">)</font> <font color="#FF0000">{</font>
			<font color="#990000">*</font>ioNumBytes <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
			<font color="#990000">*</font>ioNumPackets <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
			<b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
		<font color="#FF0000">}</font>
		<font color="#990000">*</font>ioNumBytes <font color="#990000">=</font> bytesRead<font color="#990000">;</font>
	<font color="#FF0000">}</font>
	
	<i><font color="#9A1900">// fill out packet descriptions</font></i>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outPacketDescriptions<font color="#990000">)</font> <font color="#FF0000">{</font>						
		<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">UInt32</font> i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> <font color="#990000">*</font>ioNumPackets<font color="#990000">;</font> i<font color="#990000">++)</font> <font color="#FF0000">{</font>
			<font color="#008080">AudioStreamPacketDescription</font> curPacket <font color="#990000">=</font> <font color="#990000">(*</font>packetTable<font color="#990000">)[</font>i <font color="#990000">+</font> inStartingPacket<font color="#990000">];</font>
			outPacketDescriptions<font color="#990000">[</font>i<font color="#990000">]</font> <font color="#990000">=</font> curPacket<font color="#990000">;</font>				
			outPacketDescriptions<font color="#990000">[</font>i<font color="#990000">].</font>mStartOffset <font color="#990000">=</font> curPacket<font color="#990000">.</font>mStartOffset <font color="#990000">-</font> firstPacketOffset<font color="#990000">;</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font>

    <b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>


<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">WritePackets</font></b><font color="#990000">(</font>	
									<font color="#008080">Boolean</font>								inUseCache<font color="#990000">,</font>
                                    <font color="#008080">UInt32</font>								inNumBytes<font color="#990000">,</font>
                                    <b><font color="#0000FF">const</font></b> <font color="#008080">AudioStreamPacketDescription</font>	<font color="#990000">*</font>inPacketDescriptions<font color="#990000">,</font>
                                    <font color="#008080">SInt64</font>								inStartingPacket<font color="#990000">,</font> 
                                    <font color="#008080">UInt32</font>								<font color="#990000">*</font>ioNumPackets<font color="#990000">,</font> 
                                    <b><font color="#0000FF">const</font></b> <font color="#009900">void</font>							<font color="#990000">*</font>inBuffer<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<i><font color="#9A1900">// This only works with CBR. To suppport VBR you must override.</font></i>
    <font color="#008080">OSStatus</font>		err <font color="#990000">=</font> noErr<font color="#990000">;</font>
    
    <b><font color="#000000">FailWithAction</font></b><font color="#990000">(</font>inStartingPacket <font color="#990000">&gt;</font> <b><font color="#000000">GetNumPackets</font></b><font color="#990000">(),</font> err <font color="#990000">=</font> kAudioFileInvalidPacketOffsetError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"write past end"</font><font color="#990000">);</font>
    <b><font color="#000000">FailWithAction</font></b><font color="#990000">((</font>ioNumPackets <font color="#990000">==</font> NULL<font color="#990000">)</font> <font color="#990000">||</font> <font color="#990000">(</font>inBuffer <font color="#990000">==</font> NULL<font color="#990000">),</font> err <font color="#990000">=</font> kAudioFileUnspecifiedError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"invalid parameter"</font><font color="#990000">);</font>
	
	<font color="#FF0000">{</font>
		<font color="#008080">UInt32</font> byteCount <font color="#990000">=</font> <font color="#990000">*</font>ioNumPackets <font color="#990000">*</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">;</font>
		<font color="#008080">SInt64</font> startingByte <font color="#990000">=</font> inStartingPacket <font color="#990000">*</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">;</font>

		err <font color="#990000">=</font> <b><font color="#000000">WriteBytes</font></b><font color="#990000">(</font>inUseCache<font color="#990000">,</font> startingByte<font color="#990000">,</font> <font color="#990000">&amp;</font>byteCount<font color="#990000">,</font> inBuffer<font color="#990000">);</font>
		<b><font color="#000000">FailIf</font></b> <font color="#990000">(</font>err <font color="#990000">!=</font> noErr<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"Write Bytes Failed"</font><font color="#990000">);</font>

		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>byteCount <font color="#990000">!=</font> <font color="#990000">(*</font>ioNumPackets <font color="#990000">*</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">))</font>
			<font color="#990000">*</font>ioNumPackets <font color="#990000">=</font> byteCount <font color="#990000">/</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">;</font>
	<font color="#FF0000">}</font>
<b><font color="#008080">Bail:</font></b>
    <b><font color="#0000FF">return</font></b> <font color="#990000">(</font>err<font color="#990000">);</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">GetBitRate</font></b><font color="#990000">(</font>			<font color="#008080">UInt32</font>					<font color="#990000">*</font>outBitRate<font color="#990000">)</font>
<font color="#FF0000">{</font>
	
	<font color="#008080">UInt32</font> bytesPerPacket <font color="#990000">=</font> <b><font color="#000000">GetDataFormat</font></b><font color="#990000">().</font>mBytesPerPacket<font color="#990000">;</font>
	<font color="#008080">UInt32</font> framesPerPacket <font color="#990000">=</font> <b><font color="#000000">GetDataFormat</font></b><font color="#990000">().</font>mFramesPerPacket<font color="#990000">;</font>
	<font color="#008080">Float64</font> sampleRate <font color="#990000">=</font> <b><font color="#000000">GetDataFormat</font></b><font color="#990000">().</font>mSampleRate<font color="#990000">;</font>
	<b><font color="#0000FF">const</font></b> <font color="#008080">Float64</font> bitsPerByte <font color="#990000">=</font> <font color="#993399">8</font><font color="#990000">.;</font>
	
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>bytesPerPacket <font color="#990000">&amp;&amp;</font> framesPerPacket<font color="#990000">)</font> <font color="#FF0000">{</font>
		<font color="#990000">*</font>outBitRate <font color="#990000">=</font> <font color="#990000">(</font>UInt32<font color="#990000">)(</font>bitsPerByte <font color="#990000">*</font> <font color="#990000">(</font>Float64<font color="#990000">)</font>bytesPerPacket <font color="#990000">*</font> sampleRate <font color="#990000">/</font> <font color="#990000">(</font>Float64<font color="#990000">)</font>framesPerPacket<font color="#990000">);</font>
	<font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>		
		<font color="#008080">SInt64</font> numPackets <font color="#990000">=</font> <b><font color="#000000">GetNumPackets</font></b><font color="#990000">();</font>
		<font color="#008080">SInt64</font> numBytes <font color="#990000">=</font> <b><font color="#000000">GetNumBytes</font></b><font color="#990000">();</font>
		<font color="#008080">SInt64</font> numFrames <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>framesPerPacket<font color="#990000">)</font> <font color="#FF0000">{</font>
			numFrames <font color="#990000">=</font> numPackets <font color="#990000">*</font> framesPerPacket<font color="#990000">;</font>
		<font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
			<i><font color="#9A1900">// count frames</font></i>
			CompressedPacketTable<font color="#990000">*</font> packetTable <font color="#990000">=</font> <b><font color="#000000">GetPacketTable</font></b><font color="#990000">();</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>packetTable<font color="#990000">)</font> <font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>TARGET_OS_WIN32
				<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#008080">ssize_t</font> i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> numPackets<font color="#990000">;</font> i<font color="#990000">++)</font>
<b><font color="#000080">#else</font></b>
				<b><font color="#0000FF">for</font></b> <font color="#990000">(</font><font color="#009900">int</font> i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> numPackets<font color="#990000">;</font> i<font color="#990000">++)</font>
<b><font color="#000080">#endif</font></b>
				<font color="#FF0000">{</font>
					numFrames <font color="#990000">+=</font> <font color="#990000">(*</font>packetTable<font color="#990000">)[</font>i<font color="#990000">].</font>mVariableFramesInPacket<font color="#990000">;</font>
				<font color="#FF0000">}</font>		
			<font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
				<b><font color="#0000FF">return</font></b> kAudioFileUnsupportedPropertyError<font color="#990000">;</font>
			<font color="#FF0000">}</font>
		<font color="#FF0000">}</font>
		<font color="#008080">Float64</font> duration <font color="#990000">=</font> <font color="#990000">(</font>Float64<font color="#990000">)</font>numFrames <font color="#990000">/</font> sampleRate<font color="#990000">;</font>
		<font color="#990000">*</font>outBitRate <font color="#990000">=</font> <font color="#990000">(</font>UInt32<font color="#990000">)(</font>bitsPerByte <font color="#990000">*</font> <font color="#990000">(</font>Float64<font color="#990000">)</font>numBytes <font color="#990000">/</font> duration<font color="#990000">);</font>
	<font color="#FF0000">}</font>

	<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">GetMagicCookieDataSize</font></b><font color="#990000">(</font>
												<font color="#008080">UInt32</font>					<font color="#990000">*</font>outDataSize<font color="#990000">,</font>
												<font color="#008080">UInt32</font>					<font color="#990000">*</font>isWritable<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outDataSize<font color="#990000">)</font>  <font color="#990000">*</font>outDataSize <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>isWritable<font color="#990000">)</font>  <font color="#990000">*</font>isWritable <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	<b><font color="#0000FF">return</font></b> kAudioFileUnsupportedPropertyError<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">GetMagicCookieData</font></b><font color="#990000">(</font>
												<font color="#008080">UInt32</font>					<font color="#990000">*</font>ioDataSize<font color="#990000">,</font>
												<font color="#009900">void</font>					<font color="#990000">*</font>ioPropertyData<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<font color="#990000">*</font>ioDataSize <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	<b><font color="#0000FF">return</font></b> kAudioFileUnsupportedPropertyError<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">SetMagicCookieData</font></b><font color="#990000">(</font>	UInt32					<i><font color="#9A1900">/*inDataSize*/</font></i><font color="#990000">,</font>
												<b><font color="#0000FF">const</font></b> <font color="#009900">void</font>				<font color="#990000">*</font>inPropertyData<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">return</font></b> kAudioFileInvalidChunkError<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">GetMarkerListSize</font></b><font color="#990000">(</font>
												<font color="#008080">UInt32</font>					<font color="#990000">*</font>outDataSize<font color="#990000">,</font>
												<font color="#008080">UInt32</font>					<font color="#990000">*</font>isWritable<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outDataSize<font color="#990000">)</font> <font color="#990000">*</font>outDataSize <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>isWritable<font color="#990000">)</font> <font color="#990000">*</font>isWritable <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	<b><font color="#0000FF">return</font></b> kAudioFileUnsupportedPropertyError<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">GetMarkerList</font></b><font color="#990000">(</font>
												<font color="#008080">UInt32</font>					<font color="#990000">*</font>ioDataSize<font color="#990000">,</font>
												AudioFileMarkerList<font color="#990000">*</font>	<i><font color="#9A1900">/*ioPropertyData*/</font></i><font color="#990000">)</font>
<font color="#FF0000">{</font>
	<font color="#990000">*</font>ioDataSize <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	<b><font color="#0000FF">return</font></b> kAudioFileUnsupportedPropertyError<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">SetMarkerList</font></b><font color="#990000">(</font>	UInt32						<i><font color="#9A1900">/*inDataSize*/</font></i><font color="#990000">,</font>
											<b><font color="#0000FF">const</font></b> AudioFileMarkerList<font color="#990000">*</font>  <i><font color="#9A1900">/*inPropertyData*/</font></i><font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">return</font></b> kAudioFileUnsupportedPropertyError<font color="#990000">;</font>
<font color="#FF0000">}</font>


<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">GetRegionListSize</font></b><font color="#990000">(</font>
												<font color="#008080">UInt32</font>					<font color="#990000">*</font>outDataSize<font color="#990000">,</font>
												<font color="#008080">UInt32</font>					<font color="#990000">*</font>isWritable<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outDataSize<font color="#990000">)</font> <font color="#990000">*</font>outDataSize <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>isWritable<font color="#990000">)</font> <font color="#990000">*</font>isWritable <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	<b><font color="#0000FF">return</font></b> kAudioFileUnsupportedPropertyError<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">GetRegionList</font></b><font color="#990000">(</font>
												<font color="#008080">UInt32</font>					<font color="#990000">*</font>ioDataSize<font color="#990000">,</font>
												<font color="#008080">AudioFileRegionList</font>		<font color="#990000">*</font>ioPropertyData<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<font color="#990000">*</font>ioDataSize <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	<b><font color="#0000FF">return</font></b> kAudioFileUnsupportedPropertyError<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">SetRegionList</font></b><font color="#990000">(</font>	UInt32						<i><font color="#9A1900">/*inDataSize*/</font></i><font color="#990000">,</font>
											<b><font color="#0000FF">const</font></b> AudioFileRegionList<font color="#990000">*</font>   <i><font color="#9A1900">/*inPropertyData*/</font></i><font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">return</font></b> kAudioFileUnsupportedPropertyError<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">GetChannelLayoutSize</font></b><font color="#990000">(</font>
												<font color="#008080">UInt32</font>					<font color="#990000">*</font>outDataSize<font color="#990000">,</font>
												<font color="#008080">UInt32</font>					<font color="#990000">*</font>isWritable<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outDataSize<font color="#990000">)</font> <font color="#990000">*</font>outDataSize <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>isWritable<font color="#990000">)</font> <font color="#990000">*</font>isWritable <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	<b><font color="#0000FF">return</font></b> kAudioFileUnsupportedPropertyError<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">GetChannelLayout</font></b><font color="#990000">(</font>
												<font color="#008080">UInt32</font>						<font color="#990000">*</font>ioDataSize<font color="#990000">,</font>
												AudioChannelLayout<font color="#990000">*</font>			<i><font color="#9A1900">/*ioPropertyData*/</font></i><font color="#990000">)</font>
<font color="#FF0000">{</font>
	<font color="#990000">*</font>ioDataSize <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	<b><font color="#0000FF">return</font></b> kAudioFileUnsupportedPropertyError<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">SetChannelLayout</font></b><font color="#990000">(</font>	UInt32						<i><font color="#9A1900">/*inDataSize*/</font></i><font color="#990000">,</font>
											<b><font color="#0000FF">const</font></b> AudioChannelLayout<font color="#990000">*</font>   <i><font color="#9A1900">/*inPropertyData*/</font></i><font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">return</font></b> kAudioFileUnsupportedPropertyError<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">GetInfoDictionarySize</font></b><font color="#990000">(</font>		<font color="#008080">UInt32</font>						<font color="#990000">*</font>outDataSize<font color="#990000">,</font>
									<font color="#008080">UInt32</font>						<font color="#990000">*</font>isWritable<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outDataSize<font color="#990000">)</font> <font color="#990000">*</font>outDataSize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>CFDictionaryRef<font color="#990000">);</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>isWritable<font color="#990000">)</font> <font color="#990000">*</font>isWritable <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
	<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>
												
<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">GetInfoDictionary</font></b><font color="#990000">(</font><font color="#008080">CACFDictionary</font>  <font color="#990000">*</font>infoDict<font color="#990000">)</font>
<font color="#FF0000">{</font>	
	<font color="#008080">Float64</font> fl<font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#000000">GetEstimatedDuration</font></b><font color="#990000">(&amp;</font>fl<font color="#990000">)</font> <font color="#990000">==</font> noErr<font color="#990000">)</font>
		<b><font color="#0000FF">return</font></b> <b><font color="#000000">AddDurationToInfoDictionary</font></b><font color="#990000">(</font>infoDict<font color="#990000">,</font> fl<font color="#990000">);</font>
		
	<b><font color="#0000FF">return</font></b> kAudioFileUnsupportedPropertyError<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>
												
<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">SetInfoDictionary</font></b><font color="#990000">(</font><font color="#008080">CACFDictionary</font> <font color="#990000">*</font>infoDict<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">return</font></b> kAudioFileUnsupportedPropertyError<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>
<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">GetEstimatedDuration</font></b><font color="#990000">(</font>Float64<font color="#990000">*</font>		duration<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<i><font color="#9A1900">// calculate duration</font></i>
	<font color="#008080">AudioStreamBasicDescription</font>		ASBD <font color="#990000">=</font> <b><font color="#000000">GetDataFormat</font></b><font color="#990000">();</font>
		
	<font color="#990000">*</font>duration  <font color="#990000">=</font> <font color="#990000">(</font>ASBD<font color="#990000">.</font>mFramesPerPacket <font color="#990000">!=</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#990000">?</font> <font color="#990000">(</font><b><font color="#000000">GetNumPackets</font></b><font color="#990000">()</font> <font color="#990000">*</font> ASBD<font color="#990000">.</font>mFramesPerPacket<font color="#990000">)</font> <font color="#990000">/</font> ASBD<font color="#990000">.</font>mSampleRate <font color="#990000">:</font> <font color="#993399">0.0</font><font color="#990000">;</font>
	
	<i><font color="#9A1900">/*</font></i>
<i><font color="#9A1900">		For now, assume that any ASBD that has zero in the frames per packet field has been subclassed for this</font></i>
<i><font color="#9A1900">		method. i.e. A CAF file has a frame count in one of it's chunks.</font></i>
<i><font color="#9A1900">		</font></i>
<i><font color="#9A1900">		MP3 has been subclassed because it guesstimates a duration so the entire file does not </font></i>
<i><font color="#9A1900">		need to be parsed in order to calculate the total frames.</font></i>
<i><font color="#9A1900">	*/</font></i>
	
	<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>

<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">GetPropertyInfo</font></b>	<font color="#990000">(</font>	
                                        <font color="#008080">AudioFilePropertyID</font>		inPropertyID<font color="#990000">,</font>
                                        <font color="#008080">UInt32</font>					<font color="#990000">*</font>outDataSize<font color="#990000">,</font>
                                        <font color="#008080">UInt32</font>					<font color="#990000">*</font>isWritable<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <font color="#008080">OSStatus</font>		err <font color="#990000">=</font> noErr<font color="#990000">;</font>
    <font color="#008080">UInt32</font>			writable <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
        
    <b><font color="#0000FF">switch</font></b> <font color="#990000">(</font>inPropertyID<font color="#990000">)</font>
    <font color="#FF0000">{</font>
		<b><font color="#0000FF">case</font></b> kAudioFilePropertyDeferSizeUpdates <font color="#990000">:</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outDataSize<font color="#990000">)</font> <font color="#990000">*</font>outDataSize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>UInt32<font color="#990000">);</font>
            writable <font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">;</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

        <b><font color="#0000FF">case</font></b> kAudioFilePropertyFileFormat<font color="#990000">:</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outDataSize<font color="#990000">)</font> <font color="#990000">*</font>outDataSize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>UInt32<font color="#990000">);</font>
            writable <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

        <b><font color="#0000FF">case</font></b> kAudioFilePropertyDataFormat<font color="#990000">:</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outDataSize<font color="#990000">)</font> <font color="#990000">*</font>outDataSize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>AudioStreamBasicDescription<font color="#990000">);</font>
            writable <font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">;</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
                        
		<b><font color="#0000FF">case</font></b> kAudioFilePropertyFormatList<font color="#990000">:</font>
			err <font color="#990000">=</font> <b><font color="#000000">GetFormatListInfo</font></b><font color="#990000">(*</font>outDataSize<font color="#990000">,</font> writable<font color="#990000">);</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		
		<b><font color="#0000FF">case</font></b> kAudioFilePropertyPacketSizeUpperBound<font color="#990000">:</font>
        <b><font color="#0000FF">case</font></b> kAudioFilePropertyIsOptimized<font color="#990000">:</font>
        <b><font color="#0000FF">case</font></b> kAudioFilePropertyMaximumPacketSize<font color="#990000">:</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outDataSize<font color="#990000">)</font> <font color="#990000">*</font>outDataSize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>UInt32<font color="#990000">);</font>
            writable <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

        <b><font color="#0000FF">case</font></b> kAudioFilePropertyAudioDataByteCount<font color="#990000">:</font>
        <b><font color="#0000FF">case</font></b> kAudioFilePropertyAudioDataPacketCount<font color="#990000">:</font>
            writable <font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">;</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outDataSize<font color="#990000">)</font> <font color="#990000">*</font>outDataSize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>SInt64<font color="#990000">);</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

		<b><font color="#0000FF">case</font></b> kAudioFilePropertyDataOffset<font color="#990000">:</font>
            writable <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outDataSize<font color="#990000">)</font> <font color="#990000">*</font>outDataSize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>SInt64<font color="#990000">);</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

		<b><font color="#0000FF">case</font></b> kAudioFilePropertyBitRate<font color="#990000">:</font>            
            writable <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outDataSize<font color="#990000">)</font> <font color="#990000">*</font>outDataSize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>UInt32<font color="#990000">);</font>
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>

		<b><font color="#0000FF">case</font></b> kAudioFilePropertyMagicCookieData<font color="#990000">:</font>            
            err <font color="#990000">=</font> <b><font color="#000000">GetMagicCookieDataSize</font></b><font color="#990000">(</font>outDataSize<font color="#990000">,</font> <font color="#990000">&amp;</font>writable<font color="#990000">);</font>
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>

		<b><font color="#0000FF">case</font></b> kAudioFilePropertyMarkerList <font color="#990000">:</font>
            err <font color="#990000">=</font> <b><font color="#000000">GetMarkerListSize</font></b><font color="#990000">(</font>outDataSize<font color="#990000">,</font> <font color="#990000">&amp;</font>writable<font color="#990000">);</font>			
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
			
		<b><font color="#0000FF">case</font></b> kAudioFilePropertyRegionList <font color="#990000">:</font>
            err <font color="#990000">=</font> <b><font color="#000000">GetRegionListSize</font></b><font color="#990000">(</font>outDataSize<font color="#990000">,</font> <font color="#990000">&amp;</font>writable<font color="#990000">);</font>			
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
			
		<b><font color="#0000FF">case</font></b> kAudioFilePropertyChannelLayout <font color="#990000">:</font>
            err <font color="#990000">=</font> <b><font color="#000000">GetChannelLayoutSize</font></b><font color="#990000">(</font>outDataSize<font color="#990000">,</font> <font color="#990000">&amp;</font>writable<font color="#990000">);</font>			
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>

		<b><font color="#0000FF">case</font></b> kAudioFilePropertyPacketToFrame <font color="#990000">:</font>
		<b><font color="#0000FF">case</font></b> kAudioFilePropertyFrameToPacket <font color="#990000">:</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outDataSize<font color="#990000">)</font> <font color="#990000">*</font>outDataSize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>AudioFramePacketTranslation<font color="#990000">);</font>
            writable <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>

		<b><font color="#0000FF">case</font></b> kAudioFilePropertyPacketToByte <font color="#990000">:</font>
		<b><font color="#0000FF">case</font></b> kAudioFilePropertyByteToPacket <font color="#990000">:</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outDataSize<font color="#990000">)</font> <font color="#990000">*</font>outDataSize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>AudioBytePacketTranslation<font color="#990000">);</font>
            writable <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>

        <b><font color="#0000FF">case</font></b> kAudioFilePropertyInfoDictionary <font color="#990000">:</font>
            err <font color="#990000">=</font> <b><font color="#000000">GetInfoDictionarySize</font></b><font color="#990000">(</font>outDataSize<font color="#990000">,</font> <font color="#990000">&amp;</font>writable<font color="#990000">);</font>			
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

        <b><font color="#0000FF">case</font></b> kTEMPAudioFilePropertySoundCheckDictionary <font color="#990000">:</font>
            err <font color="#990000">=</font> <b><font color="#000000">GetSoundCheckDictionarySize</font></b><font color="#990000">(</font>outDataSize<font color="#990000">,</font> <font color="#990000">&amp;</font>writable<font color="#990000">);</font>			
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

		<b><font color="#0000FF">case</font></b> kAudioFilePropertyEstimatedDuration <font color="#990000">:</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outDataSize<font color="#990000">)</font> <font color="#990000">*</font>outDataSize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>Float64<font color="#990000">);</font>
            writable <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>

		<b><font color="#0000FF">case</font></b> <font color="#FF0000">'LYRC'</font><font color="#990000">:</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outDataSize<font color="#990000">)</font> <font color="#990000">*</font>outDataSize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>CFStringRef<font color="#990000">);</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>isWritable<font color="#990000">)</font> <font color="#990000">*</font>isWritable <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>

		<b><font color="#0000FF">case</font></b> <font color="#FF0000">'eof?'</font><font color="#990000">:</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outDataSize<font color="#990000">)</font> <font color="#990000">*</font>outDataSize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>UInt32<font color="#990000">);</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>isWritable<font color="#990000">)</font> <font color="#990000">*</font>isWritable <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>

		<b><font color="#0000FF">case</font></b> <font color="#FF0000">'sbtd'</font> <i><font color="#9A1900">/*kAudioFilePropertySourceBitDepth*/</font></i> <font color="#990000">:</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outDataSize<font color="#990000">)</font> <font color="#990000">*</font>outDataSize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>SInt32<font color="#990000">);</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>isWritable<font color="#990000">)</font> <font color="#990000">*</font>isWritable <font color="#990000">=</font> <b><font color="#000000">CanWrite</font></b><font color="#990000">();</font>
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		
<b><font color="#008080">        default:</font></b>
            writable <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
            err <font color="#990000">=</font> kAudioFileUnsupportedPropertyError<font color="#990000">;</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
    <font color="#FF0000">}</font>

    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>isWritable<font color="#990000">)</font>
        <font color="#990000">*</font>isWritable <font color="#990000">=</font> writable<font color="#990000">;</font>
    <b><font color="#0000FF">return</font></b> <font color="#990000">(</font>err<font color="#990000">);</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font>	AudioFileObject<font color="#990000">::</font><b><font color="#000000">GetProperty</font></b><font color="#990000">(</font>
                                    <font color="#008080">AudioFilePropertyID</font>		inPropertyID<font color="#990000">,</font>
                                    <font color="#008080">UInt32</font>					<font color="#990000">*</font>ioDataSize<font color="#990000">,</font>
                                    <font color="#009900">void</font>					<font color="#990000">*</font>ioPropertyData<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <font color="#008080">OSStatus</font>		err <font color="#990000">=</font> noErr<font color="#990000">;</font>
	<font color="#008080">UInt32</font>			neededSize<font color="#990000">;</font>
    <font color="#008080">UInt32</font>			writable<font color="#990000">;</font>
	
    <b><font color="#0000FF">switch</font></b> <font color="#990000">(</font>inPropertyID<font color="#990000">)</font>
    <font color="#FF0000">{</font>
        <b><font color="#0000FF">case</font></b> kAudioFilePropertyFileFormat<font color="#990000">:</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>UInt32<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>
				
            <font color="#990000">*(</font>UInt32 <font color="#990000">*)</font> ioPropertyData <font color="#990000">=</font> <b><font color="#000000">GetFileType</font></b><font color="#990000">();</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

		<b><font color="#0000FF">case</font></b> kAudioFilePropertyFormatList<font color="#990000">:</font>
			err <font color="#990000">=</font> <b><font color="#000000">GetFormatList</font></b><font color="#990000">(*</font>ioDataSize<font color="#990000">,</font> <font color="#990000">(</font>AudioFormatListItem<font color="#990000">*)</font>ioPropertyData<font color="#990000">);</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		
        <b><font color="#0000FF">case</font></b> kAudioFilePropertyDataFormat<font color="#990000">:</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>AudioStreamBasicDescription<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>
				
            <b><font color="#000000">memcpy</font></b><font color="#990000">(</font>ioPropertyData<font color="#990000">,</font> <font color="#990000">&amp;</font>mDataFormat<font color="#990000">,</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>AudioStreamBasicDescription<font color="#990000">));</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		<b><font color="#0000FF">case</font></b> kAudioFilePropertyDataOffset<font color="#990000">:</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>SInt64<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>
            <font color="#990000">*(</font>SInt64 <font color="#990000">*)</font> ioPropertyData <font color="#990000">=</font> mDataOffset<font color="#990000">;</font>
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
        <b><font color="#0000FF">case</font></b> kAudioFilePropertyIsOptimized<font color="#990000">:</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>UInt32<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>
            <font color="#990000">*(</font>UInt32 <font color="#990000">*)</font> ioPropertyData <font color="#990000">=</font> mIsOptimized<font color="#990000">;</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

        <b><font color="#0000FF">case</font></b> kAudioFilePropertyAudioDataByteCount<font color="#990000">:</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>SInt64<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>
            <font color="#990000">*(</font>SInt64 <font color="#990000">*)</font>ioPropertyData <font color="#990000">=</font> <b><font color="#000000">GetNumBytes</font></b><font color="#990000">();</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

        <b><font color="#0000FF">case</font></b> kAudioFilePropertyAudioDataPacketCount<font color="#990000">:</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>SInt64<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>
            <font color="#990000">*(</font>SInt64 <font color="#990000">*)</font>ioPropertyData <font color="#990000">=</font> <b><font color="#000000">GetNumPackets</font></b><font color="#990000">();</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

		<b><font color="#0000FF">case</font></b> kAudioFilePropertyPacketSizeUpperBound<font color="#990000">:</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>UInt32<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>
            <font color="#990000">*(</font>UInt32 <font color="#990000">*)</font>ioPropertyData <font color="#990000">=</font> <b><font color="#000000">GetPacketSizeUpperBound</font></b><font color="#990000">();</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
			
        <b><font color="#0000FF">case</font></b> kAudioFilePropertyMaximumPacketSize<font color="#990000">:</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>UInt32<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>
            <font color="#990000">*(</font>UInt32 <font color="#990000">*)</font>ioPropertyData <font color="#990000">=</font> <b><font color="#000000">FindMaximumPacketSize</font></b><font color="#990000">();</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>


         <b><font color="#0000FF">case</font></b> kAudioFilePropertyBitRate<font color="#990000">:</font>            
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>UInt32<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>
			err <font color="#990000">=</font> <b><font color="#000000">GetBitRate</font></b><font color="#990000">((</font>UInt32<font color="#990000">*)</font>ioPropertyData<font color="#990000">);</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

         <b><font color="#0000FF">case</font></b> kAudioFilePropertyMagicCookieData<font color="#990000">:</font>            
            
			err <font color="#990000">=</font> <b><font color="#000000">GetMagicCookieData</font></b><font color="#990000">(</font>ioDataSize<font color="#990000">,</font> ioPropertyData<font color="#990000">);</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

		<b><font color="#0000FF">case</font></b> kAudioFilePropertyMarkerList <font color="#990000">:</font>
            err <font color="#990000">=</font> <b><font color="#000000">GetMarkerList</font></b><font color="#990000">(</font>ioDataSize<font color="#990000">,</font> <b><font color="#0000FF">static_cast</font></b><font color="#990000">&lt;</font>AudioFileMarkerList<font color="#990000">*&gt;(</font>ioPropertyData<font color="#990000">));</font>			
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
			
		<b><font color="#0000FF">case</font></b> kAudioFilePropertyRegionList <font color="#990000">:</font>
			<b><font color="#000000">memset</font></b><font color="#990000">(</font>ioPropertyData<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#990000">*</font>ioDataSize<font color="#990000">);</font>
            err <font color="#990000">=</font> <b><font color="#000000">GetRegionList</font></b><font color="#990000">(</font>ioDataSize<font color="#990000">,</font> <b><font color="#0000FF">static_cast</font></b><font color="#990000">&lt;</font>AudioFileRegionList<font color="#990000">*&gt;(</font>ioPropertyData<font color="#990000">));</font>			
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
			
		<b><font color="#0000FF">case</font></b> kAudioFilePropertyChannelLayout <font color="#990000">:</font>
			err <font color="#990000">=</font> <b><font color="#000000">GetChannelLayoutSize</font></b><font color="#990000">(&amp;</font>neededSize<font color="#990000">,</font> <font color="#990000">&amp;</font>writable<font color="#990000">);</font>
            <b><font color="#000000">FailIf</font></b><font color="#990000">(</font>err<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"GetChannelLayoutSize failed"</font><font color="#990000">);</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> neededSize<font color="#990000">,</font> err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>
			
            err <font color="#990000">=</font> <b><font color="#000000">GetChannelLayout</font></b><font color="#990000">(</font>ioDataSize<font color="#990000">,</font> <b><font color="#0000FF">static_cast</font></b><font color="#990000">&lt;</font>AudioChannelLayout<font color="#990000">*&gt;(</font>ioPropertyData<font color="#990000">));</font>			
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
						
		<b><font color="#0000FF">case</font></b> kAudioFilePropertyDeferSizeUpdates <font color="#990000">:</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>UInt32<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>
				
            <font color="#990000">*(</font>UInt32 <font color="#990000">*)</font> ioPropertyData <font color="#990000">=</font> <b><font color="#000000">DeferSizeUpdates</font></b><font color="#990000">();</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

		<b><font color="#0000FF">case</font></b> kAudioFilePropertyPacketToFrame <font color="#990000">:</font> 
		<font color="#FF0000">{</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>AudioFramePacketTranslation<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>
			
			AudioFramePacketTranslation<font color="#990000">*</font> afpt <font color="#990000">=</font> <font color="#990000">(</font>AudioFramePacketTranslation<font color="#990000">*)</font>ioPropertyData<font color="#990000">;</font>
			err <font color="#990000">=</font> <b><font color="#000000">PacketToFrame</font></b><font color="#990000">(</font>afpt<font color="#990000">-&gt;</font>mPacket<font color="#990000">,</font> afpt<font color="#990000">-&gt;</font>mFrame<font color="#990000">);</font>
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		<font color="#FF0000">}</font>	
		<b><font color="#0000FF">case</font></b> kAudioFilePropertyFrameToPacket <font color="#990000">:</font>
		<font color="#FF0000">{</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>AudioFramePacketTranslation<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>

			AudioFramePacketTranslation<font color="#990000">*</font> afpt <font color="#990000">=</font> <font color="#990000">(</font>AudioFramePacketTranslation<font color="#990000">*)</font>ioPropertyData<font color="#990000">;</font>
			err <font color="#990000">=</font> <b><font color="#000000">FrameToPacket</font></b><font color="#990000">(</font>afpt<font color="#990000">-&gt;</font>mFrame<font color="#990000">,</font> afpt<font color="#990000">-&gt;</font>mPacket<font color="#990000">,</font> afpt<font color="#990000">-&gt;</font>mFrameOffsetInPacket<font color="#990000">);</font>
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		<font color="#FF0000">}</font>

		<b><font color="#0000FF">case</font></b> kAudioFilePropertyPacketToByte <font color="#990000">:</font> 
		<font color="#FF0000">{</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>AudioBytePacketTranslation<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>
			
			AudioBytePacketTranslation<font color="#990000">*</font> abpt <font color="#990000">=</font> <font color="#990000">(</font>AudioBytePacketTranslation<font color="#990000">*)</font>ioPropertyData<font color="#990000">;</font>
			err <font color="#990000">=</font> <b><font color="#000000">PacketToByte</font></b><font color="#990000">(</font>abpt<font color="#990000">);</font>
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		<font color="#FF0000">}</font>	
		<b><font color="#0000FF">case</font></b> kAudioFilePropertyByteToPacket <font color="#990000">:</font>
		<font color="#FF0000">{</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>AudioBytePacketTranslation<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>

			AudioBytePacketTranslation<font color="#990000">*</font> abpt <font color="#990000">=</font> <font color="#990000">(</font>AudioBytePacketTranslation<font color="#990000">*)</font>ioPropertyData<font color="#990000">;</font>
			err <font color="#990000">=</font> <b><font color="#000000">ByteToPacket</font></b><font color="#990000">(</font>abpt<font color="#990000">);</font>
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		<font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> kAudioFilePropertyInfoDictionary <font color="#990000">:</font>
		<font color="#FF0000">{</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>CFDictionaryRef<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>

			<font color="#008080">CACFDictionary</font>		<b><font color="#000000">afInfoDictionary</font></b><font color="#990000">(</font><b><font color="#0000FF">true</font></b><font color="#990000">);</font>

            err <font color="#990000">=</font> <b><font color="#000000">GetInfoDictionary</font></b><font color="#990000">(&amp;</font>afInfoDictionary<font color="#990000">);</font>			
            
			<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>err<font color="#990000">)</font>
			<font color="#FF0000">{</font>
				<font color="#990000">*(</font>CFMutableDictionaryRef <font color="#990000">*)</font>ioPropertyData <font color="#990000">=</font> afInfoDictionary<font color="#990000">.</font><b><font color="#000000">CopyCFMutableDictionary</font></b><font color="#990000">();</font>
			<font color="#FF0000">}</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		<font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> kTEMPAudioFilePropertySoundCheckDictionary <font color="#990000">:</font>
		<font color="#FF0000">{</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>CFDictionaryRef<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>

			<font color="#008080">CACFDictionary</font>		<b><font color="#000000">afInfoDictionary</font></b><font color="#990000">(</font><b><font color="#0000FF">true</font></b><font color="#990000">);</font>

            err <font color="#990000">=</font> <b><font color="#000000">GetSoundCheckDictionary</font></b><font color="#990000">(&amp;</font>afInfoDictionary<font color="#990000">);</font>			
            
			<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>err<font color="#990000">)</font>
			<font color="#FF0000">{</font>
				<font color="#990000">*(</font>CFMutableDictionaryRef <font color="#990000">*)</font>ioPropertyData <font color="#990000">=</font> afInfoDictionary<font color="#990000">.</font><b><font color="#000000">CopyCFMutableDictionary</font></b><font color="#990000">();</font>
			<font color="#FF0000">}</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		<font color="#FF0000">}</font>

		<b><font color="#0000FF">case</font></b> kAudioFilePropertyEstimatedDuration <font color="#990000">:</font>
		<font color="#FF0000">{</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>Float64<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>
		
			err <font color="#990000">=</font> <b><font color="#000000">GetEstimatedDuration</font></b><font color="#990000">((</font>Float64<font color="#990000">*)</font>ioPropertyData<font color="#990000">);</font> 
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		<font color="#FF0000">}</font>

        <b><font color="#0000FF">case</font></b> <font color="#FF0000">'LYRC'</font> <font color="#990000">:</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(*</font>ioDataSize <font color="#990000">&lt;</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>CFStringRef<font color="#990000">))</font>
                <b><font color="#0000FF">return</font></b> kAudioFileBadPropertySizeError<font color="#990000">;</font>

			<font color="#990000">*</font>ioDataSize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>CFStringRef<font color="#990000">);</font>
			err <font color="#990000">=</font> <b><font color="#000000">GetLyrics</font></b><font color="#990000">((</font>CFStringRef<font color="#990000">*)</font> ioPropertyData<font color="#990000">);</font>
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
	
		<b><font color="#0000FF">case</font></b> <font color="#FF0000">'eof?'</font> <font color="#990000">:</font> 
		<font color="#FF0000">{</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>UInt32<font color="#990000">))</font>
                <b><font color="#0000FF">return</font></b> kAudioFileBadPropertySizeError<font color="#990000">;</font>
			
			<font color="#008080">SInt64</font> pos<font color="#990000">;</font>
			err <font color="#990000">=</font> <b><font color="#000000">GetDataSource</font></b><font color="#990000">()-&gt;</font><b><font color="#000000">GetPos</font></b><font color="#990000">(</font>pos<font color="#990000">);</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>err<font color="#990000">)</font> <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
			
			<font color="#008080">SInt64</font> endOfData <font color="#990000">=</font> <b><font color="#000000">GetDataOffset</font></b><font color="#990000">()</font> <font color="#990000">+</font> <b><font color="#000000">GetNumBytes</font></b><font color="#990000">();</font>
			<font color="#990000">*(</font>UInt32<font color="#990000">*)</font>ioPropertyData <font color="#990000">=</font> pos <font color="#990000">&gt;=</font> endOfData<font color="#990000">;</font>
			
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		<font color="#FF0000">}</font>	
		<b><font color="#0000FF">case</font></b> <font color="#FF0000">'sbtd'</font> <i><font color="#9A1900">/*kAudioFilePropertySourceBitDepth*/</font></i> <font color="#990000">:</font>
		<font color="#FF0000">{</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(*</font>ioDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>SInt32<font color="#990000">))</font>
                <b><font color="#0000FF">return</font></b> kAudioFileBadPropertySizeError<font color="#990000">;</font>

			<font color="#008080">SInt32</font> outValue <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
			err <font color="#990000">=</font> <b><font color="#000000">GetSourceBitDepth</font></b><font color="#990000">(</font>outValue<font color="#990000">);</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">((</font>err <font color="#990000">||</font> outValue <font color="#990000">==</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> <b><font color="#000000">GetDataFormat</font></b><font color="#990000">().</font>mFormatID <font color="#990000">==</font> kAudioFormatLinearPCM<font color="#990000">)</font> <font color="#FF0000">{</font>
				<i><font color="#9A1900">// if there was no stored source bit depth, and this file is LPCM, then report this file's bit depth.</font></i>
				err <font color="#990000">=</font> noErr<font color="#990000">;</font>
				outValue <font color="#990000">=</font> <b><font color="#000000">GetDataFormat</font></b><font color="#990000">().</font>mBitsPerChannel<font color="#990000">;</font>
				<b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#000000">GetDataFormat</font></b><font color="#990000">().</font>mFormatFlags <font color="#990000">&amp;</font> kAudioFormatFlagIsFloat<font color="#990000">)</font> 
					outValue <font color="#990000">=</font> <font color="#990000">-</font>outValue<font color="#990000">;</font>
			<font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>err<font color="#990000">)</font> 
				<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
			
			<font color="#990000">*(</font>SInt32 <font color="#990000">*)</font> ioPropertyData <font color="#990000">=</font> outValue<font color="#990000">;</font>
			
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		<font color="#FF0000">}</font>	
<b><font color="#008080">		default:</font></b>
            err <font color="#990000">=</font> kAudioFileUnsupportedPropertyError<font color="#990000">;</font>			
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
    <font color="#FF0000">}</font>

<b><font color="#008080">Bail:</font></b>
    <b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font>	AudioFileObject<font color="#990000">::</font><b><font color="#000000">SetProperty</font></b><font color="#990000">(</font>
                                    <font color="#008080">AudioFilePropertyID</font>		inPropertyID<font color="#990000">,</font>
                                    <font color="#008080">UInt32</font>					inDataSize<font color="#990000">,</font>
                                    <b><font color="#0000FF">const</font></b> <font color="#009900">void</font>				<font color="#990000">*</font>inPropertyData<font color="#990000">)</font>
<font color="#FF0000">{</font>
    <font color="#008080">OSStatus</font>		err <font color="#990000">=</font> noErr<font color="#990000">;</font>

    <b><font color="#0000FF">switch</font></b> <font color="#990000">(</font>inPropertyID<font color="#990000">)</font>
    <font color="#FF0000">{</font>
        <b><font color="#0000FF">case</font></b> kAudioFilePropertyDataFormat<font color="#990000">:</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(</font>inDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>AudioStreamBasicDescription<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"Incorrect data size"</font><font color="#990000">);</font>
            err <font color="#990000">=</font> <b><font color="#000000">UpdateDataFormat</font></b><font color="#990000">((</font>AudioStreamBasicDescription <font color="#990000">*)</font> inPropertyData<font color="#990000">);</font>
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		<b><font color="#0000FF">case</font></b> kAudioFilePropertyFormatList<font color="#990000">:</font>
			err <font color="#990000">=</font> <b><font color="#000000">SetFormatList</font></b><font color="#990000">(</font>inDataSize<font color="#990000">,</font> <font color="#990000">(</font>AudioFormatListItem<font color="#990000">*)</font>inPropertyData<font color="#990000">);</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		
        <b><font color="#0000FF">case</font></b> kAudioFilePropertyAudioDataByteCount<font color="#990000">:</font> <font color="#FF0000">{</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(</font>inDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>SInt64<font color="#990000">),</font> err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"Incorrect data size"</font><font color="#990000">);</font>
            <font color="#008080">SInt64</font> numBytes <font color="#990000">=</font> <font color="#990000">*(</font>SInt64 <font color="#990000">*)</font> inPropertyData<font color="#990000">;</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>numBytes <font color="#990000">&gt;</font> <b><font color="#000000">GetNumBytes</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
				<i><font color="#9A1900">// can't use this to increase data size.</font></i>
				<b><font color="#0000FF">return</font></b> kAudioFileOperationNotSupportedError<font color="#990000">;</font>
			<font color="#FF0000">}</font>
			<font color="#008080">UInt32</font> saveDefer <font color="#990000">=</font> <b><font color="#000000">DeferSizeUpdates</font></b><font color="#990000">();</font>
			<b><font color="#000000">SetDeferSizeUpdates</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">);</font> <i><font color="#9A1900">// force an update.</font></i>
			err <font color="#990000">=</font> <b><font color="#000000">UpdateNumBytes</font></b><font color="#990000">(</font>numBytes<font color="#990000">);</font>
			<b><font color="#000000">SetDeferSizeUpdates</font></b><font color="#990000">(</font>saveDefer<font color="#990000">);</font>
		<font color="#FF0000">}</font> <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

		<b><font color="#0000FF">case</font></b> kAudioFilePropertyAudioDataPacketCount<font color="#990000">:</font> <font color="#FF0000">{</font>
			<font color="#008080">SInt64</font> numPackets <font color="#990000">=</font> <font color="#990000">*(</font>SInt64 <font color="#990000">*)</font> inPropertyData<font color="#990000">;</font>
			<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>numPackets <font color="#990000">&gt;</font> <b><font color="#000000">GetNumPackets</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
				<i><font color="#9A1900">// can't use this to increase data size.</font></i>
				<b><font color="#0000FF">return</font></b> kAudioFileOperationNotSupportedError<font color="#990000">;</font>
			<font color="#FF0000">}</font>
			err <font color="#990000">=</font> <b><font color="#000000">UpdateNumPackets</font></b><font color="#990000">(</font>numPackets<font color="#990000">);</font>
		<font color="#FF0000">}</font> <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		
		<b><font color="#0000FF">case</font></b> kAudioFilePropertyMagicCookieData<font color="#990000">:</font>            
			err <font color="#990000">=</font> <b><font color="#000000">SetMagicCookieData</font></b><font color="#990000">(</font>inDataSize<font color="#990000">,</font> inPropertyData<font color="#990000">);</font>
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>


		<b><font color="#0000FF">case</font></b> kAudioFilePropertyMarkerList <font color="#990000">:</font>
            err <font color="#990000">=</font> <b><font color="#000000">SetMarkerList</font></b><font color="#990000">(</font>inDataSize<font color="#990000">,</font> <b><font color="#0000FF">static_cast</font></b><font color="#990000">&lt;</font><b><font color="#0000FF">const</font></b> AudioFileMarkerList<font color="#990000">*&gt;(</font>inPropertyData<font color="#990000">));</font>			
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
			
		<b><font color="#0000FF">case</font></b> kAudioFilePropertyRegionList <font color="#990000">:</font>
            err <font color="#990000">=</font> <b><font color="#000000">SetRegionList</font></b><font color="#990000">(</font>inDataSize<font color="#990000">,</font> <b><font color="#0000FF">static_cast</font></b><font color="#990000">&lt;</font><b><font color="#0000FF">const</font></b> AudioFileRegionList<font color="#990000">*&gt;(</font>inPropertyData<font color="#990000">));</font>			
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
			
		<b><font color="#0000FF">case</font></b> kAudioFilePropertyChannelLayout <font color="#990000">:</font>
            err <font color="#990000">=</font> <b><font color="#000000">SetChannelLayout</font></b><font color="#990000">(</font>inDataSize<font color="#990000">,</font> <b><font color="#0000FF">static_cast</font></b><font color="#990000">&lt;</font><b><font color="#0000FF">const</font></b> AudioChannelLayout<font color="#990000">*&gt;(</font>inPropertyData<font color="#990000">));</font>			
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>

		<b><font color="#0000FF">case</font></b> kAudioFilePropertyDeferSizeUpdates <font color="#990000">:</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(</font>inDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>UInt32<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>
            <b><font color="#000000">SetDeferSizeUpdates</font></b><font color="#990000">(*(</font>UInt32 <font color="#990000">*)</font> inPropertyData<font color="#990000">);</font>
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>

        <b><font color="#0000FF">case</font></b> kAudioFilePropertyInfoDictionary <font color="#990000">:</font>
		<font color="#FF0000">{</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(</font>inDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>CFDictionaryRef<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>

			<i><font color="#9A1900">// pass the SetInfoDictionary a CACFDictionary object made with the provided CFDictionaryRef</font></i>
			<i><font color="#9A1900">// Let the caller release their own CFObject so pass false for th erelease parameter</font></i>
			<font color="#008080">CACFDictionary</font>		<b><font color="#000000">afInfoDictionary</font></b><font color="#990000">(*(</font>CFDictionaryRef <font color="#990000">*)</font>inPropertyData<font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">);</font>
            err <font color="#990000">=</font> <b><font color="#000000">SetInfoDictionary</font></b><font color="#990000">(&amp;</font>afInfoDictionary<font color="#990000">);</font>			
            
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		<font color="#FF0000">}</font>
			
        <b><font color="#0000FF">case</font></b> kTEMPAudioFilePropertySoundCheckDictionary <font color="#990000">:</font>
		<font color="#FF0000">{</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(</font>inDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>CFDictionaryRef<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>

			<i><font color="#9A1900">// pass the SetInfoDictionary a CACFDictionary object made with the provided CFDictionaryRef</font></i>
			<i><font color="#9A1900">// Let the caller release their own CFObject so pass false for th erelease parameter</font></i>
			<font color="#008080">CACFDictionary</font>		<b><font color="#000000">afInfoDictionary</font></b><font color="#990000">(*(</font>CFDictionaryRef <font color="#990000">*)</font>inPropertyData<font color="#990000">,</font> <b><font color="#0000FF">false</font></b><font color="#990000">);</font>
            err <font color="#990000">=</font> <b><font color="#000000">SetSoundCheckDictionary</font></b><font color="#990000">(&amp;</font>afInfoDictionary<font color="#990000">);</font>			
            
            <b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		<font color="#FF0000">}</font>
			
  		<b><font color="#0000FF">case</font></b> <font color="#FF0000">'sbtd'</font> <i><font color="#9A1900">/*kAudioFilePropertySourceBitDepth*/</font></i> <font color="#990000">:</font>
		<font color="#FF0000">{</font>
            <b><font color="#000000">FailWithAction</font></b><font color="#990000">(</font>inDataSize <font color="#990000">!=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>SInt32<font color="#990000">),</font> 
				err <font color="#990000">=</font> kAudioFileBadPropertySizeError<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"inDataSize is wrong"</font><font color="#990000">);</font>

			<font color="#008080">SInt32</font> inValue <font color="#990000">=</font> <font color="#990000">*(</font>SInt32 <font color="#990000">*)</font>inPropertyData<font color="#990000">;</font>
			err <font color="#990000">=</font> <b><font color="#000000">SetSourceBitDepth</font></b><font color="#990000">(</font>inValue<font color="#990000">);</font>
			
			<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
		<font color="#FF0000">}</font>	
<b><font color="#008080">      default:</font></b>
            err <font color="#990000">=</font> kAudioFileUnsupportedPropertyError<font color="#990000">;</font>			
		<b><font color="#0000FF">break</font></b><font color="#990000">;</font>
    <font color="#FF0000">}</font>

<b><font color="#008080">Bail:</font></b>
    <b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>


<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">SetDataFormat</font></b><font color="#990000">(</font><b><font color="#0000FF">const</font></b> AudioStreamBasicDescription<font color="#990000">*</font> inStreamFormat<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<font color="#008080">OSStatus</font> err <font color="#990000">=</font> noErr<font color="#990000">;</font>
	
	<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font><b><font color="#000000">IsDataFormatValid</font></b><font color="#990000">(</font>inStreamFormat<font color="#990000">))</font>
		<b><font color="#0000FF">return</font></b> kAudioFileUnsupportedDataFormatError<font color="#990000">;</font>

	<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font><b><font color="#000000">IsDataFormatSupported</font></b><font color="#990000">(</font>inStreamFormat<font color="#990000">))</font> 
		<b><font color="#0000FF">return</font></b> kAudioFileUnsupportedDataFormatError<font color="#990000">;</font>
	
	<font color="#008080">UInt32</font> prevBytesPerPacket <font color="#990000">=</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">;</font>
	
	mDataFormat <font color="#990000">=</font> <font color="#990000">*</font>inStreamFormat<font color="#990000">;</font>
	
	<i><font color="#9A1900">// if CBR and bytes per packet changes, we need to change the number of packets we think we have.</font></i>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mDataFormat<font color="#990000">.</font>mBytesPerPacket <font color="#990000">&amp;&amp;</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket <font color="#990000">!=</font> prevBytesPerPacket<font color="#990000">)</font>
	<font color="#FF0000">{</font>
		<font color="#008080">SInt64</font> numPackets <font color="#990000">=</font> <b><font color="#000000">GetNumBytes</font></b><font color="#990000">()</font> <font color="#990000">/</font> mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">;</font>
		<b><font color="#000000">SetNumPackets</font></b><font color="#990000">(</font>numPackets<font color="#990000">);</font>
		<b><font color="#000000">SetMaximumPacketSize</font></b><font color="#990000">(</font>mDataFormat<font color="#990000">.</font>mBytesPerPacket<font color="#990000">);</font>

		<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font>mFirstSetFormat<font color="#990000">)</font>
			<b><font color="#000000">SizeChanged</font></b><font color="#990000">();</font>
	<font color="#FF0000">}</font>
	
	mFirstSetFormat <font color="#990000">=</font> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
	
	<b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">GetFormatListInfo</font></b><font color="#990000">(</font>	<font color="#008080">UInt32</font>				<font color="#990000">&amp;</font>outDataSize<font color="#990000">,</font>
													<font color="#008080">UInt32</font>				<font color="#990000">&amp;</font>outWritable<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<i><font color="#9A1900">// default implementation is to just return the data format</font></i>
	outDataSize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>AudioFormatListItem<font color="#990000">);</font>
	outWritable <font color="#990000">=</font> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
	<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">GetFormatList</font></b><font color="#990000">(</font>	<font color="#008080">UInt32</font>									<font color="#990000">&amp;</font>ioDataSize<font color="#990000">,</font>
												<font color="#008080">AudioFormatListItem</font>						<font color="#990000">*</font>ioPropertyData<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<i><font color="#9A1900">// default implementation is to just return the data format</font></i>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>ioDataSize <font color="#990000">&lt;</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>AudioFormatListItem<font color="#990000">))</font>
		<b><font color="#0000FF">return</font></b> kAudioFileBadPropertySizeError<font color="#990000">;</font>
	
	<font color="#008080">AudioFormatListItem</font> afli<font color="#990000">;</font>
	afli<font color="#990000">.</font>mASBD <font color="#990000">=</font> mDataFormat<font color="#990000">;</font>
	<font color="#008080">AudioChannelLayoutTag</font> layoutTag <font color="#990000">=</font> <i><font color="#9A1900">/*kAudioChannelLayoutTag_Unknown*/</font></i> <font color="#993399">0xFFFF0000</font> <font color="#990000">|</font> mDataFormat<font color="#990000">.</font>mChannelsPerFrame<font color="#990000">;</font>
	<font color="#008080">UInt32</font> layoutSize<font color="#990000">,</font> isWritable<font color="#990000">;</font>
	<font color="#008080">OSStatus</font> err <font color="#990000">=</font> <b><font color="#000000">GetChannelLayoutSize</font></b><font color="#990000">(&amp;</font>layoutSize<font color="#990000">,</font> <font color="#990000">&amp;</font>isWritable<font color="#990000">);</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>err <font color="#990000">==</font> noErr<font color="#990000">)</font>
	<font color="#FF0000">{</font>
		<font color="#008080">CAAutoFree&lt;AudioChannelLayout&gt;</font> layout<font color="#990000">;</font>
		layout<font color="#990000">.</font><b><font color="#000000">allocBytes</font></b><font color="#990000">(</font>layoutSize<font color="#990000">);</font>
		err <font color="#990000">=</font> <b><font color="#000000">GetChannelLayout</font></b><font color="#990000">(&amp;</font>layoutSize<font color="#990000">,</font> <b><font color="#000000">layout</font></b><font color="#990000">());</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>err <font color="#990000">==</font> noErr<font color="#990000">)</font> <font color="#FF0000">{</font>
			layoutTag <font color="#990000">=</font> layout<font color="#990000">-&gt;</font>mChannelLayoutTag<font color="#990000">;</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font>
	afli<font color="#990000">.</font>mChannelLayoutTag <font color="#990000">=</font> layoutTag<font color="#990000">;</font>	
	
	<b><font color="#000000">memcpy</font></b><font color="#990000">(</font>ioPropertyData<font color="#990000">,</font> <font color="#990000">&amp;</font>afli<font color="#990000">,</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>AudioFormatListItem<font color="#990000">));</font>
	
	ioDataSize <font color="#990000">=</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>AudioFormatListItem<font color="#990000">);</font>
	<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>
<font color="#FF0000">}</font>
										
<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">SetFormatList</font></b><font color="#990000">(</font>	<font color="#008080">UInt32</font>									inDataSize<font color="#990000">,</font>
											<b><font color="#0000FF">const</font></b> <font color="#008080">AudioFormatListItem</font>				<font color="#990000">*</font>inPropertyData<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">return</font></b> kAudioFileOperationNotSupportedError<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">UpdateDataFormat</font></b><font color="#990000">(</font><b><font color="#0000FF">const</font></b> AudioStreamBasicDescription<font color="#990000">*</font> inStreamFormat<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">return</font></b> <b><font color="#000000">SetDataFormat</font></b><font color="#990000">(</font>inStreamFormat<font color="#990000">);</font>
<font color="#FF0000">}</font>


<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#008080">Boolean</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">IsDataFormatValid</font></b><font color="#990000">(</font><font color="#008080">AudioStreamBasicDescription</font> <b><font color="#0000FF">const</font></b><font color="#990000">*</font> inDesc<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inDesc<font color="#990000">-&gt;</font>mSampleRate <font color="#990000">&lt;</font> <font color="#993399">0</font><font color="#990000">.)</font>
		<b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>

	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inDesc<font color="#990000">-&gt;</font>mSampleRate <font color="#990000">&gt;</font> <font color="#993399">3e6</font><font color="#990000">)</font>
		<b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>

	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inDesc<font color="#990000">-&gt;</font>mChannelsPerFrame <font color="#990000">&lt;</font> <font color="#993399">1</font> <font color="#990000">||</font> inDesc<font color="#990000">-&gt;</font>mChannelsPerFrame <font color="#990000">&gt;</font> <font color="#993399">0x000FFFFF</font><font color="#990000">)</font>
		<b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>

	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inDesc<font color="#990000">-&gt;</font>mFormatID <font color="#990000">==</font> kAudioFormatLinearPCM<font color="#990000">)</font>
	<font color="#FF0000">{</font>			
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inDesc<font color="#990000">-&gt;</font>mBitsPerChannel <font color="#990000">&lt;</font> <font color="#993399">1</font> <font color="#990000">||</font> inDesc<font color="#990000">-&gt;</font>mBitsPerChannel <font color="#990000">&gt;</font> <font color="#993399">64</font><font color="#990000">)</font>
			<b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
			
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inDesc<font color="#990000">-&gt;</font>mFramesPerPacket <font color="#990000">!=</font> <font color="#993399">1</font><font color="#990000">)</font>
			<b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
			
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inDesc<font color="#990000">-&gt;</font>mBytesPerPacket <font color="#990000">==</font> <font color="#993399">0</font><font color="#990000">)</font> 
			<b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>

		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inDesc<font color="#990000">-&gt;</font>mBytesPerFrame <font color="#990000">!=</font> inDesc<font color="#990000">-&gt;</font>mBytesPerPacket<font color="#990000">)</font>
			<b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
			
		<i><font color="#9A1900">// [3605260] we assume here that a packet is an integer number of frames.</font></i>
		<font color="#008080">UInt32</font> minimumBytesPerPacket <font color="#990000">=</font> <font color="#990000">(</font>inDesc<font color="#990000">-&gt;</font>mBitsPerChannel <font color="#990000">*</font> inDesc<font color="#990000">-&gt;</font>mChannelsPerFrame <font color="#990000">+</font> <font color="#993399">7</font><font color="#990000">)</font> <font color="#990000">/</font> <font color="#993399">8</font><font color="#990000">;</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inDesc<font color="#990000">-&gt;</font>mBytesPerPacket <font color="#990000">&lt;</font> minimumBytesPerPacket<font color="#990000">)</font> 
			<b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
	<font color="#FF0000">}</font>
	<b><font color="#0000FF">return</font></b> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#009900">void</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">SetDataSource</font></b><font color="#990000">(</font>DataSource<font color="#990000">*</font> inDataSource<font color="#990000">)</font>	
<font color="#FF0000">{</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mDataSource <font color="#990000">!=</font> inDataSource<font color="#990000">)</font> <font color="#FF0000">{</font>
		<b><font color="#0000FF">delete</font></b> mDataSource<font color="#990000">;</font>
		mDataSource <font color="#990000">=</font> inDataSource<font color="#990000">;</font>
	<font color="#FF0000">}</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</font></i>

<font color="#009900">void</font>	AudioFileObject<font color="#990000">::</font><b><font color="#000000">SetURL</font></b> <font color="#990000">(</font><font color="#008080">CFURLRef</font> inURL<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mFileRef <font color="#990000">==</font> inURL<font color="#990000">)</font> <b><font color="#0000FF">return</font></b><font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>inURL<font color="#990000">)</font> <b><font color="#000000">CFRetain</font></b> <font color="#990000">(</font>inURL<font color="#990000">);</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mFileRef<font color="#990000">)</font> <b><font color="#000000">CFRelease</font></b><font color="#990000">(</font>mFileRef<font color="#990000">);</font>
	mFileRef <font color="#990000">=</font> inURL<font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">OpenFile</font></b><font color="#990000">(</font><font color="#008080">SInt8</font> inPermissions<font color="#990000">,</font> <font color="#009900">int</font> inFD<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<font color="#008080">OSStatus</font> err <font color="#990000">=</font> noErr<font color="#990000">;</font>

	<b><font color="#000000">SetDataSource</font></b><font color="#990000">(</font><b><font color="#0000FF">new</font></b> <b><font color="#000000">Cached_DataSource</font></b><font color="#990000">(</font><b><font color="#0000FF">new</font></b> <b><font color="#000000">UnixFile_DataSource</font></b><font color="#990000">(</font>inFD<font color="#990000">,</font> inPermissions<font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">)));</font>
	
	mFileD <font color="#990000">=</font> inFD<font color="#990000">;</font>
	<b><font color="#000000">SetPermissions</font></b> <font color="#990000">(</font>inPermissions<font color="#990000">);</font>

	<b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>
								
<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">CreateDataFile</font></b> <font color="#990000">(</font><font color="#008080">CFURLRef</font>	inFileRef<font color="#990000">,</font> <font color="#009900">int</font>	<font color="#990000">&amp;</font>outFileD<font color="#990000">)</font>
<font color="#FF0000">{</font>	 
	<font color="#008080">UInt8</font> fPath<font color="#990000">[</font>FILENAME_MAX<font color="#990000">];</font>	
	<b><font color="#0000FF">if</font></b> <font color="#990000">(!</font><b><font color="#000000">CFURLGetFileSystemRepresentation</font></b> <font color="#990000">(</font>inFileRef<font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> fPath<font color="#990000">,</font> FILENAME_MAX<font color="#990000">))</font>
		<b><font color="#0000FF">return</font></b> kAudio_FileNotFoundError<font color="#990000">;</font>
	
	<b><font color="#0000FF">struct</font></b> <font color="#008080">stat</font> stbuf<font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#000000">stat</font></b> <font color="#990000">((</font><b><font color="#0000FF">const</font></b> <font color="#009900">char</font><font color="#990000">*)</font>fPath<font color="#990000">,</font> <font color="#990000">&amp;</font>stbuf<font color="#990000">)</font> <font color="#990000">==</font> <font color="#993399">0</font><font color="#990000">)</font> 
		<b><font color="#0000FF">return</font></b> kAudioFilePermissionsError<font color="#990000">;</font>

<b><font color="#000080">#if</font></b> TARGET_OS_WIN32
	<font color="#009900">int</font> filePerms <font color="#990000">=</font> S_IREAD <font color="#990000">|</font> S_IWRITE<font color="#990000">;</font>
	<font color="#009900">int</font> flags <font color="#990000">=</font> O_CREAT <font color="#990000">|</font> O_EXCL <font color="#990000">|</font> O_RDWR <font color="#990000">|</font> O_BINARY<font color="#990000">;</font>
<b><font color="#000080">#else</font></b>
	<font color="#008080">mode_t</font> filePerms <font color="#990000">=</font> S_IRUSR <font color="#990000">|</font> S_IWUSR <font color="#990000">|</font> S_IRGRP <font color="#990000">|</font> S_IROTH<font color="#990000">;</font>
	<font color="#009900">int</font> flags <font color="#990000">=</font> O_CREAT <font color="#990000">|</font> O_EXCL <font color="#990000">|</font> O_RDWR<font color="#990000">;</font>
<b><font color="#000080">#endif</font></b>
	outFileD <font color="#990000">=</font> <b><font color="#000000">open</font></b><font color="#990000">((</font><b><font color="#0000FF">const</font></b> <font color="#009900">char</font><font color="#990000">*)</font>fPath<font color="#990000">,</font> flags<font color="#990000">,</font> filePerms<font color="#990000">);</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>outFileD <font color="#990000">&lt;</font> <font color="#993399">0</font><font color="#990000">)</font>
		<b><font color="#0000FF">return</font></b> kAudioFilePermissionsError<font color="#990000">;</font>

	<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">AddDurationToInfoDictionary</font></b><font color="#990000">(</font><font color="#008080">CACFDictionary</font> <font color="#990000">*</font>infoDict<font color="#990000">,</font> <font color="#008080">Float64</font> <font color="#990000">&amp;</font>inDuration<font color="#990000">)</font>
<font color="#FF0000">{</font>
<b><font color="#000080">#if</font></b> <font color="#990000">!</font>TARGET_OS_WIN32
	<font color="#008080">CFLocaleRef</font> currentLocale <font color="#990000">=</font> <b><font color="#000000">CFLocaleGetSystem</font></b><font color="#990000">();</font>
	<font color="#008080">CFNumberFormatterRef</font> numberFormatter <font color="#990000">=</font> NULL<font color="#990000">;</font>
	numberFormatter <font color="#990000">=</font> <b><font color="#000000">CFNumberFormatterCreate</font></b><font color="#990000">(</font>kCFAllocatorDefault<font color="#990000">,</font> currentLocale<font color="#990000">,</font> kCFNumberFormatterDecimalStyle<font color="#990000">);</font>
	<font color="#008080">CFStringRef</font> cfStr <font color="#990000">=</font> <b><font color="#000000">CFNumberFormatterCreateStringWithValue</font></b><font color="#990000">(</font> kCFAllocatorDefault<font color="#990000">,</font> numberFormatter<font color="#990000">,</font> kCFNumberFloat64Type<font color="#990000">,</font> <font color="#990000">&amp;</font>inDuration<font color="#990000">);</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>cfStr<font color="#990000">)</font>
	<font color="#FF0000">{</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#000000">CFStringGetLength</font></b><font color="#990000">(</font>cfStr<font color="#990000">)</font> <font color="#990000">!=</font> <font color="#993399">0</font><font color="#990000">)</font>
			infoDict<font color="#990000">-&gt;</font><b><font color="#000000">AddString</font></b><font color="#990000">(</font><b><font color="#000000">CFSTR</font></b><font color="#990000">(</font>kAFInfoDictionary_ApproximateDurationInSeconds<font color="#990000">),</font> cfStr<font color="#990000">);</font>
		<b><font color="#000000">CFRelease</font></b><font color="#990000">(</font>cfStr<font color="#990000">);</font>
	<font color="#FF0000">}</font>
	<b><font color="#000000">CFRelease</font></b><font color="#990000">(</font>numberFormatter<font color="#990000">);</font>
<b><font color="#000080">#endif</font></b>
	<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">SizeChanged</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>
	<font color="#008080">OSStatus</font> err <font color="#990000">=</font> noErr<font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>mPermissions <font color="#990000">&amp;</font> kAudioFileWritePermission<font color="#990000">)</font> 
	<font color="#FF0000">{</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#000000">DeferSizeUpdates</font></b><font color="#990000">())</font>
			<b><font color="#000000">SetNeedsSizeUpdate</font></b><font color="#990000">(</font><b><font color="#0000FF">true</font></b><font color="#990000">);</font>
		<b><font color="#0000FF">else</font></b>
			err <font color="#990000">=</font> <b><font color="#000000">UpdateSize</font></b><font color="#990000">();</font>
	<font color="#FF0000">}</font>
	<b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">UpdateSizeIfNeeded</font></b><font color="#990000">()</font>
<font color="#FF0000">{</font>		
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font><b><font color="#000000">GetNeedsSizeUpdate</font></b><font color="#990000">())</font> 
	<font color="#FF0000">{</font>
		<font color="#008080">OSStatus</font> err <font color="#990000">=</font> <b><font color="#000000">UpdateSize</font></b><font color="#990000">();</font>
		<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>err<font color="#990000">)</font> <b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
		<b><font color="#000000">SetNeedsSizeUpdate</font></b><font color="#990000">(</font><b><font color="#0000FF">false</font></b><font color="#990000">);</font>
	<font color="#FF0000">}</font>
	<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">CountUserData</font></b><font color="#990000">(</font>	UInt32					<i><font color="#9A1900">/*inUserDataID*/</font></i><font color="#990000">,</font>
											UInt32<font color="#990000">*</font>					<i><font color="#9A1900">/*outNumberItems*/</font></i><font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">return</font></b> kAudioFileOperationNotSupportedError<font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">GetUserDataSize</font></b><font color="#990000">(</font>  UInt32					<i><font color="#9A1900">/*inUserDataID*/</font></i><font color="#990000">,</font>
											UInt32					<i><font color="#9A1900">/*inIndex*/</font></i><font color="#990000">,</font>
											UInt32<font color="#990000">*</font>					<i><font color="#9A1900">/*outDataSize*/</font></i><font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">return</font></b> kAudioFileOperationNotSupportedError<font color="#990000">;</font>
<font color="#FF0000">}</font>
											
<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">GetUserData</font></b><font color="#990000">(</font>		UInt32					<i><font color="#9A1900">/*inUserDataID*/</font></i><font color="#990000">,</font>
											UInt32					<i><font color="#9A1900">/*inIndex*/</font></i><font color="#990000">,</font>
											UInt32<font color="#990000">*</font>					<i><font color="#9A1900">/*ioDataSize*/</font></i><font color="#990000">,</font>
											<font color="#009900">void</font><font color="#990000">*</font>					<i><font color="#9A1900">/*ioUserData*/</font></i><font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">return</font></b> kAudioFileOperationNotSupportedError<font color="#990000">;</font>
<font color="#FF0000">}</font>
											
<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">SetUserData</font></b><font color="#990000">(</font>		UInt32					<i><font color="#9A1900">/*inUserDataID*/</font></i><font color="#990000">,</font>
											UInt32					<i><font color="#9A1900">/*inIndex*/</font></i><font color="#990000">,</font>
											UInt32					<i><font color="#9A1900">/*inDataSize*/</font></i><font color="#990000">,</font>
											<b><font color="#0000FF">const</font></b> <font color="#009900">void</font><font color="#990000">*</font>				<i><font color="#9A1900">/*inUserData*/</font></i><font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">return</font></b> kAudioFileOperationNotSupportedError<font color="#990000">;</font>
<font color="#FF0000">}</font>
											
<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">RemoveUserData</font></b><font color="#990000">(</font>	UInt32					<i><font color="#9A1900">/*inUserDataID*/</font></i><font color="#990000">,</font>
											UInt32					<i><font color="#9A1900">/*inIndex*/</font></i><font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">return</font></b> kAudioFileOperationNotSupportedError<font color="#990000">;</font>
<font color="#FF0000">}</font>

<font color="#008080">OSStatus</font> AudioFileObject<font color="#990000">::</font><b><font color="#000000">MoveData</font></b><font color="#990000">(</font><font color="#008080">SInt64</font> fromPos<font color="#990000">,</font> <font color="#008080">SInt64</font> toPos<font color="#990000">,</font> <font color="#008080">SInt64</font> size<font color="#990000">)</font>
<font color="#FF0000">{</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fromPos <font color="#990000">==</font> toPos<font color="#990000">)</font> 
		<b><font color="#0000FF">return</font></b> noErr<font color="#990000">;</font>

	<font color="#008080">OSStatus</font> err <font color="#990000">=</font> noErr<font color="#990000">;</font>
	<font color="#008080">CAAutoFree&lt;char&gt;</font> <b><font color="#000000">audioData</font></b><font color="#990000">(</font>kCopySoundDataBufferSize<font color="#990000">,</font> <b><font color="#0000FF">true</font></b><font color="#990000">);</font>

	<font color="#008080">SInt64</font> bytesRemaining <font color="#990000">=</font> size<font color="#990000">;</font>
	<b><font color="#0000FF">if</font></b> <font color="#990000">(</font>fromPos <font color="#990000">&lt;</font> toPos<font color="#990000">)</font> <font color="#FF0000">{</font>
		<b><font color="#0000FF">while</font></b> <font color="#990000">(</font>bytesRemaining <font color="#990000">&gt;</font> <font color="#993399">0</font><font color="#990000">)</font>
		<font color="#FF0000">{</font>
			<i><font color="#9A1900">// read from old file</font></i>
			<font color="#008080">UInt32</font> byteCount<font color="#990000">;</font>
			<font color="#008080">SInt64</font> count <font color="#990000">=</font> <font color="#990000">(</font>bytesRemaining <font color="#990000">&lt;</font> kCopySoundDataBufferSize<font color="#990000">)</font> <font color="#990000">?</font> bytesRemaining <font color="#990000">:</font> kCopySoundDataBufferSize<font color="#990000">;</font> 
			err <font color="#990000">=</font> <b><font color="#000000">GetDataSource</font></b><font color="#990000">()-&gt;</font><b><font color="#000000">ReadBytes</font></b><font color="#990000">(</font>SEEK_SET<font color="#990000">,</font> fromPos<font color="#990000">+(</font>bytesRemaining<font color="#990000">-</font>count<font color="#990000">),</font> <font color="#990000">(</font>UInt32<font color="#990000">)</font>count<font color="#990000">,</font> <b><font color="#000000">audioData</font></b><font color="#990000">(),</font> <font color="#990000">&amp;</font>byteCount<font color="#990000">);</font>
			<b><font color="#000000">FailIf</font></b> <font color="#990000">(</font>err <font color="#990000">!=</font> noErr<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"MoveData ReadBytes failed"</font><font color="#990000">);</font>

			err <font color="#990000">=</font> <b><font color="#000000">GetDataSource</font></b><font color="#990000">()-&gt;</font><b><font color="#000000">WriteBytes</font></b><font color="#990000">(</font>SEEK_SET<font color="#990000">,</font> toPos<font color="#990000">+(</font>bytesRemaining<font color="#990000">-</font>count<font color="#990000">),</font> <font color="#990000">(</font>UInt32<font color="#990000">)</font>count<font color="#990000">,</font> <b><font color="#000000">audioData</font></b><font color="#990000">(),</font> <font color="#990000">&amp;</font>byteCount<font color="#990000">);</font>
			<b><font color="#000000">FailIf</font></b> <font color="#990000">(</font>err <font color="#990000">!=</font> noErr<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"WriteBytes failed"</font><font color="#990000">);</font>
			
			bytesRemaining <font color="#990000">-=</font> count<font color="#990000">;</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
		<b><font color="#0000FF">while</font></b> <font color="#990000">(</font>bytesRemaining <font color="#990000">&gt;</font> <font color="#993399">0</font><font color="#990000">)</font>
		<font color="#FF0000">{</font>
			<i><font color="#9A1900">// read from old file</font></i>
			<font color="#008080">UInt32</font> byteCount<font color="#990000">;</font>
			<font color="#008080">SInt64</font> count <font color="#990000">=</font> <font color="#990000">(</font>bytesRemaining <font color="#990000">&lt;</font> kCopySoundDataBufferSize<font color="#990000">)</font> <font color="#990000">?</font> bytesRemaining <font color="#990000">:</font> kCopySoundDataBufferSize<font color="#990000">;</font> 
			err <font color="#990000">=</font> <b><font color="#000000">GetDataSource</font></b><font color="#990000">()-&gt;</font><b><font color="#000000">ReadBytes</font></b><font color="#990000">(</font>SEEK_SET<font color="#990000">,</font> fromPos<font color="#990000">+(</font>size <font color="#990000">-</font> bytesRemaining<font color="#990000">),</font> <font color="#990000">(</font>UInt32<font color="#990000">)</font>count<font color="#990000">,</font> <b><font color="#000000">audioData</font></b><font color="#990000">(),</font> <font color="#990000">&amp;</font>byteCount<font color="#990000">);</font>
			<b><font color="#000000">FailIf</font></b> <font color="#990000">(</font>err <font color="#990000">!=</font> noErr<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"MoveData ReadBytes failed"</font><font color="#990000">);</font>
			
			err <font color="#990000">=</font> <b><font color="#000000">GetDataSource</font></b><font color="#990000">()-&gt;</font><b><font color="#000000">WriteBytes</font></b><font color="#990000">(</font>SEEK_SET<font color="#990000">,</font> toPos<font color="#990000">+(</font>size <font color="#990000">-</font> bytesRemaining<font color="#990000">),</font> <font color="#990000">(</font>UInt32<font color="#990000">)</font>count<font color="#990000">,</font> <b><font color="#000000">audioData</font></b><font color="#990000">(),</font> <font color="#990000">&amp;</font>byteCount<font color="#990000">);</font>
			<b><font color="#000000">FailIf</font></b> <font color="#990000">(</font>err <font color="#990000">!=</font> noErr<font color="#990000">,</font> Bail<font color="#990000">,</font> <font color="#FF0000">"WriteBytes failed"</font><font color="#990000">);</font>
			
			bytesRemaining <font color="#990000">-=</font> count<font color="#990000">;</font>
		<font color="#FF0000">}</font>
	<font color="#FF0000">}</font>
	
<b><font color="#008080">Bail:</font></b>
	<b><font color="#0000FF">return</font></b> err<font color="#990000">;</font>
<font color="#FF0000">}</font>

</tt></pre>
